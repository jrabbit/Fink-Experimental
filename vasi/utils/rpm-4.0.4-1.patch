diff -Naur rpm-4.0.4/Makefile.in rpm-new/Makefile.in
--- rpm-4.0.4/Makefile.in	2002-02-14 18:58:07.000000000 -0500
+++ rpm-new/Makefile.in	2002-05-05 00:20:45.000000000 -0400
@@ -208,7 +208,7 @@
 	@INCPATH@
 
 
-LIBS = -lrt -lpthread
+LIBS = -lpthread
 
 myLDFLAGS = @LDFLAGS_STATIC@
 
@@ -220,7 +220,7 @@
 	$(top_builddir)/lib/librpm.la \
 	$(top_builddir)/rpmdb/librpmdb.la \
 	$(top_builddir)/rpmio/librpmio.la \
-	$(top_builddir)/popt/libpopt.la \
+	$(top_builddir)/popt/librpmpopt.la \
 	@WITH_ZLIB_LIB@ \
 	@INTLLIBS@ @LIBMISC@
 
@@ -294,31 +294,31 @@
 rpm2cpio_OBJECTS =  rpm2cpio.$(OBJEXT)
 rpm2cpio_DEPENDENCIES =  $(top_builddir)/build/librpmbuild.la \
 $(top_builddir)/lib/librpm.la $(top_builddir)/rpmdb/librpmdb.la \
-$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/libpopt.la
+$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/librpmpopt.la
 rpmb_OBJECTS =  build.$(OBJEXT)
 rpmb_DEPENDENCIES =  rpmb.o $(top_builddir)/build/librpmbuild.la \
 $(top_builddir)/lib/librpm.la $(top_builddir)/rpmdb/librpmdb.la \
-$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/libpopt.la
+$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/librpmpopt.la
 rpmd_OBJECTS = 
 rpmd_DEPENDENCIES =  rpmd.o $(top_builddir)/build/librpmbuild.la \
 $(top_builddir)/lib/librpm.la $(top_builddir)/rpmdb/librpmdb.la \
-$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/libpopt.la
+$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/librpmpopt.la
 rpmi_OBJECTS = 
 rpmi_DEPENDENCIES =  rpmi.o $(top_builddir)/build/librpmbuild.la \
 $(top_builddir)/lib/librpm.la $(top_builddir)/rpmdb/librpmdb.la \
-$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/libpopt.la
+$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/librpmpopt.la
 rpmk_OBJECTS = 
 rpmk_DEPENDENCIES =  rpmk.o $(top_builddir)/build/librpmbuild.la \
 $(top_builddir)/lib/librpm.la $(top_builddir)/rpmdb/librpmdb.la \
-$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/libpopt.la
+$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/librpmpopt.la
 rpmq_OBJECTS = 
 rpmq_DEPENDENCIES =  rpmq.o $(top_builddir)/build/librpmbuild.la \
 $(top_builddir)/lib/librpm.la $(top_builddir)/rpmdb/librpmdb.la \
-$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/libpopt.la
+$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/librpmpopt.la
 rpm_OBJECTS = 
 rpm_DEPENDENCIES =  rpm.o $(top_builddir)/build/librpmbuild.la \
 $(top_builddir)/lib/librpm.la $(top_builddir)/rpmdb/librpmdb.la \
-$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/libpopt.la
+$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/librpmpopt.la
 SCRIPTS =  $(bin_SCRIPTS) $(pkglib_SCRIPTS)
 
 CFLAGS = @CFLAGS@
@@ -878,7 +878,6 @@
 rpmq.o:	rpmqv.c
 	$(COMPILE) -DIAM_RPMQV -o $@ -c rpmqv.c
 
-$(PROGRAMS): 		$(myLDADD) @WITH_APIDOCS_TARGET@
 
 .PHONY:	lclint
 lclint:
diff -Naur rpm-4.0.4/Perl-RPM/Makefile rpm-new/Perl-RPM/Makefile
--- rpm-4.0.4/Perl-RPM/Makefile	2001-07-21 11:16:08.000000000 -0400
+++ rpm-new/Perl-RPM/Makefile	2002-05-05 00:20:45.000000000 -0400
@@ -15,7 +15,7 @@
 #	DISTNAME => q[Perl-RPM]
 #	EXE_FILES => [q[utils/rpmprune]]
 #	INC => q[-I. -I/usr/include/rpm]
-#	LIBS => q[-lrpm -lrpmdb -lrpmio -lpopt]
+#	LIBS => q[-lrpm -lrpmdb -lrpmio -lrpmpopt]
 #	NAME => q[RPM]
 #	OBJECT => q[RPM/Header$(OBJ_EXT) RPM/Constants$(OBJ_EXT) RPM/Database$(OBJ_EXT) RPM/Error$(OBJ_EXT) RPM$(OBJ_EXT)]
 #	PM => { RPM/Header.pm=>q[$(INST_LIBDIR)/RPM/Header.pm], RPM/Constants.pm=>q[$(INST_LIBDIR)/RPM/Constants.pm], RPM/Database.pm=>q[$(INST_LIBDIR)/RPM/Database.pm], RPM.pm=>q[$(INST_LIBDIR)/RPM.pm], RPM/Error.pm=>q[$(INST_LIBDIR)/RPM/Error.pm] }
@@ -294,8 +294,8 @@
 # RPM might depend on some other libraries:
 # See ExtUtils::Liblist for details
 #
-EXTRALIBS = -lrpm -lrpmdb -lrpmio -lpopt
-LDLOADLIBS = -lrpm -lrpmdb -lrpmio -lpopt
+EXTRALIBS = -lrpm -lrpmdb -lrpmio -lrpmpopt
+LDLOADLIBS = -lrpm -lrpmdb -lrpmio -lrpmpopt
 BSLOADLIBS = 
 LD_RUN_PATH = /usr/lib
 
diff -Naur rpm-4.0.4/Perl-RPM/Makefile.PL rpm-new/Perl-RPM/Makefile.PL
--- rpm-4.0.4/Perl-RPM/Makefile.PL	2002-01-27 11:13:07.000000000 -0500
+++ rpm-new/Perl-RPM/Makefile.PL	2002-05-05 00:20:46.000000000 -0400
@@ -69,17 +69,17 @@
 # XXX rpm-4.0.3 has an internal copy of db-3.3.11/db-4.0.14 in -lrpmdb
 if ($rpm_version ge "0x040003")
 {
-    $rpm_libs = '-lrpm -lrpmdb -lrpmio -lpopt';
+    $rpm_libs = '-lrpm -lrpmdb -lrpmio -lrpmpopt';
 }
 else
 {
   if ($rpm_version ge "0x040000")
   {
-    $rpm_libs = '-lrpm -lrpmio -lpopt';
+    $rpm_libs = '-lrpm -lrpmio -lrpmpopt';
   }
   else
   {
-    $rpm_libs = '-lrpm -lpopt';
+    $rpm_libs = '-lrpm -lrpmpopt';
   }
 }
 
diff -Naur rpm-4.0.4/beecrypt/configure rpm-new/beecrypt/configure
--- rpm-4.0.4/beecrypt/configure	2002-02-13 18:03:22.000000000 -0500
+++ rpm-new/beecrypt/configure	2002-05-05 00:20:46.000000000 -0400
@@ -3710,7 +3710,7 @@
     ;;
 
   darwin* | rhapsody*)
-    allow_undefined_flag='-undefined suppress'
+    allow_undefined_flag='-flat_namespace -undefined suppress'
     # FIXME: Relying on posixy $() will cause problems for
     #        cross-compilation, but unfortunately the echo tests do not
     #        yet detect zsh echo's removal of \ escapes.
diff -Naur rpm-4.0.4/configure rpm-new/configure
--- rpm-4.0.4/configure	2002-02-13 18:03:27.000000000 -0500
+++ rpm-new/configure	2002-05-05 00:20:47.000000000 -0400
@@ -4375,11 +4375,11 @@
     ;;
 
   darwin* | rhapsody*)
-    allow_undefined_flag='-undefined suppress'
+    allow_undefined_flag='-flat_namespace -undefined suppress'
     # FIXME: Relying on posixy $() will cause problems for
     #        cross-compilation, but unfortunately the echo tests do not
     #        yet detect zsh echo's removal of \ escapes.
-    archive_cmds='$CC $(test .$module = .yes && echo -bundle || echo -dynamiclib) $allow_undefined_flag -o $lib $libobjs $deplibs$linkopts -install_name $rpath/$soname $(test -n "$verstring" -a x$verstring != x0.0 && echo $verstring)'
+    archive_cmds='$CC $(test .$module = .yes && echo -bundle || echo -dynamiclib) $allow_undefined_flag -o $lib $libobjs $deplibs$linkopts -install_name $rpath/$soname $verstring'
     # We need to add '_' to the symbols in $export_symbols first
     #archive_expsym_cmds="$archive_cmds"' && strip -s $export_symbols'
     hardcode_direct=yes
diff -Naur rpm-4.0.4/db/dist/configure rpm-new/db/dist/configure
--- rpm-4.0.4/db/dist/configure	2002-01-07 18:28:19.000000000 -0500
+++ rpm-new/db/dist/configure	2002-05-05 00:20:53.000000000 -0400
@@ -11781,7 +11781,6 @@
 echo "${ECHO_T}$ac_cv_search_sched_yield" >&6
 if test "$ac_cv_search_sched_yield" != no; then
   test "$ac_cv_search_sched_yield" = "none required" || LIBS="$ac_cv_search_sched_yield $LIBS"
-  LOAD_LIBS="$LOAD_LIBS -lrt"
 fi
 
 fi
diff -Naur rpm-4.0.4/db3/configure rpm-new/db3/configure
--- rpm-4.0.4/db3/configure	2001-07-27 12:20:43.000000000 -0400
+++ rpm-new/db3/configure	2002-05-05 01:04:18.000000000 -0400
@@ -18,22 +18,27 @@
 cat Makefile.orig | sed -e 's/ -g$/ -g -O2/' -e '/^install:/c\
 .PHONY: listobjs\
 listobjs:\
-	@echo $(OBJS) $(C_OBJS) \
+@TAB@@echo $(OBJS) $(C_OBJS) \
 \
 distdir install check:\
 \
-db3_install: all install_setip \\' > Makefile
+db3_install: all install_setip \\' > Makefile.orig2
+cat Makefile.orig2 | sed -e 's%@TAB@%	%' > Makefile
 
 mv db.h db.h.orig
 cat db.h.orig | sed \
 	-e '/^typedef	u_int32_t	db_pgno_t;/i\
-/*@-incondefs -fielduse -enummemuse -typeuse @*/' \
+/*@-incondefs -fielduse -enummemuse -typeuse @*/\
+' \
 	-e '/^struct __key_range;/a\
-/*@=incondefs@*/' \
+/*@=incondefs@*/\
+' \
 	-e '/^#define	db_create/i\
-/*@-declundef -noparams -fcnuse@*/' \
+/*@-declundef -noparams -fcnuse@*/\
+' \
 	-e '/^#define db_xa_switch/a\
-/*@=declundef =noparams =fcnuse =fielduse =enummemuse =typeuse @*/' > db.h
+/*@=declundef =noparams =fcnuse =fielduse =enummemuse =typeuse @*/\
+' > db.h
 
 # Generate manifest for rpmdb.
 make -s listobjs > db3lobjs
diff -Naur rpm-4.0.4/lib/Makefile.in rpm-new/lib/Makefile.in
--- rpm-4.0.4/lib/Makefile.in	2002-02-14 18:58:39.000000000 -0500
+++ rpm-new/lib/Makefile.in	2002-05-05 00:20:47.000000000 -0400
@@ -218,7 +218,7 @@
 	-L$(top_builddir)/popt/.libs
 
 
-mylibs = -lrpm -lrpmdb -lrpmio -lpopt @LIBS@ @INTLLIBS@ @LIBMISC@
+mylibs = -lrpm -lrpmdb -lrpmio -lrpmpopt @LIBS@ @INTLLIBS@ @LIBMISC@
 LIBS = 
 
 lib_LTLIBRARIES = librpm.la
@@ -492,7 +492,7 @@
 # XXX Add internal libtool dependence
 install-data-local:
 	@cd $(DESTDIR)/$(libdir) && \
-	sed -e "s|^dependency_libs='|& -lrpmdb -lrpmio -lpopt|" < librpm.la > .librpm.la && \
+	sed -e "s|^dependency_libs='|& -lrpmdb -lrpmio -lrpmpopt|" < librpm.la > .librpm.la && \
 	mv .librpm.la librpm.la
 
 tagtable.c: rpmlib.h 
diff -Naur rpm-4.0.4/ltmain.sh rpm-new/ltmain.sh
--- rpm-4.0.4/ltmain.sh	2002-02-13 18:03:22.000000000 -0500
+++ rpm-new/ltmain.sh	2002-05-05 00:20:48.000000000 -0400
@@ -2311,7 +2311,16 @@
 	# Clear the version info if we defaulted, and they specified a release.
 	if test -z "$vinfo" && test -n "$release"; then
 	  major=
-	  verstring="0.0"
+	  case "$version_type" in
+	  darwin)
+	    # we can't check for "0.0" in archive_cmds due to quoting
+	    # problems, so we reset it completely
+	    verstring=""
+	    ;;
+	  *)
+	    verstring="0.0"
+	    ;;
+	  esac
 	  if test "$need_version" = no; then
 	    versuffix=
 	  else
diff -Naur rpm-4.0.4/popt/Makefile.in rpm-new/popt/Makefile.in
--- rpm-4.0.4/popt/Makefile.in	2002-02-14 18:58:34.000000000 -0500
+++ rpm-new/popt/Makefile.in	2002-05-05 00:20:48.000000000 -0400
@@ -135,10 +135,10 @@
 TESTS = testit.sh
 
 include_HEADERS = popt.h
-lib_LTLIBRARIES = libpopt.la
+lib_LTLIBRARIES = librpmpopt.la
 libpopt_la_SOURCES = popt.c findme.c poptparse.c poptconfig.c popthelp.c
 
-man_MANS = popt.3
+man_MANS = 
 
 CVSTAG = $(PACKAGE)-$(subst .,_,$(VERSION))
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
@@ -160,9 +160,9 @@
 PROGRAMS =  $(noinst_PROGRAMS)
 
 test1_OBJECTS =  test1.$(OBJEXT)
-test1_DEPENDENCIES =  libpopt.la
+test1_DEPENDENCIES =  librpmpopt.la
 test2_OBJECTS =  test2.$(OBJEXT)
-test2_DEPENDENCIES =  libpopt.la
+test2_DEPENDENCIES =  librpmpopt.la
 SCRIPTS =  $(noinst_SCRIPTS)
 
 CFLAGS = @CFLAGS@
@@ -306,7 +306,7 @@
 
 maintainer-clean-libtool:
 
-libpopt.la: $(libpopt_la_OBJECTS) $(libpopt_la_DEPENDENCIES)
+librpmpopt.la: $(libpopt_la_OBJECTS) $(libpopt_la_DEPENDENCIES)
 	$(LINK) -rpath $(libdir) $(libpopt_la_LDFLAGS) $(libpopt_la_OBJECTS) $(libpopt_la_LIBADD) $(LIBS)
 
 mostlyclean-noinstPROGRAMS:
@@ -370,8 +370,10 @@
 	$(mkinstalldirs) $(DESTDIR)$(includedir)
 	@list='$(include_HEADERS)'; for p in $$list; do \
 	  if test -f "$$p"; then d= ; else d="$(srcdir)/"; fi; \
+	  if test "$$p" != "popt.h"; then \
 	  echo " $(INSTALL_DATA) $$d$$p $(DESTDIR)$(includedir)/$$p"; \
 	  $(INSTALL_DATA) $$d$$p $(DESTDIR)$(includedir)/$$p; \
+	  fi \
 	done
 
 uninstall-includeHEADERS:
diff -Naur rpm-4.0.4/popt/configure rpm-new/popt/configure
--- rpm-4.0.4/popt/configure	2002-02-13 18:03:19.000000000 -0500
+++ rpm-new/popt/configure	2002-05-05 00:20:48.000000000 -0400
@@ -3681,7 +3681,7 @@
     ;;
 
   darwin* | rhapsody*)
-    allow_undefined_flag='-undefined suppress'
+    allow_undefined_flag='-flat_namespace -undefined suppress'
     # FIXME: Relying on posixy $() will cause problems for
     #        cross-compilation, but unfortunately the echo tests do not
     #        yet detect zsh echo's removal of \ escapes.
diff -Naur rpm-4.0.4/popt/po/Makefile.in.in rpm-new/popt/po/Makefile.in.in
--- rpm-4.0.4/popt/po/Makefile.in.in	2001-01-15 16:48:12.000000000 -0500
+++ rpm-new/popt/po/Makefile.in.in	2002-05-05 00:20:48.000000000 -0400
@@ -105,7 +105,7 @@
 	cd $(srcdir) && rm -f stamp-cat-id && echo timestamp > stamp-cat-id
 
 
-install: install-exec install-data
+install:
 install-exec:
 install-data: install-data-@USE_NLS@
 install-data-no: all
diff -Naur rpm-4.0.4/python/Makefile.in rpm-new/python/Makefile.in
--- rpm-4.0.4/python/Makefile.in	2002-02-14 18:58:41.000000000 -0500
+++ rpm-new/python/Makefile.in	2002-05-05 00:20:48.000000000 -0400
@@ -198,7 +198,7 @@
 	-I$(top_srcdir)/rpmio \
 	-I$(top_srcdir)/beecrypt \
 	-I$(top_srcdir)/popt \
-	-I/usr/include/python${PYVER} \
+	-I@prefix@/include/python${PYVER} \
 	@INCPATH@
 
 
@@ -206,8 +206,8 @@
 mylibs = \
 	$(top_builddir)/lib/librpm.la \
 	$(top_builddir)/rpmdb/librpmdb.la \
-	$(top_builddir)/rpmio/librpmio.la \
-	$(top_builddir)/popt/libpopt.la
+	$(top_builddir)/rpmio/librpmio-no-fadio.la \
+	$(top_builddir)/popt/librpmpopt.la
 
 
 LDADD = 
@@ -216,9 +216,9 @@
 python_PROGRAMS = rpmmodule.so poptmodule.so
 
 rpmmodule_so_SOURCES = 
-rpmmodule_so_LDFLAGS = $(mylibs) $(LIBS) -shared -Wl,-soname,rpmmodule.so
+rpmmodule_so_LDFLAGS = $(mylibs) $(LIBS) -shared -rpath $(pythondir) -module -avoid-version
 poptmodule_so_SOURCES = poptmodule.c
-poptmodule_so_LDFLAGS = $(mylibs) $(LIBS) -shared -Wl,-soname,poptmodule.so
+poptmodule_so_LDFLAGS = $(mylibs) $(LIBS) -shared -rpath $(pythondir) -module -avoid-version
 
 noinst_LTLIBRARIES = librpmmodule.la
 librpmmodule_la_SOURCES = rpmmodule.c hash.c upgrade.c
@@ -234,13 +234,13 @@
 librpmmodule_la_LDFLAGS = 
 librpmmodule_la_LIBADD = 
 librpmmodule_la_OBJECTS =  rpmmodule.lo hash.lo upgrade.lo
-python_PROGRAMS =  rpmmodule.so poptmodule.so
+python_PROGRAMS =  rpmmodule.la poptmodule.la
 PROGRAMS =  $(python_PROGRAMS)
 
 rpmmodule_so_OBJECTS = 
 rpmmodule_so_LDADD = $(LDADD)
 rpmmodule_so_DEPENDENCIES = 
-poptmodule_so_OBJECTS =  poptmodule.$(OBJEXT)
+poptmodule_so_OBJECTS =  poptmodule.lo
 poptmodule_so_LDADD = $(LDADD)
 poptmodule_so_DEPENDENCIES = 
 CFLAGS = @CFLAGS@
@@ -475,11 +475,11 @@
 mostlyclean distclean maintainer-clean
 
 
-rpmmodule.so: $(librpmmodule_la_OBJECTS)
-	$(LINK) -o $@ $(librpmmodule_la_OBJECTS) $(rpmmodule_so_LDFLAGS)
+rpmmodule.la: $(librpmmodule_la_OBJECTS)
+	$(LINK) $(librpmmodule_la_OBJECTS) $(rpmmodule_so_LDFLAGS)
 
-poptmodule.so: $(poptmodule_so_OBJECTS)
-	$(LINK) -o $@ $(poptmodule_so_OBJECTS) $(poptmodule_so_LDFLAGS)
+poptmodule.la: $(poptmodule_so_OBJECTS)
+	$(LINK) $(poptmodule_so_OBJECTS) $(poptmodule_so_LDFLAGS)
 
 .PHONY:	lclint
 lclint:
diff -Naur rpm-4.0.4/python/rpmmodule.c rpm-new/python/rpmmodule.c
--- rpm-4.0.4/python/rpmmodule.c	2002-02-03 18:59:57.000000000 -0500
+++ rpm-new/python/rpmmodule.c	2002-05-05 00:20:48.000000000 -0400
@@ -2,7 +2,7 @@
  * \file python/rpmmodule.c
  */
 
-#include <alloca.h>
+#include <stdlib.h>
 #include <errno.h>
 #include <fcntl.h>
 #include <time.h>
diff -Naur rpm-4.0.4/rpmdb/Makefile.in rpm-new/rpmdb/Makefile.in
--- rpm-4.0.4/rpmdb/Makefile.in	2002-02-14 18:58:38.000000000 -0500
+++ rpm-new/rpmdb/Makefile.in	2002-05-05 00:20:48.000000000 -0400
@@ -210,7 +210,7 @@
 	-L$(top_builddir)/popt/.libs
 
 
-mylibs = -lrpm -lrpmio -lpopt @LIBS@ @INTLLIBS@ @LIBMISC@
+mylibs = -lrpm -lrpmio -lrpmpopt @LIBS@ @INTLLIBS@ @LIBMISC@
 LIBS = 
 
 DB3LOBJS = $(shell cat $(top_builddir)/$(WITH_DB_SUBDIR)/db3lobjs)
diff -Naur rpm-4.0.4/rpmio/Makefile.in rpm-new/rpmio/Makefile.in
--- rpm-4.0.4/rpmio/Makefile.in	2002-02-14 18:58:37.000000000 -0500
+++ rpm-new/rpmio/Makefile.in	2002-05-05 00:20:49.000000000 -0400
@@ -209,31 +209,32 @@
 
 noinst_HEADERS = rpmio_internal.h rpmpgp.h
 
-LIBS = @LIBS@ @WITH_ZLIB_LIB@ -lrt -lpthread
+LIBS = @LIBS@ @WITH_ZLIB_LIB@ -lpthread
 
 BEECRYPTLOBJS = $(shell cat $(top_builddir)/beecrypt/listobjs)
 
-lib_LTLIBRARIES = librpmio.la
-librpmio_la_SOURCES = digest.c macro.c rpmio.c rpmlog.c rpmmalloc.c \
+lib_LTLIBRARIES = librpmio.la librpmio-no-fadio.la
+librpmio_no_fadio_la_SOURCES = digest.c macro.c rpmio.c rpmlog.c rpmmalloc.c \
 	rpmpgp.c rpmrpc.c strcasecmp.c stubs.c url.c ugid.c
+librpmio_la_SOURCES = $(librpmio_no_fadio_la_SOURCES) rpmio_fadio.c
 
 librpmio_la_LDFLAGS = -release @VERSION@
 librpmio_la_LIBADD = $(BEECRYPTLOBJS)
 librpmio_la_DEPENDENCIES = .created
 
 tdigest_SOURCES = tdigest.c
-tdigest_LDADD =  librpmio.la $(top_builddir)/popt/libpopt.la
+tdigest_LDADD =  librpmio.la $(top_builddir)/popt/librpmpopt.la
 
 trpmio_SOURCES = trpmio.c
-trpmio_LDADD =  librpmio.la $(top_builddir)/popt/libpopt.la
+trpmio_LDADD =  librpmio.la $(top_builddir)/popt/librpmpopt.la
 
 tkey_SOURCES = tkey.c
 tkey_LDFLAGS = -all-static
-tkey_LDADD =  librpmio.la $(top_builddir)/popt/libpopt.la
+tkey_LDADD =  librpmio.la $(top_builddir)/popt/librpmpopt.la
 
 tring_SOURCES = tring.c
 tring_LDFLAGS = -all-static
-tring_LDADD =  librpmio.la $(top_builddir)/popt/libpopt.la
+tring_LDADD =  librpmio.la $(top_builddir)/popt/librpmpopt.la
 
 dumpasn1_SOURCES = dumpasn1.c
 mkinstalldirs = $(SHELL) $(top_srcdir)/mkinstalldirs
@@ -245,17 +246,18 @@
 DEFS = @DEFS@ -I. -I$(srcdir) -I..
 CPPFLAGS = @CPPFLAGS@
 LDFLAGS = @LDFLAGS@
-librpmio_la_OBJECTS =  digest.lo macro.lo rpmio.lo rpmlog.lo \
+librpmio_no_fadio_la_OBJECTS =  digest.lo macro.lo rpmio.lo rpmlog.lo \
 rpmmalloc.lo rpmpgp.lo rpmrpc.lo strcasecmp.lo stubs.lo url.lo ugid.lo
+librpmio_la_OBJECTS = $(librpmio_no_fadio_la_OBJECTS) rpmio_fadio.lo
 tdigest_OBJECTS =  tdigest.$(OBJEXT)
-tdigest_DEPENDENCIES =  librpmio.la $(top_builddir)/popt/libpopt.la
+tdigest_DEPENDENCIES =  librpmio.la $(top_builddir)/popt/librpmpopt.la
 tdigest_LDFLAGS = 
 tkey_OBJECTS =  tkey.$(OBJEXT)
-tkey_DEPENDENCIES =  librpmio.la $(top_builddir)/popt/libpopt.la
+tkey_DEPENDENCIES =  librpmio.la $(top_builddir)/popt/librpmpopt.la
 tring_OBJECTS =  tring.$(OBJEXT)
-tring_DEPENDENCIES =  librpmio.la $(top_builddir)/popt/libpopt.la
+tring_DEPENDENCIES =  librpmio.la $(top_builddir)/popt/librpmpopt.la
 trpmio_OBJECTS =  trpmio.$(OBJEXT)
-trpmio_DEPENDENCIES =  librpmio.la $(top_builddir)/popt/libpopt.la
+trpmio_DEPENDENCIES =  librpmio.la $(top_builddir)/popt/librpmpopt.la
 trpmio_LDFLAGS = 
 dumpasn1_OBJECTS =  dumpasn1.$(OBJEXT)
 dumpasn1_LDADD = $(LDADD)
@@ -358,9 +360,12 @@
 
 maintainer-clean-libtool:
 
-librpmio.la: $(librpmio_la_OBJECTS) $(librpmio_la_DEPENDENCIES)
+librpmio.la: $(librpmio_la_OBJECTS) $(librpmio_la_DEPENDENCIES) librpmio-no-fadio.la
 	$(LINK) -rpath $(libdir) $(librpmio_la_LDFLAGS) $(librpmio_la_OBJECTS) $(librpmio_la_LIBADD) $(LIBS)
 
+librpmio-no-fadio.la: $(librpmio_no_fadio_la_OBJECTS) $(librpmio_la_DEPENDENCIES)
+	$(LINK) -rpath $(libdir) $(librpmio_la_LDFLAGS) $(librpmio_no_fadio_la_OBJECTS) $(librpmio_la_LIBADD) $(LIBS)
+
 tdigest$(EXEEXT): $(tdigest_OBJECTS) $(tdigest_DEPENDENCIES)
 	@rm -f tdigest$(EXEEXT)
 	$(LINK) $(tdigest_LDFLAGS) $(tdigest_OBJECTS) $(tdigest_LDADD) $(LIBS)
@@ -531,8 +536,10 @@
 # XXX Add internal libtool dependence
 install-data-local:
 	@cd $(DESTDIR)/$(libdir) && \
-	sed -e "s|^dependency_libs='|& -lpopt|" < librpmio.la > .librpmio.la && \
+	sed -e "s|^dependency_libs='|& -lrpmpopt|" < librpmio.la > .librpmio.la && \
 	mv .librpmio.la librpmio.la
+	sed -e "s|^dependency_libs='|& -lrpmpopt|" < librpmio-no-fadio.la > .librpmio-no-fadio.la && \
+	mv .librpmio-no-fadio.la librpmio-no-fadio.la
 
 $(top_builddir)/beecrypt/listobjs:
 	make -C $(top_builddir)/beecrypt listobjs
diff -Naur rpm-4.0.4/rpmio/rpmio.c rpm-new/rpmio/rpmio.c
--- rpm-4.0.4/rpmio/rpmio.c	2002-02-13 17:55:23.000000000 -0500
+++ rpm-new/rpmio/rpmio.c	2002-05-05 00:20:49.000000000 -0400
@@ -30,6 +30,8 @@
 # include <netinet/in_systm.h>
 #endif
 
+char *__progname = "";
+
 #if HAVE_LIBIO_H && defined(_G_IO_IO_FILE_VERSION)
 #define	_USE_LIBIO	1
 #endif
@@ -520,10 +522,6 @@
 };
 FDIO_t fdio = /*@-compmempass@*/ &fdio_s /*@=compmempass@*/ ;
 
-/*@-redef@*/	/* see lib/falloc.c */
-FDIO_t fadio;	/* XXX usually NULL, filled in when linked with rpm */
-/*@=redef@*/
-
 int fdWritable(FD_t fd, int secs)
 {
     int fdno;
diff -Naur rpm-4.0.4/rpmio/rpmio_fadio.c rpm-new/rpmio/rpmio_fadio.c
--- rpm-4.0.4/rpmio/rpmio_fadio.c	1969-12-31 19:00:00.000000000 -0500
+++ rpm-new/rpmio/rpmio_fadio.c	2002-05-05 00:20:49.000000000 -0400
@@ -0,0 +1 @@
+#include "rpmio.h"
diff -Naur rpm-4.0.4/system.h rpm-new/system.h
--- rpm-4.0.4/system.h	2002-01-20 16:41:42.000000000 -0500
+++ rpm-new/system.h	2002-05-05 00:20:49.000000000 -0400
@@ -45,6 +45,9 @@
 extern time_t timezone;
 #endif
 
+#include <crt_externs.h>
+#define environ (*_NSGetEnviron())
+
 /* Since major is a function on SVR4, we can't use `ifndef major'.  */
 #if MAJOR_IN_MKDEV
 #include <sys/mkdev.h>
@@ -333,7 +336,7 @@
     else __progname = pn;		\
   }
 #endif
-const char *__progname;
+extern char *__progname;
 
 #if HAVE_NETDB_H
 #include <netdb.h>
diff -Naur rpm-4.0.4/tools/Makefile.in rpm-new/tools/Makefile.in
--- rpm-4.0.4/tools/Makefile.in	2002-02-14 18:58:42.000000000 -0500
+++ rpm-new/tools/Makefile.in	2002-05-05 00:20:49.000000000 -0400
@@ -212,7 +212,7 @@
 	$(top_builddir)/lib/librpm.la \
 	$(top_builddir)/rpmdb/librpmdb.la \
 	$(top_builddir)/rpmio/librpmio.la \
-	$(top_builddir)/popt/libpopt.la \
+	$(top_builddir)/popt/librpmpopt.la \
 	@WITH_ZLIB_LIB@ \
 	@INTLLIBS@
 
@@ -249,60 +249,60 @@
 rpminject_LDADD = $(LDADD)
 rpminject_DEPENDENCIES =  $(top_builddir)/build/librpmbuild.la \
 $(top_builddir)/lib/librpm.la $(top_builddir)/rpmdb/librpmdb.la \
-$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/libpopt.la
+$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/librpmpopt.la
 rpminject_LDFLAGS = 
 rpmsort_OBJECTS =  rpmsort.$(OBJEXT)
 rpmsort_LDADD = $(LDADD)
 rpmsort_DEPENDENCIES =  $(top_builddir)/build/librpmbuild.la \
 $(top_builddir)/lib/librpm.la $(top_builddir)/rpmdb/librpmdb.la \
-$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/libpopt.la
+$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/librpmpopt.la
 dump_SOURCES = dump.c
 dump_OBJECTS =  dump.$(OBJEXT)
 dump_LDADD = $(LDADD)
 dump_DEPENDENCIES =  $(top_builddir)/build/librpmbuild.la \
 $(top_builddir)/lib/librpm.la $(top_builddir)/rpmdb/librpmdb.la \
-$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/libpopt.la
+$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/librpmpopt.la
 dump_LDFLAGS = 
 dumpdb_SOURCES = dumpdb.c
 dumpdb_OBJECTS =  dumpdb.$(OBJEXT)
 dumpdb_LDADD = $(LDADD)
 dumpdb_DEPENDENCIES =  $(top_builddir)/build/librpmbuild.la \
 $(top_builddir)/lib/librpm.la $(top_builddir)/rpmdb/librpmdb.la \
-$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/libpopt.la
+$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/librpmpopt.la
 dumpdb_LDFLAGS = 
 rpmarchive_SOURCES = rpmarchive.c
 rpmarchive_OBJECTS =  rpmarchive.$(OBJEXT)
 rpmarchive_LDADD = $(LDADD)
 rpmarchive_DEPENDENCIES =  $(top_builddir)/build/librpmbuild.la \
 $(top_builddir)/lib/librpm.la $(top_builddir)/rpmdb/librpmdb.la \
-$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/libpopt.la
+$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/librpmpopt.la
 rpmarchive_LDFLAGS = 
 rpmheader_SOURCES = rpmheader.c
 rpmheader_OBJECTS =  rpmheader.$(OBJEXT)
 rpmheader_LDADD = $(LDADD)
 rpmheader_DEPENDENCIES =  $(top_builddir)/build/librpmbuild.la \
 $(top_builddir)/lib/librpm.la $(top_builddir)/rpmdb/librpmdb.la \
-$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/libpopt.la
+$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/librpmpopt.la
 rpmheader_LDFLAGS = 
 rpmlead_SOURCES = rpmlead.c
 rpmlead_OBJECTS =  rpmlead.$(OBJEXT)
 rpmlead_LDADD = $(LDADD)
 rpmlead_DEPENDENCIES =  $(top_builddir)/build/librpmbuild.la \
 $(top_builddir)/lib/librpm.la $(top_builddir)/rpmdb/librpmdb.la \
-$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/libpopt.la
+$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/librpmpopt.la
 rpmlead_LDFLAGS = 
 rpmsignature_SOURCES = rpmsignature.c
 rpmsignature_OBJECTS =  rpmsignature.$(OBJEXT)
 rpmsignature_LDADD = $(LDADD)
 rpmsignature_DEPENDENCIES =  $(top_builddir)/build/librpmbuild.la \
 $(top_builddir)/lib/librpm.la $(top_builddir)/rpmdb/librpmdb.la \
-$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/libpopt.la
+$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/librpmpopt.la
 rpmsignature_LDFLAGS = 
 javadeps_OBJECTS =  javadeps.$(OBJEXT)
 javadeps_LDADD = $(LDADD)
 javadeps_DEPENDENCIES =  $(top_builddir)/build/librpmbuild.la \
 $(top_builddir)/lib/librpm.la $(top_builddir)/rpmdb/librpmdb.la \
-$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/libpopt.la
+$(top_builddir)/rpmio/librpmio.la $(top_builddir)/popt/librpmpopt.la
 javadeps_LDFLAGS = 
 CFLAGS = @CFLAGS@
 COMPILE = $(CC) $(DEFS) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
@@ -569,8 +569,6 @@
 mostlyclean distclean maintainer-clean
 
 
-$(PROGRAMS): $(myLDADD)
-
 gnash.o: gnash.c
 	$(COMPILE) -o $@ -c gnash.c
 
