Package: svn-ssl
Version: 1.3.0-rc4
Revision: 11
Description: Upgrade package for svn
License: BSD
Maintainer: Christian Schaffner <chris01@users.sourceforge.net>

# Dependencies:
Depends: svn-shlibs (= %v-%r) | %N-shlibs (= %v-%r), daemonic
BuildDepends: apr-ssl (>= 0.9.7-11) | apr (>= 0.9.7-11), apr-ssl-common (>= 0.9.7-11) | apr-common (>= 0.9.7-11), db43-ssl | db43, gdbm3, expat (>= 1.95.6-2), libxml2 (>= 2.5.10-12), fink (>= 0.16.0-1), neon25, openldap23-dev, cyrus-sasl2-dev (>= 2.1.21-3), system-openssl-dev, texinfo (>= 4.2-22), libiconv-dev (>= 1.9.1-11), gettext-bin, gettext-tools, libgettext3-dev, io-string-pm, libtool14 (>= 1.5.10-1), autoconf2.5, automake1.9, gcc3.3
BuildDependsOnly: True
#, sqlite3-dev, swig (>= 1.3.24-1)

# Unpack Phase:
Source: http://subversion.tigris.org/downloads/subversion-%v.tar.bz2
Source-MD5: 32bd8a7ff6855151704ae5d5773f7028

# Patch Phase:
Patch: svn.patch

# Compile Phase:
ConfigureParams: --libexecdir='${prefix}/lib/svn' --mandir='${prefix}/share/man' --infodir='${prefix}/share/info' --with-neon=%p --with-apr=%p --with-apr-util=%p --enable-shared --without-apxs --without-apache --disable-mod-activation --without-jdk --disable-javahl --with-jikes=no --disable-swig-bindings --without-swig --without-python --without-perl --without-ruby --disable-dependency-tracking
# --with-swig=%p
SetCPPFLAGS: -no-cpp-precomp -I%p/lib/system-openssl/include
SetLDFLAGS: -L%p/lib/system-openssl/lib
GCC: 3.3
CompileScript: <<
#! /bin/sh -e
 ### Remove packages that are installed by fink
 rm -rf neon
 rm -rf apr
 rm -rf apr-util

 # recreate configure with libtool 1.5
 ./autogen.sh

 ### Configure shared
 export CC=gcc-3.3; export CXX=g++-3.3; export F77=no; ./configure %c

 ### force SWIG to use gcc 3.3 too
 #perl -pi.bak -e 's|(SWIG.*)gcc|${1}gcc-3.3|g' Makefile
 
 ### make everything shared
 make CC=gcc-3.3 CXX=g++-3.3
 
 ### Run tests over ra_local using BDB:
# echo "Running tests over ra_local using BDB..."
# make check CLEANUP=true FS_TYPE=bdb
 
 ### Run tests over ra_local using fs_fs:
# echo "Running tests over ra_local using fs_fs..."
# make check CLEANUP=true FS_TYPE=fsfs

 ### Run tests over ra_svn using BDB:
#  echo "Running tests over ra_svn using BDB..."
#  ./subversion/svnserve/svnserve -d -r `pwd`/subversion/tests/clients/cmdline
#  make svncheck CLEANUP=true FS_TYPE=bdb
#  killall -v -u root svnserve

 ### Run tests over ra_svn using fs_fs:
#  echo "Running tests over ra_svn using fs_fs..."
#  ./subversion/svnserve/svnserve -d -r `pwd`/subversion/tests/clients/cmdline
#  make check CLEANUP=true BASE_URL=svn://localhost FS_TYPE=fsfs
#  killall -v -u root svnserve

 ### Run tests over ra_dav:
 # NOTE: The update_tests.py fails if tested against 1.0.x server
 # See DescPackaging on how to set up for tests over ra_dav
#  echo "Running tests over ra_dav..."
#  make check BASE_URL=http://localhost
<<

# Install Phase:
DocFiles: BUGS CHANGES COMMITTERS COPYING HACKING INSTALL README TRANSLATING
InstallScript: <<
 make install DESTDIR=%d
 
 ### Install docu and notes
 /usr/bin/install -d %i/share
 /usr/bin/install -d %i/share/doc
 /usr/bin/install -d %i/share/doc/%n
 cp -r www %i/share/doc/%n
 cp -r doc/user %i/share/doc/%n
 cp -r notes %i/share/doc/%n
 
 ### Configure and install examples, tools and notes
 /usr/bin/install -d %i/share/%n
 cp -r tools/backup %i/share/%n/tools
 cp -r tools/bdb %i/share/%n/tools
 cp -r tools/client-side %i/share/%n/tools
 cp -r tools/dev %i/share/%n/tools
 cp -r tools/diff %i/share/%n/tools
 cp -r tools/examples %i/share/%n/tools
 cp -r tools/hook-scripts %i/share/%n/tools
 cp -r tools/po %i/share/%n/tools
 cp -r tools/test-scripts %i/share/%n/tools
 cp -r tools/xslt %i/share/%n/tools
 
 cp -r contrib %i/share/%n

 # Remove unneeded .in files
 find %i/share/%n -name \*.in -print0 | xargs -0 rm -f
 
 ### Install binaries
 /usr/bin/install -d %i/bin
 /usr/bin/install -m 755 svn-config %i/bin

 # Install default directory for repositories
 /usr/bin/install -d %i/var
 /usr/bin/install -m 770 -d %i/var/svn
<<

DaemonicName: svnserve
DaemonicFile: <<
 <service>
  <description>Subversion server</description>
  <message>Subversion server</message>

  <daemon name="svnserve">
    <executable background="no">/usr/bin/sudo</executable>
    <parameters>-u www %p/bin/svnserve -d -r %p/var/svn</parameters>
  </daemon>
 </service>
<<
PostInstScript: <<
 chown www:admin %p/var/svn
 daemonic install svnserve
<<
PreRmScript: <<
 if [ $1 != "upgrade" ]; then
   daemonic remove svnserve
 fi
<<

PreInstScript: <<
 if [ "$1" = upgrade ]; then
   if dpkg --compare-versions "$2" lt "1.2.0"; then
     echo ""
     echo "WARNING: Subversion (svn) 1.2 or later uses Berkeley DB 4.3 (db43)."
     echo "If you are upgrading from an earlier version and you are using"
     echo "BDB repositories please read"
     echo ""
     echo "  http://subversion.tigris.org/faq.html#bdb43-upgrade"
     echo ""
     echo "To install an older svnadmin binary linked to db42 please install"
     echo "the fink package 'svn-ssl-1.1.4-11', e.g. by typing"
     echo ""
     echo "  fink install svn-ssl-1.1.4-11"
     echo ""
     echo -n "Do you want to continue [Y/n] ? ";
     if read -t 3600 CONTINUECHOICE; then
       case $CONTINUECHOICE in
         y|Y|'' ) ;;
         * ) exit 1 ;;
       esac
     else
       echo "Time-out."
     fi
   fi
 fi
 exit 0
<<

SplitOff: <<
  Description: Upgrade package for svn-dev
  Package: %N-dev
  Depends: svn-shlibs (= %v-%r) | %N-shlibs (= %v-%r)
  BuildDependsOnly: True
  Files: <<
    bin/svn-config
    include
    lib/*.a
    lib/*.la
    lib/libsvn_client-1.dylib
    lib/libsvn_delta-1.dylib
    lib/libsvn_diff-1.dylib
    lib/libsvn_fs-1.dylib
    lib/libsvn_fs_base-1.dylib
    lib/libsvn_fs_fs-1.dylib
    lib/libsvn_ra-1.dylib
    lib/libsvn_ra_dav-1.dylib
    lib/libsvn_ra_local-1.dylib
    lib/libsvn_ra_svn-1.dylib
    lib/libsvn_repos-1.dylib
    lib/libsvn_subr-1.dylib
    lib/libsvn_wc-1.dylib
  <<
  DocFiles: COPYING HACKING
<<
SplitOff2: <<
  Description: Upgrade package for svn-shlibs
  Package: %N-shlibs
  Depends: apr-ssl-shlibs (>= 0.9.7-11) | apr-shlibs (>= 0.9.7-11), db43-ssl-shlibs | db43-shlibs, gdbm3-shlibs, expat-shlibs (>= 1.95.6-2), libxml2-shlibs (>= 2.5.10-12), neon25-shlibs, openldap23-shlibs, cyrus-sasl2-shlibs (>= 2.1.21-3), libgettext3-shlibs
  BuildDependsOnly: True
  Files: <<
    lib/libsvn_client-1.0.0.0.dylib
    lib/libsvn_delta-1.0.0.0.dylib
    lib/libsvn_diff-1.0.0.0.dylib
    lib/libsvn_fs-1.0.0.0.dylib
    lib/libsvn_fs_base-1.0.0.0.dylib
    lib/libsvn_fs_fs-1.0.0.0.dylib
    lib/libsvn_ra-1.0.0.0.dylib
    lib/libsvn_ra_dav-1.0.0.0.dylib
    lib/libsvn_ra_local-1.0.0.0.dylib
    lib/libsvn_ra_svn-1.0.0.0.dylib
    lib/libsvn_repos-1.0.0.0.dylib
    lib/libsvn_subr-1.0.0.0.dylib
    lib/libsvn_wc-1.0.0.0.dylib
    lib/libsvn_client-1.0.dylib
    lib/libsvn_delta-1.0.dylib
    lib/libsvn_diff-1.0.dylib
    lib/libsvn_fs-1.0.dylib
    lib/libsvn_fs_base-1.0.dylib
    lib/libsvn_fs_fs-1.0.dylib
    lib/libsvn_ra-1.0.dylib
    lib/libsvn_ra_dav-1.0.dylib
    lib/libsvn_ra_local-1.0.dylib
    lib/libsvn_ra_svn-1.0.dylib
    lib/libsvn_repos-1.0.dylib
    lib/libsvn_subr-1.0.dylib
    lib/libsvn_wc-1.0.dylib
  <<
  Shlibs: <<
    %p/lib/libsvn_client-1.0.dylib 1.0.0 %n (>= 0.30.0-11)
    %p/lib/libsvn_delta-1.0.dylib 1.0.0 %n (>= 0.30.0-11)
    %p/lib/libsvn_diff-1.0.dylib 1.0.0 %n (>= 0.30.0-11)
    %p/lib/libsvn_fs-1.0.dylib 1.0.0 %n (>= 0.30.0-11)
    %p/lib/libsvn_fs_base-1.0.dylib 1.0.0 %n (>= 1.1.0-11)
    %p/lib/libsvn_fs_fs-1.0.dylib 1.0.0 %n (>= 1.1.0-11)
    %p/lib/libsvn_ra-1.0.dylib 1.0.0 %n (>= 0.30.0-11)
    %p/lib/libsvn_ra_dav-1.0.dylib 1.0.0 %n (>= 0.30.0-11)
    %p/lib/libsvn_ra_local-1.0.dylib 1.0.0 %n (>= 0.30.0-11)
    %p/lib/libsvn_ra_svn-1.0.dylib 1.0.0 %n (>= 0.30.0-11)
    %p/lib/libsvn_repos-1.0.dylib 1.0.0 %n (>= 0.30.0-11)
    %p/lib/libsvn_subr-1.0.dylib 1.0.0 %n (>= 0.30.0-11)
    %p/lib/libsvn_wc-1.0.dylib 1.0.0 %n (>= 0.30.0-11)
  <<
  DocFiles: BUGS CHANGES COMMITTERS COPYING HACKING INSTALL README TRANSLATING
<<
SplitOff3: <<
  Description: Upgrade package for svn-client
  Package: svn-client-ssl
  Depends: svn-shlibs (= %v-%r) | %N-shlibs (= %v-%r)
  BuildDependsOnly: True
  Files: <<
    bin/svn
    bin/svnversion
    share/locale
    share/man/man1/svn.1
    share/man/man1/svnversion.1
    share/%N/contrib/client-side
    share/%N/tools/client-side
  <<
  DocFiles: BUGS CHANGES COMMITTERS COPYING HACKING INSTALL README  TRANSLATING
  DescUsage: <<
    This installs the subversion client.
    Type 'svn help' for usage and look in %p/share/svn/tools and 
    %p/share/svn/contrib.
    
    WARNING:
    This client may be incompatible with ra_dav servers <= 0.35
  <<
<<
SplitOff8: <<
 Package: %N-doc
 Description: Upgrade package for svn-doc
 Files: <<
  share/doc
  share/info
 <<
 DocFiles: COPYING
<<

# Additional Info
DescDetail: <<
Please upgrade to the non -ssl svn packages.
<<
DescPackaging: <<
 This is only an upgrade package for the non -ssl packages using system openssl.
 Therefore all split offs are BuildDependsOnly.
 This package should therefore not be moved to 10.4T and 10.5 trees.
<<
Homepage: http://subversion.tigris.org/
