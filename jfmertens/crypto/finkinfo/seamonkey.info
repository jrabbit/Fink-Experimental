Info2: <<
## trouble already caused (i.e., strongly intensified) by passing from "seamonkey_old" to "seamonkey_old1"
## But occured already with "old" : cf last item ("2009-02-15 20:10:28.860 +0100") of seamonkey-bin.crash.log 
Package: seamonkey
# Version according to mozilla/config/milestone.txt ("mozilla-version"),
# rather than suite/config/version.txt ("seamonkey-version", =%type_raw[ver]), to leave room for growth till 2.0
Version: 2.0.3
Revision: 1
## parameters needed at several places :
Type: sys_nspr (no), ver (%v)
Depends: %N2-shlibs (= %v-%r), bzip2-shlibs
BuildDepends: <<
	atk1 (>= 1.20.0-1),
	bzip2-dev,
	cairo (>= 1.6-1),
	dbus-dev,
	expat1,
	fink (>= 0.27.2-1),
	fontconfig2-dev (>= 2.4.1-1),
	freetype219 (>= 2.3.5-1),
	gconf2-dev (>= 2.20.0-1),
	glib2-dev (>= 2.14.0-1),
	glitz,
	gnome-vfs2-unified-dev (>= 1:2.20.0-1),
	gtk+2-dev (>= 2.12.0-1),
	libart2 (>= 2.3.20-1),
	libbonobo2-dev (>= 2.20.0-1),
	libbonoboui2-dev (>= 2.24.0-1),
	libgettext8-dev,
	libgnome2-dev (>= 2.20.0-1),
	libgnomecanvas2-dev (>= 2.20.1.1-2),
	libgnomeui2-dev (>= 2.20.0-1),
	libiconv-dev,
	libjpeg8,
	(%type_raw[sys_nspr] = .) nspr,
	openssl098-dev,
	orbit2-dev (>= 2.14.9-1),
	pango1-xft2-ft219-dev (>= 1.18.4-4),
	pixman (>= 0.10.0-1),
	pkgconfig (>= 0.21-1),
	popt (>= 1.10.4-1),
	pth2-dev,
	sed,
	x11-dev,
	xft2-dev
<<
GCC: 4.0

Source-MD5: ce943cd8d55a2b9e0af2f564520be013
Source: mirror:custom:mozilla.org/%N/releases/%type_raw[ver]/source/%N-%type_raw[ver].source.tar.bz2
SourceDirectory: comm-1.9.1
CustomMirror: <<
  Primary: http://ftp.mozilla.org/pub/
#  nam-US: ftp://ftp.tux.org/pub/net/mozilla/
#  asi-JP: http://www.t.ring.gr.jp/pub/net/www/mozilla/
<<
#SourceDirectory: mozilla

## someone should once re-generate this old patchfile, going back to the early mozilla versions, and that I've only edited since..
PatchFile: %n.patch
PatchFile-MD5: 6ffb5602889bf63f9691f5bbd4f756e2
PatchScript: <<
 #!/bin/sh -ev
 find . -name CVS -o -name .cvsignore | xargs rm -fR
 if [ -e /usr/X11R6/include/X11/X.h ]; then
   Xdir="/usr/X11R6"
 elif [ -e /usr/X11/include/X11/X.h ]; then
   Xdir="/usr/X11"
 else
   echo "Could not determine X11 prefix"
   exit 1
 fi
 sed -e 's,@PREFIX@,%p,g' -e "s,/usr/X11R6,$Xdir," <%{PatchFile} | patch -p1
#### Next is new for 2.0a
 # for documentation; prefer to see explicitly everything in %c
# mv .mozconfig .mozconfig.bak

### gfxtypes.h and gfxTypes.h end up in the same directory. We rename the former. (Should use a 'find' for robustness..)
#   We'll put some symlinks with the original name elsewhere, though it seems to become obsolete, and no other fink pkg uses it.
 mv mozilla/gfx/idl/gfxtypes.idl mozilla/gfx/idl/gfx_types.idl
 sed -i'' -e 's,include "gfxtypes.idl",include "gfx_types.idl",' \
	mozilla/{gfx/idl/gfxI{Formats,ImageFrame},modules/libpr0n/public/imgIContainer{,Observer}}.idl
 sed -i'' -e 's,gfxtypes.idl,gfx_types.idl,' mozilla/gfx/idl/{Makefile.in,gfx_types.idl}

### CAIRO and gfx
 # Including Carbon.h brings in so many headers that there are several name clashes with the X11 headers also brought in.
 # And CGContext.h suffices
 sed -i.bak -e \
 's,Carbon/Carbon.h,/System/Library/Frameworks/ApplicationServices.framework/Frameworks/CoreGraphics.framework/Headers/CGContext.h,' \
	mozilla/gfx/thebes/public/gfxQuartzSurface.h
 sed -i.bak -e 's,Multiprocessing.h,/System/Library/Frameworks/CoreServices.framework/Frameworks/CarbonCore.framework/Headers/&,' \
	mozilla/media/liboggplay/src/liboggplay/std_semaphore.h
 sed -i.bak -e 's,Carbon\.h,Carbon/&,' mozilla/gfx/thebes/src/gfxQuartzFontCache.mm

## Either of the 2 following attempts should be viable. Launch time problems (probably unrelated) remain with both..
#### FIRST ATTEMPT FOR CAIRO_QUARTZ (ends up with needing to add --enable-quartz-image  to cairo.info) 
 ## we have to delete a number of targets because fink's cairo has --disable-quartz-image
 ## better to disable any quartz support altogether? What could be its use?
 #### we need this time the quartz cpp srcs _ but don't include twice nsUnicodeRange.cpp
#sed -i.bak -e '/cocoa/,/endif/{
#	/cocoa/d
#	/nsUnicodeRange.cpp/d
#	/endif/d }' \
#	 mozilla/gfx/thebes/src/Makefile.in
 # fink's cairo-features.h gets included in gfx/thebes/src, and defines CAIRO_HAS_QUARTZ_FONT and CAIRO_HAS_QUARTZ_SURFACE
 # w/o next, we get missing headers for gfxQuartzSurface.h and gfxQuartzImageSurface.h (to begin with ?)
# sed -ri.bak -e 's,mac cocoa,& gtk2,' mozilla/gfx/thebes/public/Makefile.in
 # Use a non-existing macro to exclude the CAIRO_SURFACE_TYPE_QUARTZ_IMAGE case (still --disable-quartz-image ...)
# sed -i.bak -e '/ gfxQuartzSurface/,/else if/s,[}],&\n#endif\n#ifdef CAIRO_HAS_QUARTZ_IMAGE_SURFACE,' \
#	mozilla/gfx/thebes/src/gfxASurface.cpp

#### OTHER ATTEMPT FOR CAIRO_QUARTZ : disable any quartz support altogether...
 sed -i.bak -e 's,CAIRO_HAS_QUARTZ_SURFACE,&NO,' -e 's,XP_MACOSX,&NO,' mozilla/gfx/thebes/src/gfxASurface.cpp

 # The following for LCMS are because else ld looks for those symbols in %p/lib/libmozlcms.dylib
 # (which is non-existent, and not even where it should go). Those missing symbols come partly from the dylibs on the link line,
 # not from the objects being linked. libgkgfx.dylib itself takes no symbols from libmozlcms nor from -lxpcom_core..
 sed -i.bak -e '/MOZ_UNICHARUTIL_LIBS/a \
	$(LCMS_LIBS) -lxpcom_core -lnspr4 -lplc4 \\' mozilla/gfx/src/Makefile.in
 sed -i.bak -e '/MOZ_UNICHARUTIL_LIBS/a \
		$(LCMS_LIBS) \\' mozilla/{gfx/src/thebes,layout/build}/Makefile.in
 sed -i.bak -e '/MOZ_UNICHARUTIL_LIBS/a \
		-framework AddressBook \\' mailnews/build/Makefile.in
####
 # the need for -lcrypto comes from the symbols MD5_Init and MD5_Final, used in
 # toolkit/crashreporter/google-breakpad/src/common/mac/{file,macho}_id.cc, and defined nowhere in the builddir...
 #  -->  since it is only for that, SWITCH to system-openssl !
 sed -i.bak -e 's,EXTRA_DSO_LIBS),& -lcrypto,' mozilla/toolkit/library/Makefile.in
 # Else expands to "./mozilla", leading to obvious breakage when autoconf.mk is sourced from elsewhere
 sed -i.bak -e 's,@MOZILLA_SRCDIR@,%b/mozilla,' config/autoconf.mk.in
 # allow to do a "make install" even on Darwin !
 sed -i.bak -e 's, Darwin,,' mozilla/toolkit/mozapps/installer/packager.mk
####

### Getting "reasonable" install_names (libs are not versioned! and their "install_name" would else just be
### "@executable_path/libname" ...) . To be able to get minimal "shlibs-policy" compliance,
### we'll replace all '@executable_path's in install_names by a 'real path' that includes a symlink containing "%N-%V"
 V=`cut -f1 -d. <<<"%type_raw[ver]"`
 # for consistency, remove the : "-Wl,-executable_path,$(LIBXUL_DIST)/bin" from the link commands
 sed -ri.bak -e "s,.*executable_path.*,    MOZ_FIX_LINK_PATHS=''," {,mozilla/{,js/src/}}configure{.in,}
 sed -ri.bak -e "s,(install_name|dylib_file) +@executable_path,\1 %p/lib/%N-$V,g" \
	{,mozilla/{,js/src/}}config/{config,rules}.mk {directory/c-sdk,mozilla/nsprpub}/configure{.in,} \
	mozilla/security/coreconf/Darwin.mk mozilla/security/nss/lib/freebl/config.mk
# perl -pi.bak -e \   # files seem to have disappeared
#   "s;rules.mk;$&\nEXTRA_DSO_LDOPTS := \\\$\(subst install_name \\\$\(mozappdir\)/,install_name %p/lib/%N-$V/ipc/modules/,\\\$\(EXTRA_DSO_LDOPTS\)\);" \
#   mozilla/ipc/ipcd/{extensions/{lock/src,transmngr},test}/module/Makefile.in
 perl -pi.bak -e \
   "s;rules.mk;$&\nEXTRA_DSO_LDOPTS := \\\$\(subst install_name \\\$\(mozappdir\)/,install_name %p/lib/%N-$V/plugins/,\\\$\(EXTRA_DSO_LDOPTS\)\);" \
   mozilla/modules/plugin/sdk/samples/unixprinting/Makefile.in

#### we want a gtk2 build:
 sed -i'' -e 's, -DXP_MACOSX -DNO_X11, -DX11,' {,mozilla/}configure{.in,}
 sed -i'' -e '/XP_MACOSX/d' mozilla/nsprpub/configure{.in,}
### The bulk of gnome deps (save for gnome-vfs and gtk2) would disappear w/o the following 8 lines; they appear just in libimgicon
### get around specific setting for darwin _ and, in same Makefile, get flag-ordering right, to avoid linking with nspr-shlibs.
 sed -i.bak -e 's,PLATFORM = mac,ifndef PLATFORM\n&\nendif,' \
	-e '/MOZ_GNOMEUI_LIBS/d' -e 's,EXTRA_DSO_LDOPTS [+]=,EXTRA_DSO_LDOPTS =,' \
	-e '/rules.mk/,$s;OS_ARCH),Darwin;PLATFORM),mac;' -e '/LOCAL_INCLUDES/i\
ifdef MOZ_ENABLE_GNOMEUI\
EXTRA_DSO_LDOPTS += $(MOZ_GNOMEUI_LIBS) $(NULL)\
endif\
' mozilla/modules/libpr0n/decoders/icon/Makefile.in
 ### since they subverted at many places XP_MACOSX to mean a toolkit to be used ("cocoa" rather than eg gtk or qt),
 ### (instead of an OS), we zapped it, and so even in places where it is used properly we have to replace it ..
 sed -i.bak -e 's,XP_MACOSX,__APPLE__,' mozilla/toolkit/crashreporter/nsExceptionHandler.cpp \
	mozilla/xpcom/base/nsStackWalk.cpp mailnews/addrbook/public/nsAbBaseCID.h

### remove obsolete flags:
 sed -i'' -e 's, -fpascal-strings,,' -e 's, -no-cpp-precomp,,' mozilla/{configure.in,security/coreconf/Darwin.mk}
### The next appears (-ed??) needed eg when building yelp...                                
### maybe also in mozilla/xulrunner/installer/libxul{-unstable,}.pc.in ?
 sed -i.bak -e 's,lxpcom,& -lxpcom_core,' mozilla/build/unix/mozilla-config.in
### The following is "for safety",  to avoid "implicit declaration" warnings :
 sed -ri.bak -e 's,\(XP_OS2\) \&\& \!defined\(DARWIN\)$,\(XP_OS2\),' directory/c-sdk/ldap/libraries/liblber/lber-int.h

### formerly passed along by gtk's .pc :
 sed -i'' -e '/PKG_CHECK_MODULES(MOZ_GTK2,/a\
    MOZ_GTK2_LIBS="$MOZ_GTK2_LIBS -L/usr/X11R6/lib -lXrender -lX11"' mozilla/configure{.in,}

#### MISC
### libresolv
 # configure fails to detect libresolv (hence the 'env' before ./configure),
 # and even if it would detect it, it forgets to add -lresolv to LIBS  (Still true with seamonkey ??)
 # We put it as far as possible in the link line _ and just for the link that needs it, in order not to get
 # libresolv in the LOAD_COMMANDS everywhere :
 sed -ri.bak -e 's,^MODULE[[:space:]],OS_LIBS += -lresolv\n&,' mozilla/netwerk/build/Makefile.in
 sed -ri.bak -e '/MOZ_COMPONENT_LIBS/a \\t\t-lresolv \\' mozilla/extensions/auth/Makefile.in
### lXrender
 sed -ri.bak -e '$a EXTRA_DSO_LDOPTS += -lXrender' mozilla/gfx/thebes/src/Makefile.in
### allow enable-xul :
 sed -ri.bak -e '/alldep all::/a \\tmkdir -p dist/bin/XUL' mozilla/Makefile.in
 sed -ri -e 's, [^ ]*/bin/XUL,,' {,mozilla/}configure{.in,}
#  for XRE_GetFileFromPath and XRE_GetBinaryFromPath in xpcshell.cpp (why is libxul not in LIBXUL_LIBS ??) :
 sed -ri.bak -e '/NSPR_LIBS/a \\t\t-lxul \\' mozilla/js/src/xpconnect/shell/Makefile.in
### Non-portable use of sed (not even usable with GNU sed)
 sed -i.bak -e 's,sed -E,sed -r,' mozilla/xpcom/typelib/xpidl/Makefile.in
### link nspr with g++ when using --enable-cplus
 sed -ri.bak -e 's,cplus$,&\n\tMKSHLIB = \$(CCC) \$(DSO_LDOPTS) -o \$@,' mozilla/nsprpub/pr/src/Makefile.in

### create configure scripts _ autoconf2.13 needed, and fink has no corresponding automake, so autoreconf can't be used..
# for f in `find . -name configure.in`; do cd `sed -e 's,/[^/]*$,,'<<<"$f$"`; autoconf; cd -; done

### Uncomment to check builddeps:
 # perl -pi -e 's,CPPFLAGS%%,CPPFLAGS -H%%,' configure
<<

# --enable-extensions=all no longer suoported in 2.0beta, and  --enable-system-lcms  is broken _ they use a customised version (pretending same version number 1/17)!!!
# --enable-calendar no longer supported in 1.1a (http://www.mozilla.org/projects/calendar)
# also --enable-places ... (https://bugzilla.mozilla.org/show_bug.cgi?id=355040)
## can't enable static : "configure: error: Only one of --enable-shared or --enable-static must be specified."
## (and reluctant to impose 2 full builds on the user...)
# Adding --enable-javaxpcom doesn't work _  https://bugzilla.mozilla.org/show_bug.cgi?id=354004
# Also "--enable-boehm" leads to trouble...; probably not important (for a 'production' pkg): according to
# http://www.hpl.hp.com/personal/Hans_Boehm/gc/ , it is only used as a leak detector.
# --enable-libxul leads to "/bld/seamonkey-1.9.1b3pre-1/mozilla/dist/bin/XUL: No such file or directory" in linking
#  mozilla/xpfe/components/autocomplete/src/nsAutoComplete.o
ConfigureParams: <<
 --enable-macos-target=${MACOSX_DEPLOYMENT_TARGET} --enable-optimize=-Os --disable-debug --enable-strip --enable-tests --with-pthreads \
 --with-default-mozilla-five-home=%p/lib/%N-2 --mandir=%p/share/man --with-qtdir=%p --x-includes='' --x-libraries='' \
 --enable-application=suite --enable-default-toolkit=cairo-gtk2 --enable-cplus --enable-xul \
 --enable-image-decoders=all --enable-image-encoders=all --enable-necko-protocols=all \
 --enable-ctl --enable-canvas --enable-update-packaging --enable-storage --disable-profilesharing \
 --enable-xpctools --enable-url-classifier --enable-ipv6 --enable-ldap-experimental \
 --with-x --enable-xinerama --enable-xprint --enable-pango --enable-xft --enable-postscript \
 --enable-svg --enable-svg-renderer=cairo --enable-system-cairo --enable-glitz \
 --with-system-mng --with-system-jpeg --with-system-zlib --with-system-bz2 (%type_raw[sys_nspr] = .) --with-system-nspr \
 --enable-auto-deps --enable-md --disable-necko-wifi \
 --enable-update-channel=beta --disable-crashreporter
<<
###### Last line is for private use !
## disable-necko-wifi : mozilla/configure has 'elif test "$OS_ARCH" = "Darwin"; then  NECKO_WIFI=1'
## but mozilla/netwerk/wifi/src/nsWifiScannerUnix.cpp fails to find iwlib.h (new in 2.03)
#
##  --enable-system-sqlite , --enable-help-viewer , --enable-ipcd , --enable-oji ?
### With 2.0a :
# --disable-profilesharing : else missing headers
# "--with-system-png" : "configure: error: --with-system-png won't work because the system's libpng doesn't have APNG support"
## questionable in config/autoconf.mk :
# ACDEFINES: -DMOZ_XPINSTALL=1 -DMOZ_NO_XPCOM_OBSOLETE=1 -DMOZ_STATIC_MAIL_BUILD=1
# HOST_CFLAGS      =  -DXP_UNIX -DXP_MACOSX -DNO_X11  # Why NO_X11 ??
### Older stuff :
# no -fstrict-aliasing in '--enable-optimize', else "dereferencing type-punned pointer will break strict-aliasing rules" warnings
# --enable-single-profile : causes trouble: launch aborts (right after loading libXt and before loading components/libprofile)
# without any error msgs anywhere, nor crash log or anything...
##
# --with-system-nss ?
SetCC: gcc
NoSetLDFLAGS: true
SetLDFLAGS: -L%b/mozilla/dist/lib -L%b/mozilla/dist/bin -L%p/lib/pango-ft219/lib -L%p/lib/fontconfig2/lib
NoSetCPPFLAGS: true
SetCPPFLAGS: -I%p/lib/pango-ft219/include-pango-1.0 -I%p/lib/pango-ft219/include -I%p/include/freetype2 -I%p/lib/fontconfig2/include
CompileScript: <<
#!/bin/sh -ev
 if [ -e /usr/X11R6/include/X11/X.h ]; then
   Xdir="/usr/X11R6"
 elif [ -e /usr/X11/include/X11/X.h ]; then
   Xdir="/usr/X11"
 else
   echo "Could not determine X11 prefix"
   exit 1
 fi
 export PATH="%p/lib/fontconfig2/bin:$PATH"
 export PKG_CONFIG_PATH="%p/lib/fontconfig2/lib/pkgconfig:$PKG_CONFIG_PATH"
 export CPATH="%p/include/pango-1.0/pango:%p/include/pango-1.0:%p/include/freetype2:%p/lib/fontconfig2/include:%p/include:$Xdir/include"
 export LIBRARY_PATH="%b/mozilla/dist/lib:%b/mozilla/dist/bin:%p/lib/fontconfig2/lib:%p/lib:$Xdir/lib"
 env ac_cv_func_res_ninit=yes ./configure %c
 make -w
<<

InstallScript: <<
#!/bin/sh -ev
 if [ -e /usr/X11R6/include/X11/X.h ]; then
   Xdir="/usr/X11R6"
 elif [ -e /usr/X11/include/X11/X.h ]; then
   Xdir="/usr/X11"
 else
   echo "Could not determine X11 prefix"
   exit 1
 fi
export CPATH="%p/lib/pango-ft219/include-pango-1.0:%p/lib/pango-ft219/include:%p/include/freetype2:%p/lib/fontconfig2/include:%p/include:$Xdir/include"
export LIBRARY_PATH="%p/lib/pango-ft219/lib:%p/lib/fontconfig2/lib:%p/lib:$Xdir/lib"

make -j1 install DESTDIR=%d INSTALL_SDK=1

# rm or link duplicate files
pushd %i > /dev/null
rm -fR lib/%N-%type_raw[ver]/extensions/inspector@mozilla.org/platform/{OS2,WINNT}
cd share/idl/%N-%type_raw[ver]/stable; for f in *; do ln -fs ../unstable/$f; done; cd -
pushd include/%N-%type_raw[ver]/stable > /dev/null; for f in *.{h,api}; do ln -fs ../unstable/$f; done
for d in obsolete private; do cd $d; for f in *.h; do ln -fs ../../unstable/$f; done; cd -; done
cd md; for f in *.cfg; do ln -fs ../../unstable/$f; done; cd -
popd > /dev/null
ln -fs ../../include/%N-%type_raw[ver]/unstable/xpcom-config.h lib/%N-devel-%type_raw[ver]
ln -fs en-US/mailViews.dat lib/%N-%type_raw[ver]/defaults/messenger/mailViews.dat
# to be uncommented again when re-enabling crashreporter (in principle next time)
#ln -fs ../MainMenu.nib/classes.nib lib/%N-%type_raw[ver]/crashreporter.app/Contents/Resources/English.lproj/MainMenuRTL.nib
popd > /dev/null

## Fix install_names of plugins (were completely baroque, all in different ways)
V=`cut -f1 -d. <<<"%type_raw[ver]"`
cd %i/lib/%N-%type_raw[ver]/plugins
for f in *.dylib; do
	install_name_tool -id %p/lib/%N-$V/plugins/$f $f
done
cd -

## Make unversioned symlinks (more in dev splitoff):
ln -fs %N-%type_raw[ver] %i/lib/%N-$V

# Fix symlink in bin to main excutable (target was %N instead of %N-bin)
ln -fs ../lib/%N-$V/%N-bin %i/bin/%N

### FIXME : .pc files don't get built! (.pc.in are in mozilla/xulrunner/installer, + directory/c-sdk/mozldap.pc.in)
# Link .pc file (the other .pc files Require the name 'nspr',
# when using --with-system-nspr _ and nspr itself installs no .pc file
#if test "%type_raw[sys_nspr]" == "."
#	then ln -s %N-nspr.pc %i/lib/pkgconfig/nspr.pc
#fi

# Multi user setting ; needed ???
touch %i/lib/%N-%type_raw[ver]/chrome/user-skins.rdf
touch %i/lib/%N-%type_raw[ver]/chrome/user-locales.rdf

# Install fink specific files. (commenting out the chrome.d stuff; scheme seems different now .)
#install -d -m 755 %i/bin %i/sbin %i/var/lib/%N/chrome.d
# keep for the moment the file, but under the name moz
# in order not to conflict with mozilla, to compare with the original %i/bin/%N
install -c -m 755 fink/mozilla %i/bin/moz
#install -c -m 755 fink/update-%N-chrome %i/sbin
#install -c -m 644 fink/chrome.d/* %i/var/lib/%N/chrome.d/

# Move config file into %p/etc.  (any use ??  or harm ?)
install -d -m 755 %i/etc/%N
install -c -m 644 fink/prefs.js %i/etc/%N
ln -sf %p/etc/%N/prefs.js %i/lib/%N-%type_raw[ver]/defaults/pref/fink.js

# Install gnome .desktop files.
install -d -m 755 %i/share/applications
install -c -m 644 fink/applications/* %i/share/applications/

# Install desktop pixmaps (rather link now...  There are probably a couple of others to be linked..)
# Still only the main icon seems to show up in KDE's menus ...  Check...
install -d -m 755 %i/share/pixmaps
ln -fs %p/lib/%N-%type_raw[ver]/chrome/icons/default/%N.png %i/share/pixmaps/%N.png
ln -fs %p/lib/%N-%type_raw[ver]/chrome/icons/default/main-window.png %i/share/pixmaps/%N_main-window.png
ln -fs %p/lib/%N-%type_raw[ver]/chrome/icons/default/addressbookWindow.png %i/share/pixmaps/%N_addressbookWindow.png
#ln -fs %p/lib/%N-%type_raw[ver]/chrome/icons/default/chatzilla  chatzilla disappeared...
ln -fs %p/lib/%N-%type_raw[ver]/chrome/icons/default/editorWindow.png %i/share/pixmaps/%N_editorWindow.png
ln -fs %p/lib/%N-%type_raw[ver]/chrome/icons/default/msgcomposeWindow.png %i/share/pixmaps/%N_msgcomposeWindow.png
ln -fs %p/lib/%N-%type_raw[ver]/chrome/icons/default/messengerWindow.png %i/share/pixmaps/%N_mailnews.png
### And all others remain in ???
# ls -l %p/bld/mozilla-1.7.11-5/mozilla/dist/bin/chrome/icons/default
# total 140

# for compatiblity with firefox etc (if "--system-nspr" is enabled, file doesn't exist,
# and it is ugly to program by "cases"...)  _ anyway is no longer istalled in 2.0alpha : FIX... (some other too ?)
if test -f %i/share/aclocal/nspr.m4
   then mv %i/share/aclocal/nspr.m4 %i/share/aclocal/nspr-%N.m4
fi

# Install a symlink to the docfiles
mkdir -p %i/share/doc/%N2-shlibs
ln -s %N2-shlibs %i/share/doc/%n
mv %i/lib/%N-%type_raw[ver]/README %i/share/doc/%N2-shlibs
ln -fs %p/share/doc/%N2-shlibs/README %i/lib/%N-%type_raw[ver]
<<

ConfFiles: %p/etc/%N/prefs.js

SplitOff: <<
  Package: %N2-shlibs
  Depends: <<
	atk1-shlibs, cairo-shlibs (>= 1.6-1), dbus-shlibs, fontconfig2-shlibs, freetype219-shlibs, gconf2-shlibs,
	glib2-shlibs, gnome-vfs2-unified-shlibs (>= 1:2.20.0-1), gtk+2-shlibs (>= 2.12.0-1),
	libart2-shlibs, libbonobo2-shlibs, libbonoboui2-shlibs, libgettext8-shlibs, libgnome2-shlibs,
	libgnomecanvas2-shlibs, libgnomeui2-shlibs (>= 2.20.0-1), libjpeg8-shlibs,
	(%type_raw[sys_nspr] = .) nspr-shlibs,
	openssl098-shlibs, orbit2-shlibs, pango1-xft2-ft219-shlibs (>= 1.18.4-4), popt-shlibs, x11-shlibs
  <<
  DocFiles: mozilla/LEGAL mozilla/LICENSE
  Description: Seamonkey - shared libraries
## I see currently no reasonable way to list the bundles that can be linked from shlibs _ and those
## should probably for sanity be added here. Have some evidence that many of them in fact can...
## So, for the moment, put all of them here too...
## And let us add, for files, the subdirs  lib/%N/chrome, lib/%N/greprefs and lib/%N/res _ trusting Hanspeter ...
  Files: <<
	lib/%N-%type_raw[ver]/lib*.dylib
	lib/%N-%type_raw[ver]/chrome
	lib/%N-%type_raw[ver]/components
	lib/%N-%type_raw[ver]/greprefs
	lib/%N-%type_raw[ver]/plugins
	lib/%N-%type_raw[ver]/res
	lib/%N-?
	share/doc/%N2-shlibs
 <<
# The following depends strongly on %c. Adjust at the last minute.
# Here all shared libs are listed. One could probably consider those in plugins as meant to be internal
# (or even all those not in %p/lib/%N-2/sdk/lib ?), and omit them.
  Shlibs: <<
	%p/lib/%N-2/libfreebl3.dylib 1.0.0 %n (>= 1.0-1)
	%p/lib/%N-2/libgfxpsshar.dylib 1.0.0 %n (>= 1.0-1)
	%p/lib/%N-2/libgkgfx.dylib 1.0.0 %n (>= 1.0-1)
	%p/lib/%N-2/libgtkxtbin.dylib 1.0.0 %n (>= 1.0-1)
	%p/lib/%N-2/libjsj.dylib 1.0.0 %n (>= 1.0-1)
	%p/lib/%N-2/libldap60.dylib 1.0.0 %n (>= 1.0-1)
	%p/lib/%N-2/libldif60.dylib 1.0.0 %n (>= 1.0-1)
	%p/lib/%N-2/libmozjs.dylib 1.0.0 %n (>= 1.0-1)
	(%type_raw[sys_nspr] = no) %p/lib/%N-2/libnspr4.dylib 1.0.0 %n (>= 1.0-1)
	%p/lib/%N-2/libnss3.dylib 1.0.0 %n (>= 1.0-1)
	%p/lib/%N-2/libnssdbm3.dylib 1.0.0 %n (>= 1.0-1)
	%p/lib/seamonkey-2/libnssutil3.dylib 1.0.0 %n (>= 1.0-1)
	(%type_raw[sys_nspr] = no) %p/lib/%N-2/libplc4.dylib 1.0.0 %n (>= 1.0-1)
	(%type_raw[sys_nspr] = no) %p/lib/%N-2/libplds4.dylib 1.0.0 %n (>= 1.0-1)
	%p/lib/%N-2/libprldap60.dylib 1.0.0 %n (>= 1.0-1)
	%p/lib/%N-2/libsmime3.dylib 1.0.0 %n (>= 1.0-1)
	%p/lib/%N-2/libsoftokn3.dylib 1.0.0 %n (>= 1.0-1)
	%p/lib/%N-2/libsqlite3.dylib 1.0.0 %n (>= 1.0-1)
	%p/lib/%N-2/libssl3.dylib 1.0.0 %n (>= 1.0-1)
	%p/lib/%N-2/libthebes.dylib 1.0.0 %n (>= 1.0-1)
	%p/lib/%N-2/libxpcom.dylib 1.0.0 %n (>= 1.0-1)
	%p/lib/%N-2/libxpcom_core.dylib 1.0.0 %n (>= 1.0-1)
	%p/lib/%N-2/libxul.dylib 1.0.0 %n (>= 1.0-1)
	%p/lib/%N-2/plugins/libnptest.dylib 1.0.0 %n (>= 1.0-1)
	%p/lib/%N-2/plugins/libnullplugin.dylib 1.0.0 %n (>= 1.0-1)
	%p/lib/%N-2/plugins/libunixprintplugin.dylib 1.0.0 %n (>= 1.0-1)
  <<
#       %p/lib/%N-2/libmozlcms.dylib 1.0.0 %n (>= 1.0-1)
<<

SplitOff2: <<
  Package: %N2-dev
## Currently the symlink %p/lib/%N in this pkg would cause conflict with existing seamonkey. 
## Intend as an upgrade strategy to first put this out w/o this symlink,
## and then, as soon as dependent pkgs have switched their deps, introduce the symlink
## at the next new version.
#  Conflicts: %N-dev, %N-shlibs, librsvg2-%N, librsvg2-%N-dev, %N (<< 1.9.0-1)
  Conflicts: %N-dev
  Replaces: %N-dev
  Depends: %N2-shlibs (= %v-%r), pkgconfig (>= 0.21-1)
  BuildDependsOnly: true
  Description: Seamonkey - development headers and libraries
  InstallScript: <<
	#!/bin/sh -ev
	mkdir -p %i/lib %i/share/doc ; ln -s %N2-shlibs %i/share/doc/%n
	if test -d %I/share/aclocal
	  then mv %I/share/aclocal %i/share
	fi
	V=`cut -f1 -d. <<<"%type_raw[ver]"`
 # bring the whole %N-devel dir here, folding it into the main on _ and keep its name as a symlink
	mv %I/lib/%N-devel-%type_raw[ver] %i/lib/%N-%type_raw[ver]
	ln -fs %N-%type_raw[ver] %i/lib/%N-devel-%type_raw[ver]
	mv %I/include %i
	mv %I/share/idl %i/share
 # make some symlinks for gfxtypes.h
	ln -fs unstable/gfx_types.h %i/include/%N-%type_raw[ver]/gfxtypes.h
	ln -fs ../../unstable/gfx_types.h %i/include/%N-%type_raw[ver]/stable/obsolete/gfxtypes.h
	ln -fs gfx_types.idl %i/share/idl/%N-%type_raw[ver]/unstable/gfxtypes.idl
 # fold the contents of the sdk subdir back into the main one
	cd %i/lib/%N-%type_raw[ver]/sdk/lib
	for f in *.dylib; do ln -fs ../../$f; done
	for f in *.a; do mv $f ../..; ln -fs  ../../$f; done
 # make non-versioned symlinks
#	ln -fs %N-$V %i/lib/%N	#	This one only later, when current seamonkey is phased out 
	ln -fs %N-%type_raw[ver]/unstable %i/share/idl/%N-$V
	ln -fs %N-$V %i/share/idl/%N
	ln -fs %N-%type_raw[ver]/unstable %i/include/%N-$V
	ln -fs %N-$V %i/include/%N
	# the following symlinks correspond to ones in the %N-devel dir, which got folded in the main one
	cd %i/lib/%N-%type_raw[ver]
	rm -fR bin idl include lib
	ln -fs . bin
	ln -fs %p/share/idl/%N idl
	ln -fs %p/include/%N include
	ln -fs sdk/lib lib
	cd -
<<
# no -config and no .pc files
<<

Description: WWW, chat, mail, news, calendar, a-book, etc
DescDetail: <<
%N is an open-source web browser, designed for standards
compliance, performance and portability.
<<
DescUsage: <<
Dependent pkgs are probably assured of more stability w.r.t.
versions of %N if using only the subset in %p/lib/%N/sdk .
<<

DescPort: <<
GTK+2 build of the SeaMonkey browser for Mac OS X/X11.  Compiled
with built-in support for GNOME VFS2, including app launcher buttons.

The pkg is intentionally built "as enabled as possible" _ not only
because this was part of fink's original motto, but also because users
wanting a "skinny" version have other alternatives like firefox...

The whole shlibs stuff is gratuitous: anyway the src doesn't version shared libs for darwin...
Have no time now to patch that (it is not a single place to fix...)

Adding (in patchfile) %p/lib/%N/components to DYLD_LIBRARY_PATH _ else links with qt3's libeditor...
(then added also plugins and ipc/modules, by analogy).
Use same path in update-%N-chrome.

The maneuvering with flags is required by the update of cairo to 1.2.6,
which requires ft219 (and hence possibly the corresponding pango for consistency).

A bunch of warnings still to look at:
warning: invalid access to non-static data member '...' of NULL object

Also: %p/lib/lib/seamonkey/pango.modules is probably not properly installed _
  and anyway, what do those 2 modules add to the existing pango ones?
  If not (which I presume), is there a way to get seamonkey to use the existing ones,
  and to omit this part of build (related to --enable-ctl?), w/o losing any functionality ??

A couple of details:
   --enable-macos-target=10.4 (or: whatever tree it is put in) is needed because else
it set to 10.4 on intel and to some old value on powerpc.
   --enable-freetype2 became with the transition to seamonkey incompatible with --enable-xft;
the latter seems more appropriate for a pure gnome build.
   Some configureparams have no effect, and are still there for various reasons
	_ chiefly, "orthogonality" ; eg :
 -  "--with-qtdir=" would would presumably be useful only with qt as toolkit;
but this preserves orthogonality between specifications of locations and choices of toolkits
 - "--with-system-mng" is no longer useful since long _ but there was an intention at the
start of the seamonkey project to bring back the use of mng _ so let's leave it, till it is
clear this is abandoned.
 - a few configureparams may be introduced only in later snapshots or beta versions,
and be set here to the same values I use in (my private copy of) those
 - note finally that some configureparams (eg, --enable-cplus) appear and are documented
only in the configure scripts of subdirs.
<<
DescPackaging: <<
 After original packaging and porting of mozilla by msek
 Simpler _ even for user _ to have just %N, %N-dev and %N-shlibs
<<
License: OSI-Approved
Maintainer: The Gnome Core Team <fink-gnome-core@lists.sourceforge.net>
Homepage: http://www.mozilla.org/projects/seamonkey/
<<
