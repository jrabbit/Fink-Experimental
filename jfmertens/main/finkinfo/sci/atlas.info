Package: atlas
Version: 3.8.0
Revision: 5
Description: Portably optimal linear algebra software
DescDetail: <<
The current version provides a complete BLAS and LAPACK API.
For many operations, ATLAS achieves performance on par
with machine-specific tuned libraries.
Installs also LAPACK's docs and manpages.
Headers: cblas.h clapack.h, plus the atlas headers
Libraries installed:
liblapack.a		: The LAPACK routines provided by ATLAS,
			plus the rest of LAPACK from netlib.org.
libcblas_unthreaded.a	: The ANSI C interface to the BLAS.
libf77blas_unthreaded.a	: The Fortran77 interface to the BLAS.
libatlas.a		: The main ATLAS library,
			providing low-level routines for all interface libs.
  Plus on multiprocessor machines the threaded variants libptcblas.a and
libptf77blas.a.
  libcblas.a and libf77blas.a are symlinks pointing to the threaded versions
if available, else to the unthreaded versions.
  The dylibs for latlas lcblas lf77bas and llapack are also installed
<<
DescPort: <<
The optimized subset of LAPACK provided by ATLAS is merged
with the full LAPACK from http://www.netlib.org/lapack.
<<
DescUsage: <<
Order is important when linking! Use:
-L%p/lib -llapack -lcblas -lf77blas -latlas
<<
Source: mirror:sourceforge:math-atlas/%n%v.tar.bz2
Source-MD5: fd42a00f36243bf4815d035b226ec305
Source2: http://www.netlib.org/lapack/lapack-3.1.1.tgz
Source2-MD5: 00b21551a899bcfbaa7b8443e1faeef9
SourceDirectory: ATLAS
License: BSD
# since we're experimenting with building a dylib :
BuildDependsOnly: true
BuildDepends: gcc42, fink (>= 0.27.99)
## validator would like "fink (>= 0.27.99)", but then users complain.. Just trying to get past the validator..
Depends: gcc42-shlibs 
PatchScript: <<
#!/bin/sh -ev
# -ftree-loop-linear causes problems with xconfig.
# -fgcse-after-reload -fsched-interblock -freorder-blocks also _ though they're implied by -O3 !
## Try this : (no: archinfo_linux doesn't seem to be used)
#perl -pi -e 's,7455,7450,' ATLAS/CONFIG/src/backend/archinfo_linux.c
## Try this (doesn't come out well with /usr/bin/sed, which doesn't respect initial spacing, but OK anyway):
## Update according to http://www.cocoadev.com/index.pl?MacintoshModels (or any better source...)
## might be more reliable, once one knows one is in a Apple-ppc type machine, to call `machine` ..
## or else at least to solve the remaining unknown cases with that ...
sed -i.bak -e '/PPCG4/,/PPCG5/c\
            if (strstr(res, "7") || strstr(res, "8") || strstr(res, "9") || strstr(res, "11") || strstr(res, "12")) mach = PPCG5;\
            else if (strstr(res, "1,2") || strstr(res, "c3") || strstr(res, "c5")) mach = PPCG4;\
         }\
         else if (strstr(res, "PowerBook"))\
         {\
            if (strstr(res, "5") || strstr(res, "6") || strstr(res, "3,2") || strstr(res, "3,3") || strstr(res, "3,4")) mach = PPCG4;\
         }\
         else if (strstr(res, "RackMac"))\
         {\
            if (strstr(res, "3")) mach = PPCG5;\
            else mach = PPCG4;' \
	CONFIG/src/backend/archinfo_freebsd.c
cd ..; ln -s lapack-3.1.1 LAPACK
cd LAPACK
sed -e 's|g77|gfortran|g' < INSTALL/make.inc.LINUX > make.inc
perl -pi -e 's,\.\./\.\./blas\$\(PLAT\)\.a,%b/../bld/lib/libptf77blas.a %b/../bld/lib/libptcblas.a %b/../bld/lib/libatlas.a,' \
        make.inc
<<
CompileScript: <<
#!/bin/sh -ev
 if [ %m = 'i386' ]; then mflags="-mfpmath=sse -msse -msse2 -msse3 -m32"; iflags="-mfpmath=387"; else mflags=''; iflags=''; fi
 lflags="-O3 -fomit-frame-pointer -fgcse-sm -fgcse-las -ftree-loop-linear $mflags"
 iflags="-O3 -fomit-frame-pointer $iflags"
 cd ../LAPACK
 sed -i.bak -e "s;\(-funroll-all-loops\) -O3;\1 $lflags;" -e 's,^TIMER,\#TIMER,' -e '/INT_ETIME/s,^\# *,,' make.inc
 make lapacklib
# atlas 'forgets' scabs1 (not dcabs1 !), so we get it here..
 cd BLAS/SRC; make scabs1.o; cd -
 mkdir -p ../bld/lib
 ar cr ../bld/lib/libf77blas.a BLAS/SRC/scabs1.o; ar cr ../bld/lib/libptf77blas.a BLAS/SRC/scabs1.o
 cd ..
 ln -s %p/bin/gcc-4 gcc
 export PATH=`pwd`:$PATH
 cd bld
 ../ATLAS/configure -v 2 --prefix=%p --with-netlib-lapack=%b/../LAPACK/lapack_LINUX.a -b 32 -F ic "$iflags" -F if "$iflags"
 # m=`machine`; if test $m = ppc7400 -o $m = ppc7450 ; then \
 #	sed -i.bak -e 's,^\( *ARCH =\).*,\1 PPCG432AltiVec,' -e 's,ARCHDEFS =,& -DATL_AVgcc' Make.inc ; fi
 make
<<
InfoTest: <<
TestScript: <<
#!/bin/sh -ev
 cd ../LAPACK
 mv lapack_LINUX.a lapack_LINUX.a~; ln -s ../bld/lib/liblapack.a lapack_LINUX.a
 make lapack_testing blas_testing
 # to get timing uncluttered by compilation times, we'll repeat the tests at the end of the log:
 rm {BLAS,TESTING}/*.out
 cd ../bld
 make test pttest time
 cd ../LAPACK
 time { make blas_testing; cd TESTING; make ; }
# here: real 3m10.903s; user 2m55.622s; sys 0m15.570s  (average of 3)
<<
<<
InstallScript: <<
#!/bin/sh -ev
 mkdir -p %i/share/doc/%n/LAPACK
 cp doc/* README %i/share/doc/%n
 head -n29 bin/atlas_tee.c > %i/share/doc/%n/LICENSE
 cp -pPR ../LAPACK/manpages/{blas/,}man %i/share
 cp -pPR ../LAPACK/{html,COPYING,README} %i/share/doc/%n/LAPACK
 ln -s html/index.html %i/share/doc/%n/LAPACK
 cd ../bld/lib
 # Apparently on some machines some of the threaded libs are not made;
 # we first make atlas 'look the same' to all other pkgs, independently of the machine
 if test -f libptcblas.a
	then for C in c f77; do
		mv lib${C}blas.a lib${C}blas_unthreaded.a
		ln -s libpt${C}blas.a lib${C}blas.a
	     done
	else rm libptf77blas.a
	     for C in c f77; do ln -s lib${C}blas.a lib${C}blas_unthreaded.a; done
 fi
 # we now make shared libs (experimental); easier to just write the command here than to fix lib/Makefile ...
 # put this here to make sure it is after the testscript, else dylib might affect timings.
 # When linking with gfortran, he '-m' flag at the end is dirty trick to get around an "undefined symbol" for _MAIN__, from -lgfortranbegin;
 # _ it swallows the immediately following -lgfortranbegin in the command transmitted to /usr/bin/libtool ...
 # There are no undefined symbols w/o "from ..." in the resulting dylib.
 # Is it the -all_load flag that causes the symbol "_main" from libgfortranbegin.a to be loaded ?
 # In fact we link even lf77blas and llapack with gcc, adding explicitly -lgfortran,
 # because this removes from the load commands the unnecessary %p/lib/gcc4.2/lib/libgcc_s.1.dylib,
 # and also removes "-macosx_version_min 10.3" from the link line.
 ## In fact, this doesn't ! (maybe because we changed gcc to cc in the commands below ?
 ## only change I remember ..)  _ At worst we'll have to link with ld .. (as in the Makefile :) )
 ## let us first try once more with gcc instead of cc (though I'd prefer to use cc here, since it is the interface with other pkgs)
 flags="-dynamiclib -single_module -Wl,-x -dead_strip -all_load -install_name"
 if test `uname -r|sed -e 's,\..*,,'` -ge 9; then flags="-dead_strip_dylibs $flags"; fi
 gcc $flags %p/lib/libatlas.dylib -o libatlas.dylib libatlas.a
 gcc $flags %p/lib/libcblas.dylib -o libcblas.dylib libcblas.a libatlas.dylib
 gcc $flags %p/lib/libf77blas.dylib -o libf77blas.dylib libf77blas.a libatlas.dylib -L%p/lib/gcc4.2/lib -lgfortran
 gcc $flags %p/lib/liblapack.dylib -o liblapack.dylib liblapack.a libcblas.dylib libf77blas.dylib libatlas.dylib -L%p/lib/gcc4.2/lib -lgfortran
 #### the rest is optional _ no idea of a correct exported symbols list for libatlas...
 #### probably to be removed for a commit _ it gains an enormous decrease in the # of symbols exported by the lib,
 #### but size goes down only from ~ 2.8M to 2.3M
 nm -mfgu liblapack.dylib libcblas.dylib libf77blas.dylib|fgrep ' (from libatlas'|sed -e 's, (from .*,,' -e 's,.* ,,'|sort -u > lst
 install_name_tool -id %p/lib/libatlas_full.dylib libatlas.dylib
 mv libatlas.dylib libatlas_full.dylib
 cc $flags %p/lib/libatlas.dylib -o libatlas.dylib libatlas.a -exported_symbols_list lst
 cd ..
 make install DESTDIR=%i
 cp -pPR lib/*.{a,dylib} %i/lib
 rm %i/lib/libtstatlas.a
 find %i/lib -type f -name '*.a' -exec ranlib \{\} \;
 chmod -R a-x %i/lib
 chmod -R a+rX %i/share
<<
Shlibs: <<
!%p/lib/liblapack.dylib
!%p/lib/libcblas.dylib
!%p/lib/libf77blas.dylib
!%p/lib/libatlas.dylib
!%p/lib/libatlas_full.dylib
<<
SplitOff: <<
	Package: %N-doc
	Files: share/man share/doc/%N/LAPACK
	InstallScript: mkdir -p %i/share/doc; ln -s %N %i/share/doc/%n
<<
Homepage: http://math-atlas.sourceforge.net
Maintainer: Jeffrey Whitaker <jswhit@fastmail.fm>
