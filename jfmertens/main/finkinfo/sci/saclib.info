Info2: <<
Package: saclib%type_pkg[d]
Version: 2.2.0
Revision: 1
#Source: http://www.cs.usna.edu/~qepcad/INSTALL/%{Ni}%v.tar.gz
Source: http://www.cs.usna.edu/~wcbrown/%{Ni}%v.tar.gz
Source-MD5: 6fd2489018a0d163338a9dcd42f72e48
Type: d (boolean)
Conflicts: %{Ni}, %{Ni}d
Replaces: %{Ni}, %{Ni}d

PatchScript: <<
#!/bin/sh -ev
    rm -fR RCS
    sed -e '/Get architecture type/,/else/s,else,elsif ($uname =~ /Power|powerpc/)\n{\n\t$ptype = "ppc";\n}\n&,' \
	-e '/Get OS type/,/else/s,else,elsif ($uname =~ /Darwin/)\n{\n\t$ostype = "darwin";\n}\n&,' \
	-e '/Create sysdep.h$/a\
	$Endian = "/* Created by $saclib/bin/mksysdep.pl */\
#ifdef __APPLE__\
#include <machine/endian.h>\
#ifdef LITTLE_ENDIAN\
#define _LITTLE_ENDIAN_\
#undef _BIG_ENDIAN_\
#endif\
#ifdef BIG_ENDIAN\
#define _BIG_ENDIAN_\
#undef _LITTLE_ENDIAN_\
#endif\
#endif /* __APPLE__ */\
";' \
	-e '$i \
elsif ($ostype eq "darwin")\
{\
	print SYSDEP $Endian;\
	if($ptype eq "x86")\
	{\
		print SYSDEP "#define _X86_DARWIN_\\n";\
	}\
	elsif ($ptype eq "ppc")\
	{\
		print SYSDEP "#define _PPC_DARWIN_\\n";\
	}\
	system("bash -c \\"pushd >/dev/null $ENV{X%{Ni}X}/sysdep/darwin ; ./install %b ; popd >/dev/null\\"");\
}' < %a/%{Ni}.patch | sed -e "s,X%{Ni}X,'%{Ni}',"  > bin/mksysdep.pl 
## %a/%{Ni}.patch is the file "bin/mksysdep.pl~" from the official distribution
  cp -pPR sysdep/archive/generic sysdep/darwin
  cp -p sysdep/linuxX86/GC.c sysdep/darwin/src
  sed -i'' -e 's,generic,darwin,' sysdep/darwin/install
  rm sysdep/darwin/src/FAIL_varargs.c
  add_def="`grep -e BETA2 -e 'define LARGE' -e 'define SMALL' -e 'N[MLS]PRIME_' include/sacsys.h~|sed -e 's,$,\\\,'`"
  sed -i'' -e "/BETA1/a\
$add_def
" sysdep/darwin/include/sacsys.h 
  sed -i'' -e '/<malloc\.h>/d' src/IQR.c
  if [ "%type_pkg[d]" == "d" ]
     then sed -i'' -e 's,SACFLAG= ,"SACFLAG=-g" ,' sysdep/darwin/bin/mklib
     else
	## avoid "...will break strict-aliasing rules" warnings:
	sed -i'' -e 's;%{Ni}/lib/obj$;&\nmake CC=$CC "SACFLAG=-O3 -Wall -mdynamic-no-pic" EXTENSION=  MMAPFS.o MMPDDF.o MMPFBL.o;' \
		 -e 's,SACFLAG= ,"SACFLAG=-O3 -fstrict-aliasing -Wall -mdynamic-no-pic" ,' sysdep/darwin/bin/mklib
  fi
  sed -i'' -e 's,_X86_LINUX_,__APPLE__,' -e '/ieee754\.h/d' include/hfloats.h
<<
CompileScript: <<
  #!/bin/sh -ev
  export %{Ni}=%b
  mkdir -p lib/obj
  cd bin; ./sconf
<<
InstallScript: <<
  #!/bin/sh -ev
  mkdir -p %i/bin %i/lib %i/include %i/share/doc/%{Ni} %i/share/%{Ni}
  cp -p lib/%{Ni}.a %i/lib
  cp -p include/*.h %i/include
  cp -p doc/{,maint_guide/}*.dvi %i/share/doc/%{Ni}
  cp -p bin/sdesc %i/bin
  cp -p bin/{b2l,l2b}.awk doc/*.doc %i/share/%{Ni}
  sed -i'' -e 's,[$]%{Ni}/[bindoc]\{3\},%p/share/%{Ni},' %i/bin/sdesc
  chmod -R a+rX %i
  sed -e '/INSTALLATION/,/done\./d' < README > HELP
  sed -e '1,/Introduction/d' -e "/1\.2\./,/'mkmake'.$/d" -e '/^ *mk/d' < sysdep/darwin/README >> HELP
  sed -i'' -e 's,COPYRIGHT ,LICENSE ,' -e '/^sman/d' -e 's,%{Ni}/doc,%p/share/%{Ni},' -e 's,%{Ni}/bin,%p/bin,' \
	-e 's,scripts,script,' -e 's,headers,header,' -e 's,these,this,' -e 's,their,its,' HELP
<<
DocFiles: HELP LICENSE
Description: Computer algebra, specially on ordered fields
License: OSI-Approved
Homepage: http://www.cs.usna.edu/~qepcad/B/QEPCAD.html
Maintainer: JF Mertens <jfmertens@users.sourceforge.net>
<<
