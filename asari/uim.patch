diff -Naur uim-1.0.1/configure uim-1.0.1.fink/configure
--- uim-1.0.1/configure	2005-12-24 13:45:11.000000000 +0900
+++ uim-1.0.1.fink/configure	2006-03-16 05:47:16.000000000 +0900
@@ -465,7 +465,7 @@
 # include <unistd.h>
 #endif"
 
-ac_subst_vars='SHELL PATH_SEPARATOR PACKAGE_NAME PACKAGE_TARNAME PACKAGE_VERSION PACKAGE_STRING PACKAGE_BUGREPORT exec_prefix prefix program_transform_name bindir sbindir libexecdir datadir sysconfdir sharedstatedir localstatedir libdir includedir oldincludedir infodir mandir build_alias host_alias target_alias DEFS ECHO_C ECHO_N ECHO_T LIBS INSTALL_PROGRAM INSTALL_SCRIPT INSTALL_DATA CYGPATH_W PACKAGE VERSION ACLOCAL AUTOCONF AUTOMAKE AUTOHEADER MAKEINFO install_sh STRIP ac_ct_STRIP INSTALL_STRIP_PROGRAM mkdir_p AWK SET_MAKE am__leading_dot AMTAR am__tar am__untar CXX CXXFLAGS LDFLAGS CPPFLAGS ac_ct_CXX EXEEXT OBJEXT DEPDIR am__include am__quote AMDEP_TRUE AMDEP_FALSE AMDEPBACKSLASH CXXDEPMODE am__fastdepCXX_TRUE am__fastdepCXX_FALSE CC CFLAGS ac_ct_CC CCDEPMODE am__fastdepCC_TRUE am__fastdepCC_FALSE CPP LN_S build build_cpu build_vendor build_os host host_cpu host_vendor host_os EGREP ECHO AR ac_ct_AR RANLIB ac_ct_RANLIB CXXCPP F77 FFLAGS ac_ct_F77 LIBTOOL LIBICONV LTLIBICONV PKG_CONFIG ac_pt_PKG_CONFIG M17NLIB_CFLAGS M17NLIB_LIBS SCIM_CFLAGS SCIM_LIBS ANTHY_LIBS ANTHY_CFLAGS MANA PRIME_CFLAGS PRIME_LIBS X_CFLAGS X_PRE_LIBS X_LIBS X_EXTRA_LIBS XFT_CONFIG XFT_CFLAGS XFT_LIBS WITH_XFT_TRUE WITH_XFT_FALSE ALLOCA LIBOBJS NETLIBS GETTEXT_PACKAGE MKINSTALLDIRS USE_NLS MSGFMT GMSGFMT XGETTEXT MSGMERGE INTLLIBS LIBINTL LTLIBINTL POSUB uim_pixmapsdir GTK2_CFLAGS GTK2_LIBS GTK2_4_CFLAGS GTK2_4_LIBS GNOME2_CFLAGS GNOME2_LIBS APPLET_CFLAGS APPLET_LIBS FEP_LIBADD EMACS EMACSLOADPATH lispdir UIMEL_LISP_DIR DICT_CFLAGS DICT_LIBS EBLIB_LIBS LIBEDIT_LIBS M17NLIB_TRUE M17NLIB_FALSE SCIM_TRUE SCIM_FALSE ANTHY_TRUE ANTHY_FALSE CANNA_TRUE CANNA_FALSE MANA_TRUE MANA_FALSE PRIME_TRUE PRIME_FALSE SKK_TRUE SKK_FALSE GTK2_TRUE GTK2_FALSE GTK2_4_TRUE GTK2_4_FALSE DEFAULT_TOOLKIT_GTK_TRUE DEFAULT_TOOLKIT_GTK_FALSE DEFAULT_TOOLKIT_QT_TRUE DEFAULT_TOOLKIT_QT_FALSE GNOME2_TRUE GNOME2_FALSE APPLET_TRUE APPLET_FALSE UIM_FEP_TRUE UIM_FEP_FALSE UIM_EL_TRUE UIM_EL_FALSE XIM_TRUE XIM_FALSE DICT_TRUE DICT_FALSE EB_TRUE EB_FALSE LIBEDIT_TRUE LIBEDIT_FALSE DEBUG_TRUE DEBUG_FALSE COMPAT_SCM_TRUE COMPAT_SCM_FALSE NEED_SETENV_C_TRUE NEED_SETENV_C_FALSE NEED_STRSEP_C_TRUE NEED_STRSEP_C_FALSE INTLTOOL_DESKTOP_RULE INTLTOOL_DIRECTORY_RULE INTLTOOL_KEYS_RULE INTLTOOL_PROP_RULE INTLTOOL_OAF_RULE INTLTOOL_PONG_RULE INTLTOOL_SERVER_RULE INTLTOOL_SHEET_RULE INTLTOOL_SOUNDLIST_RULE INTLTOOL_UI_RULE INTLTOOL_XAM_RULE INTLTOOL_KBD_RULE INTLTOOL_XML_RULE INTLTOOL_XML_NOMERGE_RULE INTLTOOL_CAVES_RULE INTLTOOL_SCHEMAS_RULE INTLTOOL_THEME_RULE INTLTOOL_EXTRACT INTLTOOL_MERGE INTLTOOL_UPDATE INTLTOOL_PERL INTLTOOL_ICONV INTLTOOL_MSGFMT INTLTOOL_MSGMERGE INTLTOOL_XGETTEXT GTK_BINARY_VERSION HOST_MOC HOST_UIC QT_PLUGINSDIR MOC UIC UIM_QT_CXXFLAGS UIM_QT_LDFLAGS QT_TRUE QT_FALSE QT_IMMODULE_TRUE QT_IMMODULE_FALSE INCLUDES SRCDIR LTLIBOBJS'
+ac_subst_vars='SHELL PATH_SEPARATOR PACKAGE_NAME PACKAGE_TARNAME PACKAGE_VERSION PACKAGE_STRING PACKAGE_BUGREPORT exec_prefix prefix program_transform_name bindir sbindir libexecdir datadir sysconfdir sharedstatedir localstatedir libdir includedir oldincludedir infodir mandir build_alias host_alias target_alias DEFS ECHO_C ECHO_N ECHO_T LIBS INSTALL_PROGRAM INSTALL_SCRIPT INSTALL_DATA CYGPATH_W PACKAGE VERSION ACLOCAL AUTOCONF AUTOMAKE AUTOHEADER MAKEINFO install_sh STRIP ac_ct_STRIP INSTALL_STRIP_PROGRAM mkdir_p AWK SET_MAKE am__leading_dot AMTAR am__tar am__untar CXX CXXFLAGS LDFLAGS CPPFLAGS ac_ct_CXX EXEEXT OBJEXT DEPDIR am__include am__quote AMDEP_TRUE AMDEP_FALSE AMDEPBACKSLASH CXXDEPMODE am__fastdepCXX_TRUE am__fastdepCXX_FALSE CC CFLAGS ac_ct_CC CCDEPMODE am__fastdepCC_TRUE am__fastdepCC_FALSE CPP LN_S build build_cpu build_vendor build_os host host_cpu host_vendor host_os EGREP ECHO AR ac_ct_AR RANLIB ac_ct_RANLIB CXXCPP F77 FFLAGS ac_ct_F77 LIBTOOL LIBICONV LTLIBICONV PKG_CONFIG ac_pt_PKG_CONFIG M17NLIB_CFLAGS M17NLIB_LIBS SCIM_CFLAGS SCIM_LIBS ANTHY_LIBS ANTHY_CFLAGS MANA PRIME_CFLAGS PRIME_LIBS X_CFLAGS X_PRE_LIBS X_LIBS X_EXTRA_LIBS XFT_CONFIG XFT_CFLAGS XFT_LIBS WITH_XFT_TRUE WITH_XFT_FALSE CARBON_FRAMEWORK ALLOCA LIBOBJS NETLIBS GETTEXT_PACKAGE MKINSTALLDIRS USE_NLS MSGFMT GMSGFMT XGETTEXT MSGMERGE INTLLIBS LIBINTL LTLIBINTL POSUB uim_pixmapsdir GTK2_CFLAGS GTK2_LIBS GTK2_4_CFLAGS GTK2_4_LIBS GNOME2_CFLAGS GNOME2_LIBS APPLET_CFLAGS APPLET_LIBS FEP_LIBADD EMACS EMACSLOADPATH lispdir UIMEL_LISP_DIR DICT_CFLAGS DICT_LIBS EBLIB_LIBS LIBEDIT_LIBS M17NLIB_TRUE M17NLIB_FALSE SCIM_TRUE SCIM_FALSE ANTHY_TRUE ANTHY_FALSE CANNA_TRUE CANNA_FALSE MANA_TRUE MANA_FALSE PRIME_TRUE PRIME_FALSE SKK_TRUE SKK_FALSE GTK2_TRUE GTK2_FALSE GTK2_4_TRUE GTK2_4_FALSE DEFAULT_TOOLKIT_GTK_TRUE DEFAULT_TOOLKIT_GTK_FALSE DEFAULT_TOOLKIT_QT_TRUE DEFAULT_TOOLKIT_QT_FALSE GNOME2_TRUE GNOME2_FALSE APPLET_TRUE APPLET_FALSE UIM_FEP_TRUE UIM_FEP_FALSE UIM_EL_TRUE UIM_EL_FALSE XIM_TRUE XIM_FALSE DICT_TRUE DICT_FALSE EB_TRUE EB_FALSE LIBEDIT_TRUE LIBEDIT_FALSE DEBUG_TRUE DEBUG_FALSE COMPAT_SCM_TRUE COMPAT_SCM_FALSE NEED_SETENV_C_TRUE NEED_SETENV_C_FALSE NEED_STRSEP_C_TRUE NEED_STRSEP_C_FALSE INTLTOOL_DESKTOP_RULE INTLTOOL_DIRECTORY_RULE INTLTOOL_KEYS_RULE INTLTOOL_PROP_RULE INTLTOOL_OAF_RULE INTLTOOL_PONG_RULE INTLTOOL_SERVER_RULE INTLTOOL_SHEET_RULE INTLTOOL_SOUNDLIST_RULE INTLTOOL_UI_RULE INTLTOOL_XAM_RULE INTLTOOL_KBD_RULE INTLTOOL_XML_RULE INTLTOOL_XML_NOMERGE_RULE INTLTOOL_CAVES_RULE INTLTOOL_SCHEMAS_RULE INTLTOOL_THEME_RULE INTLTOOL_EXTRACT INTLTOOL_MERGE INTLTOOL_UPDATE INTLTOOL_PERL INTLTOOL_ICONV INTLTOOL_MSGFMT INTLTOOL_MSGMERGE INTLTOOL_XGETTEXT GTK_BINARY_VERSION HOST_MOC HOST_UIC QT_PLUGINSDIR MOC UIC UIM_QT_CXXFLAGS UIM_QT_LDFLAGS QT_TRUE QT_FALSE QT_IMMODULE_TRUE QT_IMMODULE_FALSE INCLUDES SRCDIR LTLIBOBJS'
 ac_subst_files=''
 
 # Initialize some variables set by options.
@@ -23768,6 +23768,167 @@
   fi
 
 
+# Mac OS X check
+
+for ac_header in Carbon/Carbon.h
+do
+as_ac_Header=`echo "ac_cv_header_$ac_header" | $as_tr_sh`
+if eval "test \"\${$as_ac_Header+set}\" = set"; then
+  echo "$as_me:$LINENO: checking for $ac_header" >&5
+echo $ECHO_N "checking for $ac_header... $ECHO_C" >&6
+if eval "test \"\${$as_ac_Header+set}\" = set"; then
+  echo $ECHO_N "(cached) $ECHO_C" >&6
+fi
+echo "$as_me:$LINENO: result: `eval echo '${'$as_ac_Header'}'`" >&5
+echo "${ECHO_T}`eval echo '${'$as_ac_Header'}'`" >&6
+else
+  # Is the header compilable?
+echo "$as_me:$LINENO: checking $ac_header usability" >&5
+echo $ECHO_N "checking $ac_header usability... $ECHO_C" >&6
+cat >conftest.$ac_ext <<_ACEOF
+/* confdefs.h.  */
+_ACEOF
+cat confdefs.h >>conftest.$ac_ext
+cat >>conftest.$ac_ext <<_ACEOF
+/* end confdefs.h.  */
+$ac_includes_default
+#include <$ac_header>
+_ACEOF
+rm -f conftest.$ac_objext
+if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
+  (eval $ac_compile) 2>conftest.er1
+  ac_status=$?
+  grep -v '^ *+' conftest.er1 >conftest.err
+  rm -f conftest.er1
+  cat conftest.err >&5
+  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); } &&
+	 { ac_try='test -z "$ac_c_werror_flag"
+			 || test ! -s conftest.err'
+  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
+  (eval $ac_try) 2>&5
+  ac_status=$?
+  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); }; } &&
+	 { ac_try='test -s conftest.$ac_objext'
+  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
+  (eval $ac_try) 2>&5
+  ac_status=$?
+  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); }; }; then
+  ac_header_compiler=yes
+else
+  echo "$as_me: failed program was:" >&5
+sed 's/^/| /' conftest.$ac_ext >&5
+
+ac_header_compiler=no
+fi
+rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+echo "$as_me:$LINENO: result: $ac_header_compiler" >&5
+echo "${ECHO_T}$ac_header_compiler" >&6
+
+# Is the header present?
+echo "$as_me:$LINENO: checking $ac_header presence" >&5
+echo $ECHO_N "checking $ac_header presence... $ECHO_C" >&6
+cat >conftest.$ac_ext <<_ACEOF
+/* confdefs.h.  */
+_ACEOF
+cat confdefs.h >>conftest.$ac_ext
+cat >>conftest.$ac_ext <<_ACEOF
+/* end confdefs.h.  */
+#include <$ac_header>
+_ACEOF
+if { (eval echo "$as_me:$LINENO: \"$ac_cpp conftest.$ac_ext\"") >&5
+  (eval $ac_cpp conftest.$ac_ext) 2>conftest.er1
+  ac_status=$?
+  grep -v '^ *+' conftest.er1 >conftest.err
+  rm -f conftest.er1
+  cat conftest.err >&5
+  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); } >/dev/null; then
+  if test -s conftest.err; then
+    ac_cpp_err=$ac_c_preproc_warn_flag
+    ac_cpp_err=$ac_cpp_err$ac_c_werror_flag
+  else
+    ac_cpp_err=
+  fi
+else
+  ac_cpp_err=yes
+fi
+if test -z "$ac_cpp_err"; then
+  ac_header_preproc=yes
+else
+  echo "$as_me: failed program was:" >&5
+sed 's/^/| /' conftest.$ac_ext >&5
+
+  ac_header_preproc=no
+fi
+rm -f conftest.err conftest.$ac_ext
+echo "$as_me:$LINENO: result: $ac_header_preproc" >&5
+echo "${ECHO_T}$ac_header_preproc" >&6
+
+# So?  What about this header?
+case $ac_header_compiler:$ac_header_preproc:$ac_c_preproc_warn_flag in
+  yes:no: )
+    { echo "$as_me:$LINENO: WARNING: $ac_header: accepted by the compiler, rejected by the preprocessor!" >&5
+echo "$as_me: WARNING: $ac_header: accepted by the compiler, rejected by the preprocessor!" >&2;}
+    { echo "$as_me:$LINENO: WARNING: $ac_header: proceeding with the compiler's result" >&5
+echo "$as_me: WARNING: $ac_header: proceeding with the compiler's result" >&2;}
+    ac_header_preproc=yes
+    ;;
+  no:yes:* )
+    { echo "$as_me:$LINENO: WARNING: $ac_header: present but cannot be compiled" >&5
+echo "$as_me: WARNING: $ac_header: present but cannot be compiled" >&2;}
+    { echo "$as_me:$LINENO: WARNING: $ac_header:     check for missing prerequisite headers?" >&5
+echo "$as_me: WARNING: $ac_header:     check for missing prerequisite headers?" >&2;}
+    { echo "$as_me:$LINENO: WARNING: $ac_header: see the Autoconf documentation" >&5
+echo "$as_me: WARNING: $ac_header: see the Autoconf documentation" >&2;}
+    { echo "$as_me:$LINENO: WARNING: $ac_header:     section \"Present But Cannot Be Compiled\"" >&5
+echo "$as_me: WARNING: $ac_header:     section \"Present But Cannot Be Compiled\"" >&2;}
+    { echo "$as_me:$LINENO: WARNING: $ac_header: proceeding with the preprocessor's result" >&5
+echo "$as_me: WARNING: $ac_header: proceeding with the preprocessor's result" >&2;}
+    { echo "$as_me:$LINENO: WARNING: $ac_header: in the future, the compiler will take precedence" >&5
+echo "$as_me: WARNING: $ac_header: in the future, the compiler will take precedence" >&2;}
+    (
+      cat <<\_ASBOX
+## ---------------------------------------- ##
+## Report this to uim@lists.freedesktop.org ##
+## ---------------------------------------- ##
+_ASBOX
+    ) |
+      sed "s/^/$as_me: WARNING:     /" >&2
+    ;;
+esac
+echo "$as_me:$LINENO: checking for $ac_header" >&5
+echo $ECHO_N "checking for $ac_header... $ECHO_C" >&6
+if eval "test \"\${$as_ac_Header+set}\" = set"; then
+  echo $ECHO_N "(cached) $ECHO_C" >&6
+else
+  eval "$as_ac_Header=\$ac_header_preproc"
+fi
+echo "$as_me:$LINENO: result: `eval echo '${'$as_ac_Header'}'`" >&5
+echo "${ECHO_T}`eval echo '${'$as_ac_Header'}'`" >&6
+
+fi
+if test `eval echo '${'$as_ac_Header'}'` = yes; then
+  cat >>confdefs.h <<_ACEOF
+#define `echo "HAVE_$ac_header" | $as_tr_cpp` 1
+_ACEOF
+
+fi
+
+done
+
+if test $ac_cv_header_Carbon_Carbon_h = yes; then
+  CARBON_FRAMEWORK="-framework Carbon"
+
+cat >>confdefs.h <<\_ACEOF
+#define USE_CURSOR_GEOMETRY_IN_IM 1
+_ACEOF
+
+fi
+
+
 # Checks for header files.
 # The Ultrix 4.2 mips builtin alloca declared by alloca.h only works
 # for constant arguments.  Useless!
@@ -33978,6 +34139,7 @@
 s,@XFT_LIBS@,$XFT_LIBS,;t t
 s,@WITH_XFT_TRUE@,$WITH_XFT_TRUE,;t t
 s,@WITH_XFT_FALSE@,$WITH_XFT_FALSE,;t t
+s,@CARBON_FRAMEWORK@,$CARBON_FRAMEWORK,;t t
 s,@ALLOCA@,$ALLOCA,;t t
 s,@LIBOBJS@,$LIBOBJS,;t t
 s,@NETLIBS@,$NETLIBS,;t t
diff -Naur uim-1.0.1/configure.ac uim-1.0.1.fink/configure.ac
--- uim-1.0.1/configure.ac	2005-12-24 13:41:55.000000000 +0900
+++ uim-1.0.1.fink/configure.ac	2006-03-16 05:47:16.000000000 +0900
@@ -208,6 +208,14 @@
 # for uim-fep
 AM_LANGINFO_CODESET
 
+# Mac OS X check
+AC_CHECK_HEADERS(Carbon/Carbon.h)
+if test $ac_cv_header_Carbon_Carbon_h = yes; then
+  CARBON_FRAMEWORK="-framework Carbon"
+  AC_DEFINE(USE_CURSOR_GEOMETRY_IN_IM, 1, [use cursor geometry info in IM])
+fi
+AC_SUBST(CARBON_FRAMEWORK)
+
 # Checks for header files.
 AC_FUNC_ALLOCA
 AC_HEADER_STDC
diff -Naur uim-1.0.1/gtk/Makefile.am uim-1.0.1.fink/gtk/Makefile.am
--- uim-1.0.1/gtk/Makefile.am	2005-12-07 21:39:19.000000000 +0900
+++ uim-1.0.1.fink/gtk/Makefile.am	2006-03-16 05:47:16.000000000 +0900
@@ -11,7 +11,7 @@
 
 
 im_uim_la_SOURCES = $(IM_UIM_SOURCES)
-im_uim_la_LDFLAGS = -module -avoid-version @GTK2_LIBS@
+im_uim_la_LDFLAGS = -module -avoid-version @GTK2_LIBS@ @CARBON_FRAMEWORK@
 im_uim_la_LIBADD = $(top_builddir)/uim/libuim.la $(EBLIB_LIBS)
 
 
diff -Naur uim-1.0.1/gtk/Makefile.in uim-1.0.1.fink/gtk/Makefile.in
--- uim-1.0.1/gtk/Makefile.in	2005-12-24 13:44:48.000000000 +0900
+++ uim-1.0.1.fink/gtk/Makefile.in	2006-03-16 05:47:16.000000000 +0900
@@ -120,6 +120,7 @@
 AWK = @AWK@
 CANNA_FALSE = @CANNA_FALSE@
 CANNA_TRUE = @CANNA_TRUE@
+CARBON_FRAMEWORK = @CARBON_FRAMEWORK@
 CC = @CC@
 CCDEPMODE = @CCDEPMODE@
 CFLAGS = @CFLAGS@
@@ -342,7 +343,7 @@
 @GTK2_TRUE@im_uim_la_CFLAGS = @GTK2_CFLAGS@ -Wall
 @GTK2_TRUE@module_LTLIBRARIES = $(im_uim_la)
 @GTK2_TRUE@im_uim_la_SOURCES = $(IM_UIM_SOURCES)
-@GTK2_TRUE@im_uim_la_LDFLAGS = -module -avoid-version @GTK2_LIBS@
+@GTK2_TRUE@im_uim_la_LDFLAGS = -module -avoid-version @GTK2_LIBS@ @CARBON_FRAMEWORK@
 @GTK2_TRUE@im_uim_la_LIBADD = $(top_builddir)/uim/libuim.la $(EBLIB_LIBS)
 @GTK2_TRUE@IM_UIM_SOURCES = gtk-im-uim.c uim-cand-win-gtk.c \
 @GTK2_TRUE@	uim-cand-win-gtk.h caret-state-indicator.c \
diff -Naur uim-1.0.1/gtk/gtk-im-uim.c uim-1.0.1.fink/gtk/gtk-im-uim.c
--- uim-1.0.1/gtk/gtk-im-uim.c	2005-12-23 13:18:05.000000000 +0900
+++ uim-1.0.1.fink/gtk/gtk-im-uim.c	2006-03-16 05:47:16.000000000 +0900
@@ -55,6 +55,12 @@
 #include "uim-cand-win-gtk.h"
 #include "caret-state-indicator.h"
 
+#ifdef HAVE_CARBON_CARBON_H
+#define Cursor CarbonCursor
+#include <Carbon/Carbon.h>
+#undef Cursor
+#endif
+
 /* exported symbols */
 GtkIMContext *im_module_create(const gchar *context_id);
 void im_module_list(const GtkIMContextInfo ***contexts, int *n_contexts);
@@ -67,6 +73,9 @@
 static int im_uim_fd = -1;
 static unsigned int read_tag;
 static guint snooper_id;
+#ifdef HAVE_CARBON_CARBON_H
+static guint carbon_event_tag;
+#endif
 
 struct preedit_segment {
   int attr;
@@ -982,6 +991,19 @@
   }
 }
 
+#ifdef USE_CURSOR_GEOMETRY_IN_IM
+static void
+cursor_geometry_cb(void *ptr, int *v, int *h)
+{
+  IMUIMContext *uic = (IMUIMContext *)ptr;
+  gint x, y;
+
+  gdk_window_get_origin(uic->win, &x, &y);
+  *v = y + uic->preedit_pos.y + uic->preedit_pos.height;
+  *h = x + uic->preedit_pos.x;
+}
+#endif
+
 GtkIMContext *
 im_module_create(const gchar *context_id)
 {
@@ -1011,6 +1033,9 @@
   uim_set_prop_label_update_cb(uic->uc, update_prop_label_cb);
   uim_set_candidate_selector_cb(uic->uc, cand_activate_cb, cand_select_cb,
 				cand_shift_page_cb, cand_deactivate_cb);
+#ifdef USE_CURSOR_GEOMETRY_IN_IM
+  uim_set_cursor_geometry_cb(uic->uc, cursor_geometry_cb);
+#endif
 
   uim_prop_list_update(uic->uc);
 
@@ -1162,6 +1187,23 @@
   return FALSE;
 }
 
+#ifdef HAVE_CARBON_CARBON_H
+static gboolean
+handle_carbon_event()
+{
+    EventTargetRef target;
+    EventRef event;
+
+    target = GetEventDispatcherTarget();
+    while (ReceiveNextEvent(0, NULL, kEventDurationNoWait, true, &event) == noErr) {
+        SendEventToEventTarget(event, target);
+        ReleaseEvent(event);
+    }
+
+    return TRUE;
+}
+#endif
+
 void
 im_module_init(GTypeModule *type_module)
 {
@@ -1177,6 +1219,9 @@
   /* XXX:This is not recommended way!! */
   snooper_id = gtk_key_snooper_install((GtkKeySnoopFunc)uim_key_snoop, NULL );
   snooper_installed = TRUE;
+#ifdef HAVE_CARBON_CARBON_H
+  carbon_event_tag = g_timeout_add(1000, handle_carbon_event, NULL);
+#endif
 }
 
 void
@@ -1187,4 +1232,7 @@
 
   gtk_key_snooper_remove(snooper_id);
   uim_quit();
+#ifdef HAVE_CARBON_CARBON_H
+  g_source_remove(carbon_event_tag);
+#endif
 }
diff -Naur uim-1.0.1/uim/config.h.in uim-1.0.1.fink/uim/config.h.in
--- uim-1.0.1/uim/config.h.in	2005-12-24 13:47:21.000000000 +0900
+++ uim-1.0.1.fink/uim/config.h.in	2006-03-16 05:47:16.000000000 +0900
@@ -43,6 +43,9 @@
 /* Define to 1 if you have the <canna/RK.h> header file. */
 #undef HAVE_CANNA_RK_H
 
+/* Define to 1 if you have the <Carbon/Carbon.h> header file. */
+#undef HAVE_CARBON_CARBON_H
+
 /* Define to 1 if you have the `cfmakeraw' function. */
 #undef HAVE_CFMAKERAW
 
@@ -322,6 +325,9 @@
 /* pixmaps directory */
 #undef UIM_PIXMAPSDIR
 
+/* use cursor geometry info in IM */
+#undef USE_CURSOR_GEOMETRY_IN_IM
+
 /* use gtk2 */
 #undef USE_GTK2
 
diff -Naur uim-1.0.1/uim/uim-func.c uim-1.0.1.fink/uim/uim-func.c
--- uim-1.0.1/uim/uim-func.c	2005-12-07 21:39:32.000000000 +0900
+++ uim-1.0.1.fink/uim/uim-func.c	2006-03-16 05:47:16.000000000 +0900
@@ -735,6 +735,20 @@
   return uim_scm_t();
 }
 
+#ifdef USE_CURSOR_GEOMETRY_IN_IM
+static uim_lisp
+im_request_cursor_geometry(uim_lisp id_)
+{
+  int v, h;
+  uim_context uc = retrieve_uim_context(id_);
+  if (uc->cursor_geometry_cb) {
+    uc->cursor_geometry_cb(uc->ptr, &v, &h);
+    return uim_scm_cons(uim_scm_make_int(v), uim_scm_make_int(h));
+  }
+  return uim_scm_f();
+}
+#endif
+
 void
 uim_init_im_subrs(void)
 {
@@ -771,4 +785,7 @@
   uim_scm_init_subr_3("im-delete-surrounding", im_delete_surrounding);
   /**/
   uim_scm_init_subr_2("uim-switch-im", switch_im); /* FIXME: This function name would not be appropriate. */
+#ifdef USE_CURSOR_GEOMETRY_IN_IM
+  uim_scm_init_subr_1("im-request-cursor-geometry", im_request_cursor_geometry);
+#endif
 }
diff -Naur uim-1.0.1/uim/uim-internal.h uim-1.0.1.fink/uim/uim-internal.h
--- uim-1.0.1/uim/uim-internal.h	2005-12-07 21:39:32.000000000 +0900
+++ uim-1.0.1.fink/uim/uim-internal.h	2006-03-16 05:47:16.000000000 +0900
@@ -116,6 +116,10 @@
   int (*delete_surrounding_text_cb)(void *ptr, int offset, int len);
   /* configuration changed */
   void (*configuration_changed_cb)(void *ptr);
+#ifdef USE_CURSOR_GEOMETRY_IN_IM
+  /* cursor geometry */
+  void (*cursor_geometry_cb)(void *ptr, int *v, int *h);
+#endif
   /* preedit segments array */
   struct preedit_segment *psegs;
   int nr_psegs;
diff -Naur uim-1.0.1/uim/uim.c uim-1.0.1.fink/uim/uim.c
--- uim-1.0.1/uim/uim.c	2005-12-07 21:39:32.000000000 +0900
+++ uim-1.0.1.fink/uim/uim.c	2006-03-16 05:47:16.000000000 +0900
@@ -162,6 +162,9 @@
   uc->delete_surrounding_text_cb = NULL;
   /**/
   uc->configuration_changed_cb = NULL;
+#ifdef USE_CURSOR_GEOMETRY_IN_IM
+  uc->cursor_geometry_cb = NULL;
+#endif
   /**/
   uc->nr_candidates = 0;
   uc->candidate_index = 0;
@@ -212,6 +215,15 @@
   uc->configuration_changed_cb = changed_cb;
 }
 
+#ifdef USE_CURSOR_GEOMETRY_IN_IM
+void
+uim_set_cursor_geometry_cb(uim_context uc,
+		void (*cursor_geometry_cb)(void *ptr, int *v, int *h))
+{
+  uc->cursor_geometry_cb = cursor_geometry_cb;
+}
+#endif
+
 void
 uim_switch_im(uim_context uc, const char *engine)
 {
diff -Naur uim-1.0.1/uim/uim.h uim-1.0.1.fink/uim/uim.h
--- uim-1.0.1/uim/uim.h	2005-12-07 21:39:32.000000000 +0900
+++ uim-1.0.1.fink/uim/uim.h	2006-03-16 05:47:16.000000000 +0900
@@ -558,6 +558,22 @@
 uim_set_configuration_changed_cb(uim_context uc,
 				 void (*changed_cb)(void *ptr));
 
+#ifdef USE_CURSOR_GEOMETRY_IN_IM
+/*
+ * Set callback function to be called when information on cursor
+ * geometry is required.
+ *
+ * @param uc input context
+ * @param cursor_geometry_cb called when cursor geometry is required.
+ *        1st argument "ptr" corresponds to the 1st argument of uim_create_context.
+ *        2nd argument "v" is vertical coordinate of the cursor point.
+ *        3rd argument "h" is horizontal coordinate of the cursor point.
+ */
+void
+uim_set_cursor_geometry_cb(uim_context uc,
+				 void (*cursor_geometry_cb)(void *ptr, int *v, int *h));
+#endif
+
 /* Utility functions */
 int
 uim_ipc_open_command(int old_pid, FILE **read_handler, FILE **write_handler, const char *command);
diff -Naur uim-1.0.1/xim/Makefile.am uim-1.0.1.fink/xim/Makefile.am
--- uim-1.0.1/xim/Makefile.am	2005-12-07 21:39:33.000000000 +0900
+++ uim-1.0.1.fink/xim/Makefile.am	2006-03-16 05:47:16.000000000 +0900
@@ -3,7 +3,7 @@
 if XIM
 
 bin_PROGRAMS = uim-xim
-uim_xim_LDFLAGS =  @X_LIBS@
+uim_xim_LDFLAGS =  @X_LIBS@ @CARBON_FRAMEWORK@
 uim_xim_LDADD =  -lXext -lX11 $(top_builddir)/uim/libuim.la
 uim_xim_CPPFLAGS = -I$(top_srcdir)
 uim_xim_CFLAGS = @X_CFLAGS@ -Wall
diff -Naur uim-1.0.1/xim/Makefile.in uim-1.0.1.fink/xim/Makefile.in
--- uim-1.0.1/xim/Makefile.in	2005-12-24 13:45:03.000000000 +0900
+++ uim-1.0.1.fink/xim/Makefile.in	2006-03-16 05:47:16.000000000 +0900
@@ -127,6 +127,7 @@
 AWK = @AWK@
 CANNA_FALSE = @CANNA_FALSE@
 CANNA_TRUE = @CANNA_TRUE@
+CARBON_FRAMEWORK = @CARBON_FRAMEWORK@
 CC = @CC@
 CCDEPMODE = @CCDEPMODE@
 CFLAGS = @CFLAGS@
@@ -342,7 +343,7 @@
 target_alias = @target_alias@
 uim_pixmapsdir = @uim_pixmapsdir@
 EXTRA_DIST = uim-xim.1
-@XIM_TRUE@uim_xim_LDFLAGS = @X_LIBS@
+@XIM_TRUE@uim_xim_LDFLAGS = @X_LIBS@ @CARBON_FRAMEWORK@
 @XIM_TRUE@uim_xim_LDADD = -lXext -lX11 $(top_builddir)/uim/libuim.la \
 @XIM_TRUE@	$(am__append_5)
 @XIM_TRUE@uim_xim_CPPFLAGS = -I$(top_srcdir) $(am__append_1) \
diff -Naur uim-1.0.1/xim/convdisp.cpp uim-1.0.1.fink/xim/convdisp.cpp
--- uim-1.0.1/xim/convdisp.cpp	2005-12-07 21:39:33.000000000 +0900
+++ uim-1.0.1.fink/xim/convdisp.cpp	2006-03-16 05:47:16.000000000 +0900
@@ -891,6 +891,10 @@
     mIMLang = get_im_lang_from_engine(k->get_engine_name());
     mEncoding = k->get_ic()->get_encoding();
     mLocaleName = k->get_locale_name();
+#ifdef USE_CURSOR_GEOMETRY_IN_IM
+    m_candwin_pos.x = 0;
+    m_candwin_pos.y = 0;
+#endif
 }
 
 Convdisp::~Convdisp()
@@ -967,6 +971,14 @@
     }
 }
 
+#ifdef USE_CURSOR_GEOMETRY_IN_IM
+void Convdisp::get_cursor_geometry(int *v, int *h)
+{
+	*v = m_candwin_pos.y;
+	*h = m_candwin_pos.x;
+}
+#endif
+
 // Root window style
 ConvdispRw::ConvdispRw(InputContext *k, icxatr *a) : Convdisp(k, a)
 {
@@ -1045,6 +1057,10 @@
 	if (mPeWin)
 	    x += mPeWin->mCandWinXOff;
 	disp->move(x, y + xattr.height + 28); // lower-left side under the preedit window
+#ifdef USE_CURSOR_GEOMETRY_IN_IM
+	m_candwin_pos.x = x;
+	m_candwin_pos.y = y + xattr.height + 28;
+#endif
     }
 }
 
@@ -1119,6 +1135,10 @@
 
 	    Canddisp *disp = canddisp_singleton();
 	    disp->move(x, y + UNDERLINE_HEIGHT + 1);
+#ifdef USE_CURSOR_GEOMETRY_IN_IM
+	    m_candwin_pos.x = x;
+	    m_candwin_pos.y = y + UNDERLINE_HEIGHT + 1;
+#endif
 	    m_atr->unset_change_mask(ICA_SpotLocation);
 	}
 #if 0
@@ -1604,15 +1624,23 @@
 
 	Canddisp *disp = canddisp_singleton();
 
-	if (m_atr->has_atr(ICA_SpotLocation))
+	if (m_atr->has_atr(ICA_SpotLocation)) {
 	    disp->move(x, y + 36); // 36 pixel seems too long.
 				   // Is there any way to get current preedit
 				   // height?
-	else {
+#ifdef USE_CURSOR_GEOMETRY_IN_IM
+	    m_candwin_pos.x = x;
+	    m_candwin_pos.y = y + 36;
+#endif
+	} else {
 	    XGetWindowAttributes(XimServer::gDpy, m_atr->client_window,
 			      &xattr);
 	    //disp->move(x + xattr.width + 2, y + 2); //upper-right side
 	    disp->move(x, y + xattr.height + 2); //lower-left side
+#ifdef USE_CURSOR_GEOMETRY_IN_IM
+	    m_candwin_pos.x = x;
+	    m_candwin_pos.y = y + xattr.height + 2;
+#endif
 	}
     }    
     
diff -Naur uim-1.0.1/xim/convdisp.h uim-1.0.1.fink/xim/convdisp.h
--- uim-1.0.1/xim/convdisp.h	2005-12-07 21:39:33.000000000 +0900
+++ uim-1.0.1.fink/xim/convdisp.h	2006-03-16 05:47:16.000000000 +0900
@@ -50,6 +50,9 @@
     InputContext *get_context();
     int get_caret_pos();
     void update_caret_state();
+#ifdef USE_CURSOR_GEOMETRY_IN_IM
+    void get_cursor_geometry(int *v, int *h);
+#endif
     virtual void update_preedit() = 0;
     virtual void clear_preedit() = 0;
     virtual void update_icxatr() = 0;
@@ -69,6 +72,12 @@
     const char *mIMLang;
     const char *mEncoding;
     const char *mLocaleName;
+#ifdef USE_CURSOR_GEOMETRY_IN_IM
+    struct candwin_pos {
+      int x;
+      int y;
+    } m_candwin_pos;
+#endif
 };
 
 Convdisp *create_convdisp(int style, InputContext *, icxatr *, Connection *);
diff -Naur uim-1.0.1/xim/main.cpp uim-1.0.1.fink/xim/main.cpp
--- uim-1.0.1/xim/main.cpp	2005-12-24 13:20:12.000000000 +0900
+++ uim-1.0.1.fink/xim/main.cpp	2006-03-16 05:47:42.000000000 +0900
@@ -46,6 +46,12 @@
 #include <signal.h>
 #include <sys/select.h>
 
+#ifdef HAVE_CARBON_CARBON_H
+#define Cursor CarbonCursor
+#include <Carbon/Carbon.h>
+#undef Cursor
+#endif /* HAVE_CARBON_CARBON_H */
+
 #include "xim.h"
 #include "xdispatch.h"
 #include "ximserver.h"
@@ -138,6 +144,21 @@
     fd_watch_stat.insert(p);
 }
 
+#ifdef HAVE_CARBON_CARBON_H
+static void
+handle_carbon_event()
+{
+    EventTargetRef target;
+    EventRef event;
+
+    target = GetEventDispatcherTarget();
+    while (ReceiveNextEvent(0, NULL, kEventDurationNoWait, true, &event) == noErr) {
+	SendEventToEventTarget(event, target);
+	ReleaseEvent(event);
+    }
+}
+#endif /* HAVE_CARBON_CARBON_H */
+
 static void main_loop()
 {
     fd_set rfds, wfds;
@@ -146,7 +167,11 @@
     while (1) {
 	FD_ZERO(&rfds);
 	FD_ZERO(&wfds);
+#ifdef HAVE_CARBON_CARBON_H
+	tv.tv_sec = 1;
+#else
 	tv.tv_sec = 2;
+#endif
 	tv.tv_usec = 0;
 
 	std::map<int, fd_watch_struct>::iterator it;
@@ -162,6 +187,9 @@
 	}
 	if ((select(fd_max + 1, &rfds, &wfds, NULL, &tv)) == 0) {
 	    check_pending_xevent();
+#ifdef HAVE_CARBON_CARBON_H
+	    handle_carbon_event();
+#endif
 	    continue;
 	}
 
@@ -175,6 +203,9 @@
 	    it = fd_watch_stat.find(fd);
 	    it++;
 	}
+#ifdef HAVE_CARBON_CARBON_H
+	handle_carbon_event();
+#endif
     }
 }
 
diff -Naur uim-1.0.1/xim/ximserver.cpp uim-1.0.1.fink/xim/ximserver.cpp
--- uim-1.0.1/xim/ximserver.cpp	2005-12-13 22:31:28.000000000 +0900
+++ uim-1.0.1.fink/xim/ximserver.cpp	2006-03-16 05:47:16.000000000 +0900
@@ -410,6 +410,10 @@
 			InputContext::update_prop_label_cb);
 	uim_set_configuration_changed_cb(uc,
 			InputContext::configuration_changed_cb);
+#ifdef USE_CURSOR_GEOMETRY_IN_IM
+	uim_set_cursor_geometry_cb(uc,
+			InputContext::cursor_geometry_cb);
+#endif
 
 	if (mFocusedContext == this)
 	    uim_prop_list_update(uc);
@@ -448,6 +452,14 @@
     review_im(engine);
 }
 
+#ifdef USE_CURSOR_GEOMETRY_IN_IM
+void InputContext::get_cursor_geometry(int *v, int *h)
+{
+    if (mConvdisp)
+	mConvdisp->get_cursor_geometry(v, h);
+}
+#endif
+
 void InputContext::review_im(const char *engine)
 {
     char *locale;
@@ -618,6 +630,15 @@
     ic->configuration_changed();
 }
 
+#ifdef USE_CURSOR_GEOMETRY_IN_IM
+void InputContext::cursor_geometry_cb(void *ptr, int *v, int *h)
+{
+    InputContext *ic = (InputContext *)ptr;
+
+    ic->get_cursor_geometry(v, h);
+}
+#endif
+
 void InputContext::clear_pe_stat()
 {
     m_pe->clear();
diff -Naur uim-1.0.1/xim/ximserver.h uim-1.0.1.fink/xim/ximserver.h
--- uim-1.0.1/xim/ximserver.h	2005-12-07 21:39:33.000000000 +0900
+++ uim-1.0.1.fink/xim/ximserver.h	2006-03-16 05:47:16.000000000 +0900
@@ -182,6 +182,9 @@
     void customContext(const char *custom, const char *val);
     void createUimContext(const char *engine);
     void configuration_changed();
+#ifdef USE_CURSOR_GEOMETRY_IN_IM
+    void get_cursor_geometry(int *v, int *h);
+#endif
 public:
     static void commit_cb(void *ptr, const char *str);
     static void clear_cb(void *ptr);
@@ -194,6 +197,9 @@
     static void update_prop_list_cb(void *ptr, const char *str);
     static void update_prop_label_cb(void *ptr, const char *str);
     static void configuration_changed_cb(void *ptr);
+#ifdef USE_CURSOR_GEOMETRY_IN_IM
+    static void cursor_geometry_cb(void *ptr, int *v, int *h);
+#endif
     static InputContext *focusedContext();
     static void deletefocusedContext();
 private:
