diff -uNr postgresql-7.4.2/pgsql.sh postgresql-7.4.2-new/pgsql.sh
--- postgresql-7.4.2/pgsql.sh	Wed Dec 31 19:00:00 1969
+++ postgresql-7.4.2-new/pgsql.sh	Fri May 21 08:43:33 2004
@@ -0,0 +1,21 @@
+#!/bin/sh
+
+for flag in "-n" "-d" "-s" "-u" "-v"; do
+	ulimit $flag 65536 >/dev/null 2>&1 || :
+done
+
+PREFIX="@PREFIX@"
+DATADIR="${PREFIX}/var/postgresql-7.4/data"
+LOGFILE="${DATADIR}/pgsql.log"
+
+case "$1" in
+	start)
+		sudo -u postgres "${PREFIX}/bin/pg_ctl" start -D "$DATADIR" -l "$LOGFILE"
+		;;
+	restart)
+		sudo -u postgres "${PREFIX}/bin/pg_ctl" restart -D "$DATADIR" -m fast
+		;;
+	stop)
+		sudo -u postgres "${PREFIX}/bin/pg_ctl" stop -D "$DATADIR" -m fast
+		;;
+esac
diff -uNr postgresql-7.4.2/src/Makefile.global.in postgresql-7.4.2-new/src/Makefile.global.in
--- postgresql-7.4.2/src/Makefile.global.in	Fri Dec 19 18:29:29 2003
+++ postgresql-7.4.2-new/src/Makefile.global.in	Fri May 21 08:44:33 2004
@@ -65,21 +65,21 @@
 libexecdir := @libexecdir@
 ifeq "$(findstring pgsql, $(libexecdir))" ""
 ifeq "$(findstring postgres, $(libexecdir))" ""
-override libexecdir := $(libexecdir)/postgresql
+override libexecdir := $(libexecdir)/postgresql-7.4
 endif
 endif
 
 datadir := @datadir@
 ifeq "$(findstring pgsql, $(datadir))" ""
 ifeq "$(findstring postgres, $(datadir))" ""
-override datadir := $(datadir)/postgresql
+override datadir := $(datadir)/postgresql-7.4
 endif
 endif
 
 sysconfdir := @sysconfdir@
 ifeq "$(findstring pgsql, $(sysconfdir))" ""
 ifeq "$(findstring postgres, $(sysconfdir))" ""
-override sysconfdir := $(sysconfdir)/postgresql
+override sysconfdir := $(sysconfdir)/postgresql-7.4
 endif
 endif
 
@@ -87,7 +87,7 @@
 pkglibdir = $(libdir)
 ifeq "$(findstring pgsql, $(pkglibdir))" ""
 ifeq "$(findstring postgres, $(pkglibdir))" ""
-override pkglibdir := $(pkglibdir)/postgresql
+override pkglibdir := $(pkglibdir)/postgresql-7.4
 endif
 endif
 
@@ -95,7 +95,7 @@
 pkgincludedir = $(includedir)
 ifeq "$(findstring pgsql, $(pkgincludedir))" ""
 ifeq "$(findstring postgres, $(pkgincludedir))" ""
-override pkgincludedir := $(pkgincludedir)/postgresql
+override pkgincludedir := $(pkgincludedir)/postgresql-7.4
 endif
 endif
 includedir_server = $(pkgincludedir)/server
@@ -107,7 +107,7 @@
 docdir := @docdir@
 ifeq "$(findstring pgsql, $(docdir))" ""
 ifeq "$(findstring postgres, $(docdir))" ""
-override docdir := $(docdir)/postgresql
+override docdir := $(docdir)/postgresql-7.4
 endif
 endif
 
diff -uNr postgresql-7.4.2/src/Makefile.shlib postgresql-7.4.2-new/src/Makefile.shlib
--- postgresql-7.4.2/src/Makefile.shlib	Sun Oct 19 21:34:33 2003
+++ postgresql-7.4.2-new/src/Makefile.shlib	Fri May 21 08:42:56 2004
@@ -81,8 +81,24 @@
 endif
 
 ifeq ($(PORTNAME), darwin)
-  shlib			:= lib$(NAME)$(DLSUFFIX).$(SO_MAJOR_VERSION).$(SO_MINOR_VERSION)
-  LINK.shared		= $(COMPILER) -bundle
+  ifeq (,$(filter $(host_os), darwin1.0 darwin1.1 darwin1.2))
+     MULTIPLY_DEFINED  =
+  else
+     MULTIPLY_DEFINED  = -multiply_defined suppress
+  endif
+
+  shlib			:= lib$(NAME).$(SO_MAJOR_VERSION).$(SO_MINOR_VERSION)$(DLSUFFIX)
+  ifneq ($(SO_MAJOR_VERSION), 0)
+    version_link	:= -compatibility_version $(SO_MAJOR_VERSION) -current_version $(SO_MAJOR_VERSION).$(SO_MINOR_VERSION)
+  endif
+  ifeq ($(DLTYPE), module)
+    DLSUFFIX		:= .so
+    LINK.shared		= $(COMPILER) $(DARWIN_NAMESPACE_SPEC) -bundle -undefined suppress -flat_namespace
+  else
+    DLSUFFIX		:= .dylib
+    LINK.shared		= $(COMPILER) $(DARWIN_NAMESPACE_SPEC) -install_name $(libdir)/lib$(NAME).$(SO_MAJOR_VERSION)$(DLSUFFIX) $(version_link) -dynamiclib $(MULTIPLY_DEFINED)
+  endif
+  SHLIB_LINK		:= -L$(libpq_builddir) $(SHLIB_LINK)
 endif
 
 ifeq ($(PORTNAME), openbsd)
@@ -249,6 +265,7 @@
 ifneq ($(PORTNAME), beos)
 ifneq ($(PORTNAME), cygwin)
 ifneq ($(PORTNAME), aix)
+ifneq ($(PORTNAME), darwin)
 
 # Normal case
 $(shlib): $(OBJS)
@@ -264,6 +281,25 @@
 	$(LN_S) $(shlib) lib$(NAME)$(DLSUFFIX)
 endif
 
+else # PORTNAME == darwin
+
+# Darwin case
+# (same as normal case, but libfoo.version.suffix)
+
+$(shlib): $(OBJS)
+	$(LINK.shared) $(OBJS) $(SHLIB_LINK) -o $@
+ifneq ($(shlib), lib$(NAME).$(SO_MAJOR_VERSION)$(DLSUFFIX))
+	rm -f lib$(NAME).$(SO_MAJOR_VERSION)$(DLSUFFIX)
+	$(LN_S) $(shlib) lib$(NAME).$(SO_MAJOR_VERSION)$(DLSUFFIX)
+endif
+
+ifneq ($(shlib), lib$(NAME)$(DLSUFFIX))
+	rm -f lib$(NAME)$(DLSUFFIX)
+	$(LN_S) $(shlib) lib$(NAME)$(DLSUFFIX)
+endif
+
+endif # PORTNAME == darwin
+
 else # PORTNAME == aix
 
 # AIX case
@@ -316,6 +352,7 @@
 install-lib-shared: $(shlib)
 	$(INSTALL_SHLIB) $< $(DESTDIR)$(libdir)/$(shlib)
 ifneq ($(PORTNAME), cygwin)
+ifneq ($(PORTNAME), darwin)
 ifneq ($(shlib), lib$(NAME)$(DLSUFFIX).$(SO_MAJOR_VERSION))
 	cd $(DESTDIR)$(libdir) && \
 	rm -f lib$(NAME)$(DLSUFFIX).$(SO_MAJOR_VERSION) && \
@@ -326,7 +363,18 @@
 	rm -f lib$(NAME)$(DLSUFFIX) && \
 	$(LN_S) $(shlib) lib$(NAME)$(DLSUFFIX)
 endif
-
+else
+ifneq ($(shlib), lib$(NAME).$(SO_MAJOR_VERSION)$(DLSUFFIX))
+	cd $(DESTDIR)$(libdir) && \
+	rm -f lib$(NAME).$(SO_MAJOR_VERSION)$(DLSUFFIX) && \
+	$(LN_S) $(shlib) lib$(NAME).$(SO_MAJOR_VERSION)$(DLSUFFIX)
+endif
+ifneq ($(shlib), lib$(NAME)$(DLSUFFIX))
+	cd $(DESTDIR)$(libdir) && \
+	rm -f lib$(NAME)$(DLSUFFIX) && \
+	$(LN_S) $(shlib) lib$(NAME)$(DLSUFFIX)
+endif
+endif # not darwin
 endif # not cygwin
 endif # enable_shared
 
@@ -341,7 +389,9 @@
 ifeq ($(enable_shared), yes)
 	rm -f $(DESTDIR)$(libdir)/lib$(NAME)$(DLSUFFIX) \
 	  $(DESTDIR)$(libdir)/lib$(NAME)$(DLSUFFIX).$(SO_MAJOR_VERSION) \
-	  $(DESTDIR)$(libdir)/lib$(NAME)$(DLSUFFIX).$(SO_MAJOR_VERSION).$(SO_MINOR_VERSION)
+	  $(DESTDIR)$(libdir)/lib$(NAME)$(DLSUFFIX).$(SO_MAJOR_VERSION).$(SO_MINOR_VERSION) \
+	  $(DESTDIR)$(libdir)/lib$(NAME).$(SO_MAJOR_VERSION)$(DLSUFFIX) \
+	  $(DESTDIR)$(libdir)/lib$(NAME).$(SO_MAJOR_VERSION).$(SO_MINOR_VERSION)$(DLSUFFIX)
 endif # enable_shared
 
 
@@ -353,7 +403,7 @@
 clean-lib:
 	rm -f lib$(NAME).a
 ifeq ($(enable_shared), yes)
-	rm -f lib$(NAME)$(DLSUFFIX) lib$(NAME)$(DLSUFFIX).$(SO_MAJOR_VERSION) lib$(NAME)$(DLSUFFIX).$(SO_MAJOR_VERSION).$(SO_MINOR_VERSION)
+	rm -f lib$(NAME)$(DLSUFFIX) lib$(NAME)$(DLSUFFIX).$(SO_MAJOR_VERSION) lib$(NAME)$(DLSUFFIX).$(SO_MAJOR_VERSION).$(SO_MINOR_VERSION) lib$(NAME).$(SO_MAJOR_VERSION)$(DLSUFFIX) lib$(NAME).$(SO_MAJOR_VERSION).$(SO_MINOR_VERSION)$(DLSUFFIX)
 ifdef EXPSUFF
 	rm -f lib$(NAME)$(EXPSUFF)
 endif
diff -uNr postgresql-7.4.2/src/backend/utils/mb/conversion_procs/ascii_and_mic/Makefile postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/ascii_and_mic/Makefile
--- postgresql-7.4.2/src/backend/utils/mb/conversion_procs/ascii_and_mic/Makefile	Wed Aug 21 22:18:45 2002
+++ postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/ascii_and_mic/Makefile	Fri May 21 08:42:56 2004
@@ -3,6 +3,9 @@
 # $Id$
 #
 #-------------------------------------------------------------------------
+
+DLTYPE = module
+
 subdir = src/backend/utils/mb/conversion_procs/ascii_and_mic
 top_builddir = ../../../../../..
 include $(top_builddir)/src/Makefile.global
diff -uNr postgresql-7.4.2/src/backend/utils/mb/conversion_procs/cyrillic_and_mic/Makefile postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/cyrillic_and_mic/Makefile
--- postgresql-7.4.2/src/backend/utils/mb/conversion_procs/cyrillic_and_mic/Makefile	Wed Aug 21 17:33:55 2002
+++ postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/cyrillic_and_mic/Makefile	Fri May 21 08:42:56 2004
@@ -3,6 +3,9 @@
 # $Id$
 #
 #-------------------------------------------------------------------------
+
+DLTYPE = module
+
 subdir = src/backend/utils/mb/conversion_procs/cyrillic_and_mic
 top_builddir = ../../../../../..
 include $(top_builddir)/src/Makefile.global
diff -uNr postgresql-7.4.2/src/backend/utils/mb/conversion_procs/euc_cn_and_mic/Makefile postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/euc_cn_and_mic/Makefile
--- postgresql-7.4.2/src/backend/utils/mb/conversion_procs/euc_cn_and_mic/Makefile	Wed Aug 21 17:33:55 2002
+++ postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/euc_cn_and_mic/Makefile	Fri May 21 08:42:56 2004
@@ -3,6 +3,9 @@
 # $Id$
 #
 #-------------------------------------------------------------------------
+
+DLTYPE = module
+
 subdir = src/backend/utils/mb/conversion_procs/euc_cn_and_mic
 top_builddir = ../../../../../..
 include $(top_builddir)/src/Makefile.global
diff -uNr postgresql-7.4.2/src/backend/utils/mb/conversion_procs/euc_jp_and_sjis/Makefile postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/euc_jp_and_sjis/Makefile
--- postgresql-7.4.2/src/backend/utils/mb/conversion_procs/euc_jp_and_sjis/Makefile	Wed Aug 21 17:33:55 2002
+++ postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/euc_jp_and_sjis/Makefile	Fri May 21 08:42:56 2004
@@ -3,6 +3,9 @@
 # $Id$
 #
 #-------------------------------------------------------------------------
+
+DLTYPE = module
+
 subdir = src/backend/utils/mb/conversion_procs/euc_jp_and_sjis
 top_builddir = ../../../../../..
 include $(top_builddir)/src/Makefile.global
diff -uNr postgresql-7.4.2/src/backend/utils/mb/conversion_procs/euc_kr_and_mic/Makefile postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/euc_kr_and_mic/Makefile
--- postgresql-7.4.2/src/backend/utils/mb/conversion_procs/euc_kr_and_mic/Makefile	Wed Aug 21 17:33:55 2002
+++ postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/euc_kr_and_mic/Makefile	Fri May 21 08:42:56 2004
@@ -3,6 +3,9 @@
 # $Id$
 #
 #-------------------------------------------------------------------------
+
+DLTYPE = module
+
 subdir = src/backend/utils/mb/conversion_procs/euc_kr_and_mic
 top_builddir = ../../../../../..
 include $(top_builddir)/src/Makefile.global
diff -uNr postgresql-7.4.2/src/backend/utils/mb/conversion_procs/euc_tw_and_big5/Makefile postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/euc_tw_and_big5/Makefile
--- postgresql-7.4.2/src/backend/utils/mb/conversion_procs/euc_tw_and_big5/Makefile	Wed Aug 21 17:33:55 2002
+++ postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/euc_tw_and_big5/Makefile	Fri May 21 08:42:56 2004
@@ -3,6 +3,9 @@
 # $Id$
 #
 #-------------------------------------------------------------------------
+
+DLTYPE = module
+
 subdir = src/backend/utils/mb/conversion_procs/euc_tw_and_big5
 top_builddir = ../../../../../..
 include $(top_builddir)/src/Makefile.global
diff -uNr postgresql-7.4.2/src/backend/utils/mb/conversion_procs/latin2_and_win1250/Makefile postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/latin2_and_win1250/Makefile
--- postgresql-7.4.2/src/backend/utils/mb/conversion_procs/latin2_and_win1250/Makefile	Wed Aug 21 17:33:55 2002
+++ postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/latin2_and_win1250/Makefile	Fri May 21 08:42:56 2004
@@ -3,6 +3,9 @@
 # $Id$
 #
 #-------------------------------------------------------------------------
+
+DLTYPE = module
+
 subdir = src/backend/utils/mb/conversion_procs/latin2_and_win1250
 top_builddir = ../../../../../..
 include $(top_builddir)/src/Makefile.global
diff -uNr postgresql-7.4.2/src/backend/utils/mb/conversion_procs/latin_and_mic/Makefile postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/latin_and_mic/Makefile
--- postgresql-7.4.2/src/backend/utils/mb/conversion_procs/latin_and_mic/Makefile	Wed Aug 21 17:33:55 2002
+++ postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/latin_and_mic/Makefile	Fri May 21 08:42:56 2004
@@ -3,6 +3,9 @@
 # $Id$
 #
 #-------------------------------------------------------------------------
+
+DLTYPE = module
+
 subdir = src/backend/utils/mb/conversion_procs/latin_and_mic
 top_builddir = ../../../../../..
 include $(top_builddir)/src/Makefile.global
diff -uNr postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_ascii/Makefile postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_ascii/Makefile
--- postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_ascii/Makefile	Wed Aug 21 17:33:55 2002
+++ postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_ascii/Makefile	Fri May 21 08:42:56 2004
@@ -3,6 +3,9 @@
 # $Id$
 #
 #-------------------------------------------------------------------------
+
+DLTYPE = module
+
 subdir = src/backend/utils/mb/conversion_procs/utf8_and_ascii
 top_builddir = ../../../../../..
 include $(top_builddir)/src/Makefile.global
diff -uNr postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_big5/Makefile postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_big5/Makefile
--- postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_big5/Makefile	Wed Aug 21 17:33:55 2002
+++ postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_big5/Makefile	Fri May 21 08:42:56 2004
@@ -3,6 +3,9 @@
 # $Id$
 #
 #-------------------------------------------------------------------------
+
+DLTYPE = module
+
 subdir = src/backend/utils/mb/conversion_procs/utf8_and_big5
 top_builddir = ../../../../../..
 include $(top_builddir)/src/Makefile.global
diff -uNr postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_cyrillic/Makefile postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_cyrillic/Makefile
--- postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_cyrillic/Makefile	Wed Aug 21 17:33:55 2002
+++ postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_cyrillic/Makefile	Fri May 21 08:42:56 2004
@@ -3,6 +3,9 @@
 # $Id$
 #
 #-------------------------------------------------------------------------
+
+DLTYPE = module
+
 subdir = src/backend/utils/mb/conversion_procs/utf8_and_cyrillic
 top_builddir = ../../../../../..
 include $(top_builddir)/src/Makefile.global
diff -uNr postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_euc_cn/Makefile postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_euc_cn/Makefile
--- postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_euc_cn/Makefile	Wed Aug 21 17:33:55 2002
+++ postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_euc_cn/Makefile	Fri May 21 08:42:56 2004
@@ -3,6 +3,9 @@
 # $Id$
 #
 #-------------------------------------------------------------------------
+
+DLTYPE = module
+
 subdir = src/backend/utils/mb/conversion_procs/utf8_and_euc_cn
 top_builddir = ../../../../../..
 include $(top_builddir)/src/Makefile.global
diff -uNr postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_euc_jp/Makefile postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_euc_jp/Makefile
--- postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_euc_jp/Makefile	Wed Aug 21 17:33:55 2002
+++ postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_euc_jp/Makefile	Fri May 21 08:42:56 2004
@@ -3,6 +3,9 @@
 # $Id$
 #
 #-------------------------------------------------------------------------
+
+DLTYPE = module
+
 subdir = src/backend/utils/mb/conversion_procs/utf8_and_euc_jp
 top_builddir = ../../../../../..
 include $(top_builddir)/src/Makefile.global
diff -uNr postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_euc_kr/Makefile postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_euc_kr/Makefile
--- postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_euc_kr/Makefile	Wed Aug 21 17:33:55 2002
+++ postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_euc_kr/Makefile	Fri May 21 08:42:56 2004
@@ -3,6 +3,9 @@
 # $Id$
 #
 #-------------------------------------------------------------------------
+
+DLTYPE = module
+
 subdir = src/backend/utils/mb/conversion_procs/utf8_and_euc_kr
 top_builddir = ../../../../../..
 include $(top_builddir)/src/Makefile.global
diff -uNr postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_euc_tw/Makefile postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_euc_tw/Makefile
--- postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_euc_tw/Makefile	Wed Aug 21 17:33:55 2002
+++ postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_euc_tw/Makefile	Fri May 21 08:42:56 2004
@@ -3,6 +3,9 @@
 # $Id$
 #
 #-------------------------------------------------------------------------
+
+DLTYPE = module
+
 subdir = src/backend/utils/mb/conversion_procs/utf8_and_euc_tw
 top_builddir = ../../../../../..
 include $(top_builddir)/src/Makefile.global
diff -uNr postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_gb18030/Makefile postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_gb18030/Makefile
--- postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_gb18030/Makefile	Wed Aug 21 17:33:55 2002
+++ postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_gb18030/Makefile	Fri May 21 08:42:56 2004
@@ -3,6 +3,9 @@
 # $Id$
 #
 #-------------------------------------------------------------------------
+
+DLTYPE = module
+
 subdir = src/backend/utils/mb/conversion_procs/utf8_and_gb18030
 top_builddir = ../../../../../..
 include $(top_builddir)/src/Makefile.global
diff -uNr postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_gbk/Makefile postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_gbk/Makefile
--- postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_gbk/Makefile	Wed Aug 21 17:33:55 2002
+++ postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_gbk/Makefile	Fri May 21 08:42:56 2004
@@ -3,6 +3,9 @@
 # $Id$
 #
 #-------------------------------------------------------------------------
+
+DLTYPE = module
+
 subdir = src/backend/utils/mb/conversion_procs/utf8_and_gbk
 top_builddir = ../../../../../..
 include $(top_builddir)/src/Makefile.global
diff -uNr postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_iso8859/Makefile postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_iso8859/Makefile
--- postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_iso8859/Makefile	Wed Aug 21 17:33:55 2002
+++ postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_iso8859/Makefile	Fri May 21 08:42:56 2004
@@ -3,6 +3,9 @@
 # $Id$
 #
 #-------------------------------------------------------------------------
+
+DLTYPE = module
+
 subdir = src/backend/utils/mb/conversion_procs/utf8_and_iso8859
 top_builddir = ../../../../../..
 include $(top_builddir)/src/Makefile.global
diff -uNr postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_iso8859_1/Makefile postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_iso8859_1/Makefile
--- postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_iso8859_1/Makefile	Wed Aug 21 17:33:55 2002
+++ postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_iso8859_1/Makefile	Fri May 21 08:42:56 2004
@@ -3,6 +3,9 @@
 # $Id$
 #
 #-------------------------------------------------------------------------
+
+DLTYPE = module
+
 subdir = src/backend/utils/mb/conversion_procs/utf8_and_iso8859_1
 top_builddir = ../../../../../..
 include $(top_builddir)/src/Makefile.global
diff -uNr postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_johab/Makefile postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_johab/Makefile
--- postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_johab/Makefile	Wed Aug 21 17:33:55 2002
+++ postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_johab/Makefile	Fri May 21 08:42:56 2004
@@ -3,6 +3,9 @@
 # $Id$
 #
 #-------------------------------------------------------------------------
+
+DLTYPE = module
+
 subdir = src/backend/utils/mb/conversion_procs/utf8_and_johab
 top_builddir = ../../../../../..
 include $(top_builddir)/src/Makefile.global
diff -uNr postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_sjis/Makefile postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_sjis/Makefile
--- postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_sjis/Makefile	Wed Aug 21 17:33:55 2002
+++ postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_sjis/Makefile	Fri May 21 08:42:56 2004
@@ -3,6 +3,9 @@
 # $Id$
 #
 #-------------------------------------------------------------------------
+
+DLTYPE = module
+
 subdir = src/backend/utils/mb/conversion_procs/utf8_and_sjis
 top_builddir = ../../../../../..
 include $(top_builddir)/src/Makefile.global
diff -uNr postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_tcvn/Makefile postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_tcvn/Makefile
--- postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_tcvn/Makefile	Wed Aug 21 17:33:55 2002
+++ postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_tcvn/Makefile	Fri May 21 08:42:56 2004
@@ -3,6 +3,9 @@
 # $Id$
 #
 #-------------------------------------------------------------------------
+
+DLTYPE = module
+
 subdir = src/backend/utils/mb/conversion_procs/utf8_and_tcvn
 top_builddir = ../../../../../..
 include $(top_builddir)/src/Makefile.global
diff -uNr postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_uhc/Makefile postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_uhc/Makefile
--- postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_uhc/Makefile	Wed Aug 21 17:33:55 2002
+++ postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_uhc/Makefile	Fri May 21 08:42:56 2004
@@ -3,6 +3,9 @@
 # $Id$
 #
 #-------------------------------------------------------------------------
+
+DLTYPE = module
+
 subdir = src/backend/utils/mb/conversion_procs/utf8_and_uhc
 top_builddir = ../../../../../..
 include $(top_builddir)/src/Makefile.global
diff -uNr postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_win1250/Makefile postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_win1250/Makefile
--- postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_win1250/Makefile	Wed Aug 21 17:33:55 2002
+++ postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_win1250/Makefile	Fri May 21 08:42:56 2004
@@ -3,6 +3,9 @@
 # $Id$
 #
 #-------------------------------------------------------------------------
+
+DLTYPE = module
+
 subdir = src/backend/utils/mb/conversion_procs/utf8_and_win1250
 top_builddir = ../../../../../..
 include $(top_builddir)/src/Makefile.global
diff -uNr postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_win1256/Makefile postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_win1256/Makefile
--- postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_win1256/Makefile	Wed Aug 21 17:33:55 2002
+++ postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_win1256/Makefile	Fri May 21 08:42:56 2004
@@ -3,6 +3,9 @@
 # $Id$
 #
 #-------------------------------------------------------------------------
+
+DLTYPE = module
+
 subdir = src/backend/utils/mb/conversion_procs/utf8_and_win1256
 top_builddir = ../../../../../..
 include $(top_builddir)/src/Makefile.global
diff -uNr postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_win874/Makefile postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_win874/Makefile
--- postgresql-7.4.2/src/backend/utils/mb/conversion_procs/utf8_and_win874/Makefile	Wed Aug 21 17:33:55 2002
+++ postgresql-7.4.2-new/src/backend/utils/mb/conversion_procs/utf8_and_win874/Makefile	Fri May 21 08:42:56 2004
@@ -3,6 +3,9 @@
 # $Id$
 #
 #-------------------------------------------------------------------------
+
+DLTYPE = module
+
 subdir = src/backend/utils/mb/conversion_procs/utf8_and_win874
 top_builddir = ../../../../../..
 include $(top_builddir)/src/Makefile.global
diff -uNr postgresql-7.4.2/src/backend/utils/misc/postgresql.conf.sample postgresql-7.4.2-new/src/backend/utils/misc/postgresql.conf.sample
--- postgresql-7.4.2/src/backend/utils/misc/postgresql.conf.sample	Tue Oct  7 23:49:38 2003
+++ postgresql-7.4.2-new/src/backend/utils/misc/postgresql.conf.sample	Fri May 21 08:42:56 2004
@@ -27,7 +27,7 @@
 
 # - Connection Settings -
 
-#tcpip_socket = false
+tcpip_socket = true
 #max_connections = 100
 	# note: increasing max_connections costs about 500 bytes of shared
 	# memory per connection slot, in addition to costs from shared_buffers
@@ -43,7 +43,7 @@
 # - Security & Authentication -
 
 #authentication_timeout = 60	# 1-600, in seconds
-#ssl = false
+ssl = false
 #password_encryption = true
 #krb_server_keyfile = ''
 #db_user_namespace = false
diff -uNr postgresql-7.4.2/src/bin/initdb/initdb.sh postgresql-7.4.2-new/src/bin/initdb/initdb.sh
--- postgresql-7.4.2/src/bin/initdb/initdb.sh	Tue Jan 13 22:47:12 2004
+++ postgresql-7.4.2-new/src/bin/initdb/initdb.sh	Fri May 21 08:42:56 2004
@@ -1147,11 +1147,7 @@
 echo
 echo "Success. You can now start the database server using:"
 echo ""
-echo "    $PGPATH/postmaster -D $PGDATA"
-echo "or"
-# (Advertise -l option here, otherwise we have a background
-#  process writing to the terminal.)
-echo "    $PGPATH/pg_ctl -D $PGDATA -l logfile start"
+echo "    sudo @PREFIX@/bin/pgsql.sh start"
 echo
 
 exit 0
diff -uNr postgresql-7.4.2/src/bin/pg_ctl/pg_ctl.sh postgresql-7.4.2-new/src/bin/pg_ctl/pg_ctl.sh
--- postgresql-7.4.2/src/bin/pg_ctl/pg_ctl.sh	Thu Aug 14 14:56:41 2003
+++ postgresql-7.4.2-new/src/bin/pg_ctl/pg_ctl.sh	Fri May 21 08:42:56 2004
@@ -14,6 +14,10 @@
 
 CMDNAME=`basename $0`
 
+ulimit -d 24000 >/dev/null 2>&1
+ulimit -n 512   >/dev/null 2>&1
+ulimit -s 4096  >/dev/null 2>&1
+
 help="\
 $CMDNAME is a utility to start, stop, restart, reload configuration files,
 or report the status of a PostgreSQL server.
diff -uNr postgresql-7.4.2/src/interfaces/ecpg/compatlib/Makefile postgresql-7.4.2-new/src/interfaces/ecpg/compatlib/Makefile
--- postgresql-7.4.2/src/interfaces/ecpg/compatlib/Makefile	Tue Feb 10 02:26:48 2004
+++ postgresql-7.4.2-new/src/interfaces/ecpg/compatlib/Makefile	Thu Jun  3 13:57:36 2004
@@ -17,6 +17,8 @@
 SO_MINOR_VERSION= 1
 
 override CPPFLAGS := -I$(top_srcdir)/src/interfaces/ecpg/include -I$(libpq_srcdir) -I$(top_srcdir)/src/include/utils $(CPPFLAGS) $(THREAD_CPPFLAGS)
+override LDFLAGS := -L../../../../src/port -L@BUILDDIR@@PREFIX@/lib -L../ecpglib -lecpg -L../pgtypeslib -lpgtypes $(libpq) $(LDFLAGS)
+
 SHLIB_LINK = -L../ecpglib -lecpg -L../pgtypeslib -lpgtypes $(libpq) \
 	$(filter -lintl -lssl -lcrypto -lkrb5 -lcrypt -lm, $(LIBS)) $(THREAD_LIBS)
 
diff -uNr postgresql-7.4.2/src/interfaces/ecpg/ecpglib/Makefile postgresql-7.4.2-new/src/interfaces/ecpg/ecpglib/Makefile
--- postgresql-7.4.2/src/interfaces/ecpg/ecpglib/Makefile	Tue Feb 10 02:26:48 2004
+++ postgresql-7.4.2-new/src/interfaces/ecpg/ecpglib/Makefile	Thu Jun  3 13:56:18 2004
@@ -17,6 +17,7 @@
 SO_MINOR_VERSION= 1
 
 override CPPFLAGS := -I$(top_srcdir)/src/interfaces/ecpg/include -I$(libpq_srcdir) $(CPPFLAGS) $(THREAD_CPPFLAGS) 
+override LDFLAGS := -L@BUILDDIR@@PREFIX@/lib -L../pgtypeslib -lpgtypes $(libpq) -L../../../../src/port $(LDFLAGS)
 
 OBJS= execute.o typename.o descriptor.o data.o error.o prepare.o memory.o \
 	connect.o misc.o
diff -uNr postgresql-7.4.2/src/makefiles/Makefile.darwin postgresql-7.4.2-new/src/makefiles/Makefile.darwin
--- postgresql-7.4.2/src/makefiles/Makefile.darwin	Mon Oct 27 02:42:34 2003
+++ postgresql-7.4.2-new/src/makefiles/Makefile.darwin	Fri May 21 08:42:56 2004
@@ -1,13 +1,28 @@
 AROPT = crs
 AWK= awk
  
-DLSUFFIX = .so
+ifeq ($(DLTYPE), module)
+	DLSUFFIX := .so
+	BE_DLLLIBS= -bundle_loader $(top_builddir)/src/backend/postgres
+else
+	DLSUFFIX := .dylib
+	BE_DLLLIBS=
+endif
+
 CFLAGS_SL =
-BE_DLLLIBS= -bundle_loader $(top_builddir)/src/backend/postgres
- 
+CFLAGS += -fno-common
+
+ifeq (,$(filter $(host_os), darwin1.0 darwin1.1 darwin1.2))
+	MULTIPLY_DEFINED=
+else
+	MULTIPLY_DEFINED=-multiply_defined suppress
+endif
+
 # Rule for building shared libs (currently used only for regression test
 # shlib ... should go away, since this is not really enough knowledge)
 %.so: %.o
-	$(CC) -bundle -o $@ $< $(BE_DLLLIBS)
+	$(CC) -bundle $(MULTIPLY_DEFINED) -o $@ $< $(BE_DLLLIBS)
+%.dylib: %.o
+	$(CC) -dynamiclib $(MULTIPLY_DEFINED) -o $@ $<
 
 sqlmansect = 7
diff -uNr postgresql-7.4.2/src/pl/plperl/GNUmakefile postgresql-7.4.2-new/src/pl/plperl/GNUmakefile
--- postgresql-7.4.2/src/pl/plperl/GNUmakefile	Wed Jan 21 14:25:11 2004
+++ postgresql-7.4.2-new/src/pl/plperl/GNUmakefile	Fri May 21 08:42:56 2004
@@ -1,6 +1,8 @@
 # Makefile for PL/Perl
 # $Header$
 
+DLTYPE = module
+
 subdir = src/pl/plperl
 top_builddir = ../../..
 include $(top_builddir)/src/Makefile.global
diff -uNr postgresql-7.4.2/src/pl/plpgsql/Makefile postgresql-7.4.2-new/src/pl/plpgsql/Makefile
--- postgresql-7.4.2/src/pl/plpgsql/Makefile	Thu May 24 18:33:18 2001
+++ postgresql-7.4.2-new/src/pl/plpgsql/Makefile	Fri May 21 08:42:56 2004
@@ -8,6 +8,8 @@
 #
 #-------------------------------------------------------------------------
 
+DLTYPE = module
+
 subdir = src/pl/plpgsql
 top_builddir = ../../..
 include $(top_builddir)/src/Makefile.global
diff -uNr postgresql-7.4.2/src/pl/plpgsql/src/Makefile postgresql-7.4.2-new/src/pl/plpgsql/src/Makefile
--- postgresql-7.4.2/src/pl/plpgsql/src/Makefile	Tue Feb 10 02:26:48 2004
+++ postgresql-7.4.2-new/src/pl/plpgsql/src/Makefile	Thu Jun  3 14:10:32 2004
@@ -6,6 +6,8 @@
 #
 #-------------------------------------------------------------------------
 
+DLTYPE = module
+
 subdir = src/pl/plpgsql/src
 top_builddir = ../../../..
 include $(top_builddir)/src/Makefile.global
@@ -20,6 +22,7 @@
 SO_MINOR_VERSION= 0
 
 override CPPFLAGS := -I$(srcdir) $(CPPFLAGS)
+override LDFLAGS := $(libpq) $(LDFLAGS)
 SHLIB_LINK = $(filter -lintl, $(LIBS)) $(BE_DLLLIBS)
 rpath :=
 
diff -uNr postgresql-7.4.2/src/pl/plpython/Makefile postgresql-7.4.2-new/src/pl/plpython/Makefile
--- postgresql-7.4.2/src/pl/plpython/Makefile	Wed Jan 21 14:25:11 2004
+++ postgresql-7.4.2-new/src/pl/plpython/Makefile	Thu Jun  3 20:33:20 2004
@@ -1,5 +1,7 @@
 # $Header$
 
+DLTYPE = module
+
 subdir = src/pl/plpython
 top_builddir = ../../..
 include $(top_builddir)/src/Makefile.global
@@ -8,13 +10,12 @@
 # On some platforms we can only build PL/Python if libpython is a
 # shared library.  Since there is no official way to determine this,
 # we see if there is a file that is named like a shared library.
-ifneq (,$(wildcard $(python_configdir)/libpython*$(DLSUFFIX)*))
+ifneq (,$(wildcard $(python_configdir)/libpython*.dylib*))
 shared_libpython = yes
 endif
 
 # If we don't have a shared library and the platform doesn't allow it
 # to work without, we have to skip it.
-ifneq (,$(findstring yes, $(shared_libpython)$(allow_nonpic_in_shlib)))
 
 override CPPFLAGS := -I$(srcdir) $(python_includespec) $(CPPFLAGS)
 rpath :=
@@ -32,13 +33,7 @@
 all: all-lib
 
 install: all installdirs
-ifeq ($(enable_shared), yes)
 	$(INSTALL_SHLIB) $(shlib) $(DESTDIR)$(pkglibdir)/plpython$(DLSUFFIX)
-else
-	@echo "*****"; \
-	 echo "* PL/Python was not installed due to lack of shared library support."; \
-	 echo "*****"
-endif
 
 installdirs:
 	$(mkinstalldirs) $(DESTDIR)$(pkglibdir)
@@ -53,13 +48,3 @@
 installcheck:
 	PATH=$(bindir):$$PATH $(SHELL) $(srcdir)/test.sh
 
-else # can't build
-
-all:
-	@echo ""; \
-	 echo "*** Cannot build PL/Python because libpython is not a shared library." ; \
-	 echo "*** You might have to rebuild your Python installation.  Refer to"; \
-	 echo "*** the documentation for details."; \
-	 echo ""
-
-endif # can't build
diff -uNr postgresql-7.4.2/src/pl/tcl/Makefile postgresql-7.4.2-new/src/pl/tcl/Makefile
--- postgresql-7.4.2/src/pl/tcl/Makefile	Wed Jan 21 14:25:11 2004
+++ postgresql-7.4.2-new/src/pl/tcl/Makefile	Fri May 21 08:42:56 2004
@@ -6,6 +6,8 @@
 #
 #-------------------------------------------------------------------------
 
+DLTYPE = module
+
 subdir = src/pl/tcl
 top_builddir = ../../..
 include $(top_builddir)/src/Makefile.global
