--- config/cf/darwin.cf	Fri Aug 13 17:18:27 2004
+++ config/cf/darwin.cf	Fri Aug 13 17:20:38 2004
@@ -159,7 +159,9 @@
  * The default cpp-3.3 that ships with Panther inserts spurious #pragmas,
  * so we use the 3.1-based version.
  */
-#if OSMajorVersion >= 7
+#if OSMajorVersion >= 8
+# define CppCmd                 /usr/bin/cpp-3.5
+#elif OSMajorVersion >= 7
 # define CppCmd                 /usr/bin/cpp3
 # define StandardCppOptions     -traditional -D__GNUC__
 #else
--- programs/Xserver/Imakefile	1 Sep 2004 00:59:17 -0000	1.19
+++ programs/Xserver/Imakefile	23 Sep 2004 00:05:31 -0000
@@ -1081,13 +1081,19 @@
 #if DarwinQuartzSupport
 
 QUARTZDIR = $(DARWINDDXDIR)/quartz
+QUARTZOBJS = $(DARWINOBJS) $(QUARTZDIR)/quartzStartup.o
 QUARTZLIB = $(QUARTZDIR)/LibraryTargetName(XQuartz)
 QUARTZSYSLIBS = -framework ApplicationServices -framework Cocoa \
                 -framework CoreAudio -framework Carbon -ObjC
 ROOTLESSLIB = $(ROOTLESSDIR)/LibraryTargetName(rootless) \
               $(ROOTLESSDIR)/safeAlpha/LibraryTargetName(safeAlpha) \
               $(ROOTLESSDIR)/accel/LibraryTargetName(rlAccel)
+
+#if HasXplugin
 XPLUGINLIB = XpluginLibrary
+XPRDIRS = $(QUARTZDIR)/xpr $(ROOTLESSDIR) $(ROOTLESSDIR)/safeAlpha
+XPRLIBS = $(QUARTZDIR)/xpr/LibraryTargetName(xpr) $(ROOTLESSLIB)
+#endif
 
 #if NothingOutsideProjectRoot
 XDARWINAPPDIR = $(BINDIR)/XDarwin.app/Contents
@@ -1098,7 +1104,7 @@
 /*
  * Quartz X server (installed in its application bundle)
  */
-SetUIDServerTarget(XDarwinApp,$(DARWINDIRS),$(DARWINOBJS), \
+SetUIDServerTarget(XDarwinApp,$(DARWINDIRS),$(QUARTZOBJS), \
 	$(DARWINLIBS) $(QUARTZLIB) $(DARWINEXTLIBS), \
 	$(DARWINSYSLIBS) $(QUARTZSYSLIBS) -u _miDCInitialize)
 
@@ -1109,14 +1115,26 @@
 	-(cd $(DESTDIR)$(BINDIR); $(RM) XDarwinQuartz; \
 		$(LN) $(XDARWINAPPDIR)/MacOS/XDarwin XDarwinQuartz)
 
+#define XAppleServer 1
+#if XAppleServer
+
+APPLEOBJS = $(DARWINOBJS) $(DARWINDDXDIR)/apple/quartzStartup.o
+APPLELIB = $(DARWINDDXDIR)/apple/LibraryTargetName(XApple)
+
+/*
+ * Apple's Quartz X server (installed as standalone binary)
+ */
+SetUIDServerTarget(Xquartz,$(DARWINDIRS) $(XPRDIRS),$(APPLEOBJS), \
+        $(DARWINLIBS) $(APPLELIB) $(DARWINEXTLIBS) $(XPRLIBS), \
+        $(XPLUGINLIB) $(DARWINSYSLIBS) $(QUARTZSYSLIBS) -u _miDCInitialize)
+
+#endif
+
 /*
  * Display mode bundles for Quartz
  * (installed in their own bundles inside XDarwin's)
  */
 #if HasXplugin
-XPRDIRS = $(QUARTZDIR)/xpr $(ROOTLESSDIR) $(ROOTLESSDIR)/safeAlpha
-XPRLIBS = $(QUARTZDIR)/xpr/LibraryTargetName(xpr) $(ROOTLESSLIB)
-
 BundleProgramTarget(xpr,XDarwinApp,$(XPRDIRS),$(QUARTZDIR)/xpr/xprScreen.o, \
 	$(XPRLIBS),-framework ApplicationServices \
 	$(XPLUGINLIB),$(XDARWINAPPDIR)/Resources)
cvs diff: Diffing hw
cvs diff: Diffing hw/darwin
--- programs/Xserver/hw/darwin/Imakefile	30 Jul 2004 20:42:06 -0000	1.5
+++ programs/Xserver/hw/darwin/Imakefile	23 Sep 2004 00:05:31 -0000
@@ -64,7 +64,7 @@
 #endif
 
 #if DarwinQuartzSupport
-SUBDIRS = iokit bundle quartz utils
+SUBDIRS = iokit bundle quartz apple utils
 QUARTZDEF = -DDARWIN_WITH_QUARTZ
 #else
 SUBDIRS = iokit utils
cvs diff: Diffing hw/darwin/quartz
--- programs/Xserver/hw/darwin/quartz/Imakefile	23 Apr 2004 19:15:17 -0000	1.2
+++ programs/Xserver/hw/darwin/quartz/Imakefile	23 Sep 2004 00:05:31 -0000
@@ -13,7 +13,6 @@
         quartzCocoa.m \
         quartzPasteboard.c \
         quartzKeyboard.c \
-        quartzStartup.c \
         pseudoramiX.c
 
 OBJS =  Preferences.o \
@@ -26,7 +25,6 @@
         quartzCocoa.o \
         quartzPasteboard.o \
         quartzKeyboard.o \
-        quartzStartup.o \
         pseudoramiX.o
 
 INCLUDES = -I. -I$(SERVERSRC)/fb -I$(SERVERSRC)/mi -I$(SERVERSRC)/include \
@@ -82,6 +80,9 @@
 NormalLibraryObjectRule()
 NormalLibraryTarget(XQuartz,$(OBJS))
 
+SpecialCObjectRule(quartzStartup,$(ICONFIGFILES),$(DEFINES) -DQUARTZ_LOAD_DYNAMIC)
+AllTarget(quartzStartup.o)
+
 AllTarget(XDarwinStartup)
 NormalProgramTarget(XDarwinStartup,XDarwinStartup.o, \
 	NullParameter,NullParameter, \
--- programs/Xserver/hw/darwin/quartz/quartzStartup.c	22 Sep 2004 23:52:39 -0000	1.3
+++ programs/Xserver/hw/darwin/quartz/quartzStartup.c	23 Sep 2004 00:05:31 -0000
@@ -44,6 +44,8 @@
 char **envpGlobal;      // argcGlobal and argvGlobal
                         // are from dix/globals.c
 
+#ifdef QUARTZ_LOAD_DYNAMIC
+
 // GLX bundle function pointers
 typedef void (*GlxExtensionInitPtr)(void); 
 static GlxExtensionInitPtr GlxExtensionInit = NULL;
@@ -53,6 +55,21 @@
 
 typedef Bool (*QuartzModeBundleInitPtr)(void);
 
+#else
+
+void GlxExtensionInit(void);
+void GlxWrapInitVisuals(miInitVisualsProcPtr *procPtr);
+
+static void
+server_thread (void *arg)
+{
+    extern int main (int argc, char **argv, char **envp);
+
+    exit (main (argcGlobal, argvGlobal, envpGlobal));
+}
+
+#endif
+
 
 /*
  * DarwinHandleGUI
@@ -107,11 +124,29 @@
         }
     }
 
+#ifdef QUARTZ_LOAD_DYNAMIC
     main_exit = NSApplicationMain(argc, argv);
+#else
+    /* Initially I ran the X server on the main thread, and received
+       events on the second thread. But now we may be using Carbon,
+       that needs to run on the main thread. (Otherwise, when it's
+       prebound, it will initialize itself on the wrong thread)
+
+       grr.. but doing that means that if the X thread gets scheduled
+       before the main thread when we're _not_ prebound, things fail,
+       so initialize by hand. */
+    extern void _InitHLTB(void);
+
+    _InitHLTB();
+
+    X11ControllerMain(argc, argv, server_thread, NULL);
+#endif
     exit(main_exit);
 }
 
 
+#ifdef QUARTZ_LOAD_DYNAMIC
+
 /*
  * QuartzLoadDisplayBundle
  *  Try to load the appropriate bundle containing the back end display code.
@@ -229,6 +264,16 @@
     CFRelease(bundleURL);
 }
 
+#else   /* !QUARTZ_LOAD_DYNAMIC */
+
+Bool QuartzLoadDisplayBundle(
+    const char *dpyBundleName)
+{
+    return TRUE;
+}
+
+#endif  /* QUARTZ_LOAD_DYNAMIC */
+
 
 /*
  * DarwinGlxExtensionInit
@@ -236,8 +281,10 @@
  */
 void DarwinGlxExtensionInit(void)
 {
+#ifdef QUARTZ_LOAD_DYNAMIC
     if (!GlxExtensionInit)
         LoadGlxBundle();
+#endif
 
     GlxExtensionInit();
 }
@@ -249,8 +296,10 @@
 void DarwinGlxWrapInitVisuals(
     miInitVisualsProcPtr *procPtr)
 {
+#ifdef QUARTZ_LOAD_DYNAMIC
     if (!GlxWrapInitVisuals)
         LoadGlxBundle();
+#endif
 
     GlxWrapInitVisuals(procPtr);
 }
