diff -uNbr qt-x11-free-3.0.4/Makefile qt-x11-free-3.0.4-new/Makefile
--- qt-x11-free-3.0.4/Makefile	Sun Mar 17 23:58:44 2002
+++ qt-x11-free-3.0.4-new/Makefile	Sat Jun  8 02:31:24 2002
@@ -11,11 +11,9 @@
 install: FORCE
 	@$(MAKE) qt.install
 
-all: symlinks src-qmake src-moc sub-src sub-tools sub-tutorial sub-examples
+all: symlinks src-qmake src-moc sub-src sub-tools
 	@echo
 	@echo "The Qt library is now built in ./lib"
-	@echo "The Qt examples are built in the directories in ./examples"
-	@echo "The Qt tutorials are built in the directories in ./tutorial"
 	@echo
 	@echo 'Note: be sure to set $$QTDIR to point to here or to wherever'
 	@echo '      you move these directories.'
diff -uNbr qt-x11-free-3.0.4/configure qt-x11-free-3.0.4-new/configure
--- qt-x11-free-3.0.4/configure	Mon Apr 22 16:03:46 2002
+++ qt-x11-free-3.0.4-new/configure	Sat Jun  8 02:31:24 2002
@@ -943,7 +943,7 @@
 
     case "$UNAME_SYSTEM:$UNAME_RELEASE" in
      Darwin:*)
-	PLATFORM=macx-g++
+	PLATFORM=darwin-g++
 	# PLATFORM=macx-pbuilder
 	PLATFORM_NOTES="
 	    - Also available for Mac OS X: macx-pbuilder
diff -uNbr qt-x11-free-3.0.4/examples/demo/main.cpp qt-x11-free-3.0.4-new/examples/demo/main.cpp
--- qt-x11-free-3.0.4/examples/demo/main.cpp	Fri Apr 26 03:47:44 2002
+++ qt-x11-free-3.0.4-new/examples/demo/main.cpp	Sat Jun  8 02:31:24 2002
@@ -50,7 +50,7 @@
 #include "sql/sqlex.h"
 #endif
 
-#ifdef Q_OS_MACX
+#if defined(Q_OS_MACX)
 #include <stdlib.h>
 #include <qdir.h>
 #endif
@@ -117,7 +117,7 @@
 {
     QString category;
     QApplication a( argc, argv );
-#ifdef Q_OS_MACX
+#if defined(Q_OS_MACX)
     setenv("QTDIR", QDir::cleanDirPath(QDir::currentDirPath() + QDir::separator() + ".." + QDir::separator() + ".."), 0);
 #endif
     for(int i = 1; i < argc-1; i++) {
diff -uNbr qt-x11-free-3.0.4/include/qconfig.h qt-x11-free-3.0.4-new/include/qconfig.h
--- qt-x11-free-3.0.4/include/qconfig.h	Wed Dec 31 19:00:00 1969
+++ qt-x11-free-3.0.4-new/include/qconfig.h	Sat Jun  8 02:31:24 2002
@@ -0,0 +1 @@
+// All features enabled while configuring
diff -uNbr qt-x11-free-3.0.4/include/qglobal.h qt-x11-free-3.0.4-new/include/qglobal.h
--- qt-x11-free-3.0.4/include/qglobal.h	Fri Apr 26 03:48:32 2002
+++ qt-x11-free-3.0.4-new/include/qglobal.h	Sat Jun  8 02:31:24 2002
@@ -77,7 +77,8 @@
 */
 
 #if defined(__APPLE__) && defined(__GNUC__)
-#  define Q_OS_MACX
+#  define Q_OS_FREEBSD
+#  define Q_OS_DARWIN
 #elif defined(__MACOSX__)
 #  define Q_OS_MACX
 #elif defined(macintosh)
@@ -720,7 +721,7 @@
 #  if !defined(QT_NO_COMPAT)
 // source compatibility with Qt 2.x
 #    if !defined(NO_DEBUG) && !defined(DEBUG)
-#      if !defined(Q_OS_MACX)			// clash with MacOS X headers
+#      if !defined(Q_OS_MACX) && !defined(Q_OS_DARWIN)	// clash with MacOS X headers
 #        define DEBUG
 #      endif
 #    endif
diff -uNbr qt-x11-free-3.0.4/include/qmodules.h qt-x11-free-3.0.4-new/include/qmodules.h
--- qt-x11-free-3.0.4/include/qmodules.h	Wed Dec 31 19:00:00 1969
+++ qt-x11-free-3.0.4-new/include/qmodules.h	Sat Jun  8 02:31:24 2002
@@ -0,0 +1 @@
+// All modules enabled while configuring
diff -uNbr qt-x11-free-3.0.4/mkspecs/darwin-g++/qmake.conf qt-x11-free-3.0.4-new/mkspecs/darwin-g++/qmake.conf
--- qt-x11-free-3.0.4/mkspecs/darwin-g++/qmake.conf	Fri Apr 26 03:47:59 2002
+++ qt-x11-free-3.0.4-new/mkspecs/darwin-g++/qmake.conf	Mon Jun 10 10:35:12 2002
@@ -13,7 +13,7 @@
 QMAKE_LEXFLAGS		= 
 QMAKE_YACC		= yacc
 QMAKE_YACCFLAGS		= -d
-QMAKE_CFLAGS		= -pipe
+QMAKE_CFLAGS		= -fPIC -fno-common -pipe -Ddlsym=dlsym_auto_underscore -O2
 QMAKE_CFLAGS_DEPS	= -M
 QMAKE_CFLAGS_WARN_ON	= -Wall -W
 QMAKE_CFLAGS_WARN_OFF	= -w
@@ -21,6 +21,7 @@
 QMAKE_CFLAGS_DEBUG	= -g
 QMAKE_CFLAGS_SHLIB	= -fPIC
 QMAKE_EXTENSION_SHLIB	= dylib
+QMAKE_DARWIN_SHLIB	= 1
 QMAKE_CFLAGS_YACC	= -Wno-unused -Wno-parentheses
 QMAKE_CFLAGS_THREAD	=
 
@@ -35,8 +36,8 @@
 QMAKE_CXXFLAGS_YACC	= $$QMAKE_CFLAGS_YACC
 QMAKE_CXXFLAGS_THREAD	=
 
-QMAKE_INCDIR		= /usr/local/include
-QMAKE_LIBDIR		=
+QMAKE_INCDIR		= @PREFIX@/include
+QMAKE_LIBDIR		= @PREFIX@/lib
 QMAKE_INCDIR_X11	= /usr/X11R6/include
 QMAKE_LIBDIR_X11	= /usr/X11R6/lib
 QMAKE_INCDIR_QT		= $(QTDIR)/include
@@ -49,12 +50,13 @@
 QMAKE_LFLAGS		=
 QMAKE_LFLAGS_RELEASE	=
 QMAKE_LFLAGS_DEBUG	=
-QMAKE_LFLAGS_SHLIB	= -dynamiclib
+QMAKE_LFLAGS_SHLIB	= -dynamiclib -install_name $$QMAKE_LIBDIR/$(TARGET)
 QMAKE_LFLAGS_PLUGIN	= -bundle
+QMAKE_LFLAGS_PREBIND	= -prebind -seg1addr 0x90000000
 QMAKE_LFLAGS_THREAD	= 
 QMAKE_RPATH		= 
 
-QMAKE_LIBS_DYNLOAD	=
+QMAKE_LIBS_DYNLOAD	= -ldl
 QMAKE_LIBS_X11		= -lXext -lX11 -lm
 QMAKE_LIBS_X11SM	= -lICE -lSM
 QMAKE_LIBS_QT		= -lqt
diff -uNbr qt-x11-free-3.0.4/mkspecs/darwin-g++/qplatformdefs.h qt-x11-free-3.0.4-new/mkspecs/darwin-g++/qplatformdefs.h
--- qt-x11-free-3.0.4/mkspecs/darwin-g++/qplatformdefs.h	Wed Mar 27 18:37:58 2002
+++ qt-x11-free-3.0.4-new/mkspecs/darwin-g++/qplatformdefs.h	Sat Jun  8 02:31:24 2002
@@ -41,7 +41,7 @@
 #include <arpa/nameser.h>
 #include <resolv.h>
 
-
+#define QT_AOUT_UNDERSCORE
 #define QT_STATBUF		struct stat
 #define QT_STATBUF4TSTAT	struct stat
 #define QT_STAT			::stat
diff -uNbr qt-x11-free-3.0.4/qmake/generators/unix/unixmake.cpp qt-x11-free-3.0.4-new/qmake/generators/unix/unixmake.cpp
--- qt-x11-free-3.0.4/qmake/generators/unix/unixmake.cpp	Fri Apr 26 03:48:02 2002
+++ qt-x11-free-3.0.4-new/qmake/generators/unix/unixmake.cpp	Sat Jun  8 02:31:24 2002
@@ -64,7 +64,7 @@
 	if(project->isEmpty("MAKEFILE"))
 	    project->variables()["MAKEFILE"].append("Makefile");
 	if(project->isEmpty("QMAKE"))
-	    project->variables()["QMAKE"].append("qmake");
+	    project->variables()["QMAKE"].append("$(QTDIR)/bin/qmake");
 	if(project->variables()["QMAKE_INTERNAL_QMAKE_DEPS"].findIndex("qmake_all") == -1)
 	    project->variables()["QMAKE_INTERNAL_QMAKE_DEPS"].append("qmake_all");
 	return; /* subdirs is done */
@@ -113,10 +113,7 @@
 	    !project->variables()["QMAKE_LIB_FLAG"].isEmpty() &&
 	    project->isActiveConfig("dll"))
 	project->variables()["QMAKE_LFLAGS"] += project->variables()["QMAKE_LFLAGS_PREBIND"];
-    if(!project->isEmpty("QMAKE_INCDIR"))
-	project->variables()["INCLUDEPATH"] += project->variables()["QMAKE_INCDIR"];
-    if(!project->isEmpty("QMAKE_LIBDIR"))
-	project->variables()["QMAKE_LIBDIR_FLAGS"] += varGlue( "QMAKE_LIBDIR", " -L", " -L", "" );
+
     if ( extern_libs && (project->isActiveConfig("qt") || project->isActiveConfig("opengl")) ) {
 	if(configs.findIndex("x11lib") == -1)
 	    configs.append("x11lib");
@@ -152,6 +149,10 @@
 		project->variables()["QMAKE_LIBS"] += project->variables()["QMAKE_LIBS_QT"];
 	}
     }
+    if(!project->isEmpty("QMAKE_INCDIR"))
+       project->variables()["INCLUDEPATH"] += project->variables()["QMAKE_INCDIR"];
+    if(!project->isEmpty("QMAKE_LIBDIR"))
+       project->variables()["QMAKE_LIBDIR_FLAGS"].append("-L" + project->first("QMAKE_LIBDIR"));
     if ( project->isActiveConfig("thread") ) {
 	if(project->isActiveConfig("qt"))
 	    project->variables()[is_qt ? "PRL_EXPORT_DEFINES" : "DEFINES"].append("QT_THREAD_SUPPORT");
diff -uNbr qt-x11-free-3.0.4/qmake/generators/unix/unixmake2.cpp qt-x11-free-3.0.4-new/qmake/generators/unix/unixmake2.cpp
--- qt-x11-free-3.0.4/qmake/generators/unix/unixmake2.cpp	Fri Apr 26 03:48:02 2002
+++ qt-x11-free-3.0.4-new/qmake/generators/unix/unixmake2.cpp	Sat Jun  8 02:31:24 2002
@@ -857,6 +857,30 @@
 							    project->first("VER_PAT"));
 	    }
 	    project->variables()["TARGET"] = project->variables()["TARGET_x.y.z"];
+
+	} else if ( !project->variables()["QMAKE_DARWIN_SHLIB"].isEmpty() ) {
+            project->variables()["TARGET_"].append("lib" + project->first("TARGET") + "." +
+                                                   project->first("QMAKE_EXTENSION_SHLIB"));
+            project->variables()["TARGET_x"].append("lib" + project->first("TARGET")
+                                                    + "." + project->first("VER_MAJ")
+                                                    + "." + project->first("QMAKE_EXTENSION_SHLIB"));
+            project->variables()["TARGET_x.y"].append("lib" + project->first("TARGET")
+                                                      + "." + project->first("VER_MAJ")
+                                                      + "." + project->first("VER_MIN")
+                                                      + "." + project->first("QMAKE_EXTENSION_SHLIB"));
+            project->variables()["TARGET_x.y.z"].append("lib" + project->first("TARGET")
+                                                        + "." + project->first("VER_MAJ")
+                                                        + "." + project->first("VER_MIN")
+                                                        + "." + project->first("VER_PAT")
+                                                        + "." + project->variables()["QMAKE_EXTENSION_SHLIB"].first());
+	    project->variables()["TARGET"] = project->variables()["TARGET_x.y.z"];
+	    project->variables()["QMAKE_LFLAGS_SHLIB"].prepend("-compatibility_version " +
+						project->first("VER_MAJ") + "." +
+						project->first("VER_MIN") +
+						" -current_version " +
+						project->first("VER_MAJ") + "." +
+						project->first("VER_MIN") + "." +
+						project->first("VER_PAT") + " ");
 	} else {
 	    project->variables()["TARGET_"].append("lib" + project->first("TARGET") + "." +
 						   project->first("QMAKE_EXTENSION_SHLIB"));
diff -uNbr qt-x11-free-3.0.4/qt.csh qt-x11-free-3.0.4-new/qt.csh
--- qt-x11-free-3.0.4/qt.csh	Wed Dec 31 19:00:00 1969
+++ qt-x11-free-3.0.4-new/qt.csh	Sat Jun  8 02:31:24 2002
@@ -0,0 +1,3 @@
+# qt.csh
+
+setenv QTDIR @PREFIX@
diff -uNbr qt-x11-free-3.0.4/qt.sh qt-x11-free-3.0.4-new/qt.sh
--- qt-x11-free-3.0.4/qt.sh	Wed Dec 31 19:00:00 1969
+++ qt-x11-free-3.0.4-new/qt.sh	Sat Jun  8 02:31:24 2002
@@ -0,0 +1,4 @@
+# qt.sh
+
+QTDIR=@PREFIX@
+export QTDIR
diff -uNbr qt-x11-free-3.0.4/src/kernel/qapplication_x11.cpp qt-x11-free-3.0.4-new/src/kernel/qapplication_x11.cpp
--- qt-x11-free-3.0.4/src/kernel/qapplication_x11.cpp	Fri Apr 26 03:48:13 2002
+++ qt-x11-free-3.0.4-new/src/kernel/qapplication_x11.cpp	Sat Jun  8 02:31:24 2002
@@ -3318,8 +3318,8 @@
 			groupLeader = groupLeader->parentWidget();
 		    if ( !groupLeader ) {
 			amw->raise(); //  help broken window managers
-			XSetInputFocus( appDpy, amw->winId(),
-					RevertToParent, qt_x_time );
+                        amw->setActiveWindow();
+			//XSetInputFocus( appDpy, amw->winId(), RevertToParent, qt_x_time );
 		    }
 		}
 	    } else if ( a == qt_net_wm_context_help ) {
@@ -4046,9 +4046,9 @@
 	case MotionNotify:
 	case XKeyPress:
 	case XKeyRelease:
-	case XFocusIn:
-	case XFocusOut:
-	case ClientMessage:
+	//case XFocusIn:
+	//case XFocusOut:
+	//case ClientMessage:
 	case EnterNotify:
 	case LeaveNotify:
 	    block_event	 = TRUE;
diff -uNbr qt-x11-free-3.0.4/src/kernel/qprocess_unix.cpp qt-x11-free-3.0.4-new/src/kernel/qprocess_unix.cpp
--- qt-x11-free-3.0.4/src/kernel/qprocess_unix.cpp	Fri Apr 26 03:48:22 2002
+++ qt-x11-free-3.0.4-new/src/kernel/qprocess_unix.cpp	Sat Jun  8 02:31:24 2002
@@ -771,7 +771,7 @@
 		    QStringList pathList = QStringList::split( ':', getenv( "PATH" ) );
 		    for (QStringList::Iterator it = pathList.begin(); it != pathList.end(); ++it ) {
 			QString dir = *it;
-#ifdef Q_OS_MACX
+#if defined(Q_OS_MACX) || defined(Q_OS_DARWIN)
 			if(QFile::exists(dir + "/" + command + ".app")) //look in a bundle
 			    dir += "/" + command + ".app/Contents/MacOS";
 #endif
diff -uNbr qt-x11-free-3.0.4/src/tools/qdir_unix.cpp qt-x11-free-3.0.4-new/src/tools/qdir_unix.cpp
--- qt-x11-free-3.0.4/src/tools/qdir_unix.cpp	Fri Apr 26 03:48:31 2002
+++ qt-x11-free-3.0.4-new/src/tools/qdir_unix.cpp	Sat Jun  8 02:31:24 2002
@@ -82,7 +82,7 @@
 
 bool QDir::mkdir( const QString &dirName, bool acceptAbsPath ) const
 {
-#ifdef Q_OS_MACX  // Mac X doesn't support trailing /'s
+#if defined(Q_OS_MACX) || defined(Q_OS_DARWIN)  // Mac X doesn't support trailing /'s
     QString name = dirName;
     if (dirName[dirName.length() - 1] == "/")
 	name = dirName.left( dirName.length() - 1 );
diff -uNbr qt-x11-free-3.0.4/src/tools/qglobal.h qt-x11-free-3.0.4-new/src/tools/qglobal.h
--- qt-x11-free-3.0.4/src/tools/qglobal.h	Fri Apr 26 03:48:32 2002
+++ qt-x11-free-3.0.4-new/src/tools/qglobal.h	Sat Jun  8 02:31:24 2002
@@ -77,7 +77,7 @@
 */
 
 #if defined(__APPLE__) && defined(__GNUC__)
-#  define Q_OS_MACX
+#  define Q_OS_FREEBSD
 #elif defined(__MACOSX__)
 #  define Q_OS_MACX
 #elif defined(macintosh)
diff -uNbr qt-x11-free-3.0.4/src/tools/qgpluginmanager.cpp qt-x11-free-3.0.4-new/src/tools/qgpluginmanager.cpp
--- qt-x11-free-3.0.4/src/tools/qgpluginmanager.cpp	Fri Apr 26 03:48:32 2002
+++ qt-x11-free-3.0.4-new/src/tools/qgpluginmanager.cpp	Sat Jun  8 02:31:24 2002
@@ -378,6 +378,21 @@
 	libList.append( lib );
 
     }
+
+#if defined(Q_OS_DARWIN)
+    /* do it again for .so's on Darwin */
+    filter = "so";
+    QStringList plugins = QDir(path).entryList( "*." + filter );
+    for ( QStringList::Iterator p = plugins.begin(); p != plugins.end(); ++p ) {
+	QString lib = path + "/" + *p;
+	if ( libList.contains( lib ) )
+	    continue;
+
+	libList.append( lib );
+
+    }
+#endif
+
 }
 
 const QLibrary* QGPluginManager::library( const QString& feature ) const
diff -uNbr qt-x11-free-3.0.4/src/tools/qiodevice.cpp qt-x11-free-3.0.4-new/src/tools/qiodevice.cpp
--- qt-x11-free-3.0.4/src/tools/qiodevice.cpp	Fri Apr 26 03:48:32 2002
+++ qt-x11-free-3.0.4-new/src/tools/qiodevice.cpp	Sat Jun  8 02:31:24 2002
@@ -585,7 +585,7 @@
 	return ba;
     } else {
 	// read until we reach the end
-	const int blocksize = 512;
+	int blocksize = 512;
 	int nread = 0;
 	QByteArray ba;
 	while ( !atEnd() ) {
@@ -594,6 +594,7 @@
 	    if ( r < 0 )
 		return QByteArray();
 	    nread += r;
+	    blocksize *= 2;
 	}
 	ba.resize( nread );
 	return ba;
diff -uNbr qt-x11-free-3.0.4/src/tools/qlibrary.cpp qt-x11-free-3.0.4-new/src/tools/qlibrary.cpp
--- qt-x11-free-3.0.4/src/tools/qlibrary.cpp	Fri Apr 26 03:48:33 2002
+++ qt-x11-free-3.0.4-new/src/tools/qlibrary.cpp	Sat Jun  8 02:31:24 2002
@@ -324,10 +324,12 @@
 #if defined(Q_WS_WIN)
     if ( filename.find( ".dll", 0, FALSE ) == -1 )
 	filename += ".dll";
-#elif defined(Q_OS_MACX)
+#endif
+#if defined(Q_OS_MACX)
     if ( filename.find( ".dylib" ) == -1 )
 	filename += ".dylib";
-#else
+#endif
+#if !defined(Q_WS_WIN) && !defined(Q_OS_MACX)
     if ( filename.find( ".so" ) == -1 ) {
 	const int x = filename.findRev( "/" );
 	if ( x != -1 ) {
diff -uNbr qt-x11-free-3.0.4/src/tools/qmutex_unix.cpp qt-x11-free-3.0.4-new/src/tools/qmutex_unix.cpp
--- qt-x11-free-3.0.4/src/tools/qmutex_unix.cpp	Fri Apr 26 03:48:33 2002
+++ qt-x11-free-3.0.4-new/src/tools/qmutex_unix.cpp	Sat Jun  8 02:31:24 2002
@@ -76,7 +76,7 @@
 
 // mutex types
 #  if ((defined(PTHREAD_MUTEX_RECURSIVE) && defined(PTHREAD_MUTEX_DEFAULT)) || \
-        defined(Q_OS_FREEBSD)) && !defined(Q_OS_UNIXWARE7)
+        defined(Q_OS_FREEBSD)) && !defined(Q_OS_UNIXWARE7) && !defined(__APPLE__)
     // POSIX 1003.1c-1995 - We love this OS
 #    define Q_MUTEX_SET_TYPE(a, b) pthread_mutexattr_settype((a), (b))
 #    if defined(QT_CHECK_RANGE)
diff -uNbr qt-x11-free-3.0.4/src/tools/qregexp.cpp qt-x11-free-3.0.4-new/src/tools/qregexp.cpp
--- qt-x11-free-3.0.4/src/tools/qregexp.cpp	Fri Apr 26 03:48:33 2002
+++ qt-x11-free-3.0.4-new/src/tools/qregexp.cpp	Sat Jun  8 02:31:24 2002
@@ -2111,11 +2111,7 @@
 	    mmInNextStack[mmNextStack[j]] = -1;
 
 	// avoid needless iteration that confuses mmMatchedLen
-	if ( nnext == 1 && mmNextStack[0] == FinalState
-#ifndef QT_NO_REGEXP_BACKREF
-	     && mmSleeping.isEmpty()
-#endif
-	     )
+	if ( nnext == 1 && mmNextStack[0] == FinalState )
 	    stop = TRUE;
 
 	qSwap( mmCurStack, mmNextStack );
diff -uNbr qt-x11-free-3.0.4/src/tools/qtextstream.cpp qt-x11-free-3.0.4-new/src/tools/qtextstream.cpp
--- qt-x11-free-3.0.4/src/tools/qtextstream.cpp	Fri Apr 26 03:48:34 2002
+++ qt-x11-free-3.0.4-new/src/tools/qtextstream.cpp	Sat Jun  8 02:31:24 2002
@@ -456,10 +456,7 @@
 	setStatus( IO_ReadError );
 	return -1;
     }
-    QChar *ch = (QChar*)((ushort*)s->unicode() + ioIndex/2);
-    int retval = (ioIndex&01) ? ch->row() : ch->cell();
-    ioIndex++;
-    return retval;
+    return (int) *( (const char *) s->unicode() + ioIndex++ );
 }
 
 int QStringBuffer::putch( int ch )
diff -uNbr qt-x11-free-3.0.4/src/widgets/qmenudata.cpp qt-x11-free-3.0.4-new/src/widgets/qmenudata.cpp
--- qt-x11-free-3.0.4/src/widgets/qmenudata.cpp	Fri Apr 26 03:48:37 2002
+++ qt-x11-free-3.0.4-new/src/widgets/qmenudata.cpp	Sat Jun  8 02:31:24 2002
@@ -251,9 +251,9 @@
 			  QPopupMenu *popup, const QIconSet* iconset, int id, int index,
 			  QWidget* widget, QCustomMenuItem* custom )
 {
-    if ( index < 0 ) {	// append, but not if the rightmost item is an mdi separator
+    if ( index < 0 ) {	// append, but not if the rightmost item is an mdi separator in the menubar
 	index = mitems->count();
-	if ( mitems->last() && mitems->last()->widget() && mitems->last()->isSeparator() )
+	if ( isMenuBar && mitems->last() && mitems->last()->widget() && mitems->last()->isSeparator() )
 	    index--;
     } else if ( index > (int) mitems->count() ) { // append
 	index = mitems->count();
diff -uNbr qt-x11-free-3.0.4/src/widgets/qtextedit.cpp qt-x11-free-3.0.4-new/src/widgets/qtextedit.cpp
--- qt-x11-free-3.0.4/src/widgets/qtextedit.cpp	Fri Apr 26 03:48:39 2002
+++ qt-x11-free-3.0.4-new/src/widgets/qtextedit.cpp	Sat Jun  8 02:31:24 2002
@@ -1556,8 +1556,6 @@
 	doResize();
 }
 
-static bool blockEnsureCursorVisible = FALSE;
-
 /*!
   Ensures that the cursor is visible by scrolling the text edit if
   necessary.
@@ -1567,8 +1565,6 @@
 
 void QTextEdit::ensureCursorVisible()
 {
-    if ( blockEnsureCursorVisible )
-	return;
     if ( !isVisible() ) {
 	d->ensureCursorVisibleInShowEvent = TRUE;
 	return;
@@ -3651,35 +3647,37 @@
 	else
 	    f = PlainText;
     }
-    if ( f == PlainText ) {
+
+    drawCursor( FALSE );
 	QTextCursor oldc( *cursor );
 	ensureFormatted( doc->lastParag() );
 	bool scrollToEnd = contentsY() >= contentsHeight() - visibleHeight() -
-			   ( horizontalScrollBar()->isVisible() ? horizontalScrollBar()->height() : 0 );
-	if ( !scrollToEnd )
-	    blockEnsureCursorVisible = TRUE;
+                          ( horizontalScrollBar()->isVisible() ?
+                            horizontalScrollBar()->height() : 0 );
 	cursor->gotoEnd();
 	if ( cursor->index() > 0 )
 	    cursor->splitAndInsertEmptyParag();
 	QTextCursor oldCursor2 = *cursor;
+
+    if ( f == Qt::PlainText ) {
   	cursor->insert( text, TRUE );
-	if ( doc->useFormatCollection() && currentFormat != cursor->parag()->at( cursor->index() )->format() ) {
+       if ( doc->useFormatCollection() &&
+            currentFormat != cursor->parag()->at( cursor->index() )->format() ) {
 	    doc->setSelectionStart( QTextDocument::Temp, &oldCursor2 );
 	    doc->setSelectionEnd( QTextDocument::Temp, cursor );
 	    doc->setFormat( QTextDocument::Temp, currentFormat, QTextFormat::Format );
 	    doc->removeSelection( QTextDocument::Temp );
 	}
+    } else {
+	doc->setRichTextInternal( text );
+    }
 	formatMore();
 	repaintChanged();
+    if ( scrollToEnd )
 	ensureCursorVisible();
-	drawCursor( TRUE );
  	*cursor = oldc;
-	if ( !scrollToEnd )
-	    blockEnsureCursorVisible = FALSE;
-    } else if ( f == RichText ) {
-	doc->setRichTextInternal( text );
-	repaintChanged();
-    }
+    if ( !isReadOnly() )
+       cursorVisible = TRUE;
     setModified();
     emit textChanged();
 }
diff -uNbr qt-x11-free-3.0.4/src/widgets/qtoolbar.cpp qt-x11-free-3.0.4-new/src/widgets/qtoolbar.cpp
--- qt-x11-free-3.0.4/src/widgets/qtoolbar.cpp	Fri Apr 26 03:48:39 2002
+++ qt-x11-free-3.0.4-new/src/widgets/qtoolbar.cpp	Sat Jun  8 02:31:24 2002
@@ -617,10 +617,14 @@
 	    hide = FALSE;
 	    QPoint p = w->parentWidget()->mapTo( this, w->geometry().bottomRight() );
 	    if ( orientation() == Horizontal ) {
-		if ( p.x() > e->size().width()-d->extension->width()/2 )
+		if ( p.x() > ( doHide ?
+		               e->size().width()-d->extension->width()/2 :
+		               e->size().width() ) )
 		    hide = TRUE;
 	    } else {
-		if ( p.y() > e->size().height()-d->extension->height()/2 )
+		if ( p.y() > ( doHide ?
+		               e->size().height()-d->extension->height()/2 :
+		               e->size().height() ) )
 		    hide = TRUE;
 	    }
 	    if ( hide ) {
diff -uNbr qt-x11-free-3.0.4/tools/assistant/main.cpp qt-x11-free-3.0.4-new/tools/assistant/main.cpp
--- qt-x11-free-3.0.4/tools/assistant/main.cpp	Thu Apr 18 09:53:46 2002
+++ qt-x11-free-3.0.4-new/tools/assistant/main.cpp	Sat Jun  8 02:31:24 2002
@@ -200,7 +200,7 @@
     mw->raise();
 }
 
-#ifdef Q_OS_MACX
+#if defined(Q_OS_MACX) || defined(Q_OS_DARWIN)
 #include <stdlib.h>
 #include <qdir.h>
 #endif
@@ -210,7 +210,7 @@
     QApplication a( argc, argv );
     StdInParser *commandInput = 0;
 
-#ifdef Q_OS_MACX
+#if defined(Q_OS_MACX) || defined (Q_OS_DARWIN)
     QString qdir = QDir::cleanDirPath(QDir::currentDirPath() + QDir::separator() +
 				      ".." + QDir::separator());
     setenv("QTDIR", qdir.latin1(), 0);
diff -uNbr qt-x11-free-3.0.4/tools/designer/designer/designerapp.h qt-x11-free-3.0.4-new/tools/designer/designer/designerapp.h
--- qt-x11-free-3.0.4/tools/designer/designer/designerapp.h	Mon Feb  4 02:25:47 2002
+++ qt-x11-free-3.0.4-new/tools/designer/designer/designerapp.h	Sat Jun  8 02:31:24 2002
@@ -26,10 +26,9 @@
 class QLabel;
 
 #if defined(HAVE_KDE)
-#include <kapp.h>
+#include <kapplication.h>
 class DesignerApplication : public KApplication
 #else
-#include <qapplication.h>
 class DesignerApplication : public QApplication
 #endif
 {
diff -uNbr qt-x11-free-3.0.4/tools/designer/designer/main.cpp qt-x11-free-3.0.4-new/tools/designer/designer/main.cpp
--- qt-x11-free-3.0.4/tools/designer/designer/main.cpp	Fri Oct 12 06:18:27 2001
+++ qt-x11-free-3.0.4-new/tools/designer/designer/main.cpp	Sat Jun  8 02:31:24 2002
@@ -128,7 +128,7 @@
 }
 #endif
 
-#ifdef Q_OS_MACX
+#if defined(Q_OS_MACX) || defined(Q_OS_DARWIN)
 #include <stdlib.h>
 #include <qdir.h>
 #endif
@@ -149,7 +149,7 @@
     DesignerApplication a( argc, argv );
 #endif
 
-#ifdef Q_OS_MACX
+#if defined(Q_OS_MACX) || defined(Q_OS_DARWIN)
     QString qdir = QDir::cleanDirPath(QDir::currentDirPath() + QDir::separator() + "..");
     setenv("QTDIR", qdir, 0);
     setenv("PATH",  qdir + QDir::separator() + "bin" + ":" + getenv("PATH"), 0);
diff -uNbr qt-x11-free-3.0.4/tools/designer/designer/mainwindow.cpp qt-x11-free-3.0.4-new/tools/designer/designer/mainwindow.cpp
--- qt-x11-free-3.0.4/tools/designer/designer/mainwindow.cpp	Thu Apr 25 08:18:30 2002
+++ qt-x11-free-3.0.4-new/tools/designer/designer/mainwindow.cpp	Sat Jun  8 02:31:24 2002
@@ -100,7 +100,7 @@
 
 QString assistantPath()
 {
-#ifdef Q_OS_MACX
+#if defined(Q_OS_MACX)
     return QDir::cleanDirPath(QString(getenv("QTDIR")) + QDir::separator() +
 			      "bin" + QDir::separator() +
 			      "assistant.app/Contents/MacOS/assistant");
diff -uNbr qt-x11-free-3.0.4/tools/linguist/linguist/main.cpp qt-x11-free-3.0.4-new/tools/linguist/linguist/main.cpp
--- qt-x11-free-3.0.4/tools/linguist/linguist/main.cpp	Fri Nov 16 08:43:38 2001
+++ qt-x11-free-3.0.4-new/tools/linguist/linguist/main.cpp	Sat Jun  8 02:31:24 2002
@@ -28,7 +28,7 @@
 extern void qt_wait_for_window_manager( QWidget * );
 #endif
 
-#ifdef Q_OS_MACX
+#if defined(Q_OS_MACX) || defined(Q_OS_DARWIN)
 #include <stdlib.h>
 #include <qdir.h>
 #endif
@@ -38,7 +38,7 @@
     QApplication app( argc, argv );
     QApplication::setOverrideCursor( Qt::waitCursor );
 
-#ifdef Q_OS_MACX
+#if defined(Q_OS_MACX) || defined(Q_OS_DARWIN)
     QString qdir = QDir::cleanDirPath(QDir::currentDirPath() + QDir::separator() +
 				      ".." + QDir::separator());
     setenv("QTDIR", qdir.latin1(), 0);
